<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CursorImpl.java</title>
    <link rel="stylesheet" type="text/css" href="../../css/style.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,700" rel="stylesheet">
</head>
<body>

<div class="container">
    <div id="code_area" class="container_0">
<div>1&emsp;&emsp;/*-</div>
<div>2&emsp;&emsp;&nbsp; * Copyright (C) 2002, 2017, Oracle and/or its affiliates. All rights reserved.</div>
<div>3&emsp;&emsp;&nbsp; *</div>
<div>4&emsp;&emsp;&nbsp; * This file was distributed by Oracle as part of a version of Oracle Berkeley</div>
<div>5&emsp;&emsp;&nbsp; * DB Java Edition made available at:</div>
<div>6&emsp;&emsp;&nbsp; *</div>
<div>7&emsp;&emsp;&nbsp; * http://www.oracle.com/technetwork/database/database-technologies/berkeleydb/downloads/index.html</div>
<div>8&emsp;&emsp;&nbsp; *</div>
<div>9&emsp;&emsp;&nbsp; * Please see the LICENSE file included in the top-level directory of the</div>
<div>10&emsp;&emsp;&nbsp; * appropriate version of Oracle Berkeley DB Java Edition for a copy of the</div>
<div>11&emsp;&emsp;&nbsp; * license and additional information.</div>
<div>12&emsp;&emsp;&nbsp; */</div>
<div>13&emsp;&emsp;</div>
<div>14&emsp;&emsp;package berkeley.com.sleepycat.je.dbi;</div>
<div>15&emsp;&emsp;</div>
<div>16&emsp;&emsp;import java.util.ArrayList;</div>
<div>17&emsp;&emsp;import java.util.Arrays;</div>
<div>18&emsp;&emsp;import java.util.Comparator;</div>
<div>19&emsp;&emsp;import java.util.List;</div>
<div>20&emsp;&emsp;import java.util.Set;</div>
<div>21&emsp;&emsp;import java.util.logging.Level;</div>
<div>22&emsp;&emsp;</div>
<div>23&emsp;&emsp;import berkeley.com.sleepycat.je.CacheMode;</div>
<div>24&emsp;&emsp;import berkeley.com.sleepycat.je.Cursor;</div>
<div>25&emsp;&emsp;import berkeley.com.sleepycat.je.DatabaseEntry;</div>
<div>26&emsp;&emsp;import berkeley.com.sleepycat.je.DatabaseException;</div>
<div>27&emsp;&emsp;import berkeley.com.sleepycat.je.DbInternal;</div>
<div>28&emsp;&emsp;import berkeley.com.sleepycat.je.DuplicateDataException;</div>
<div>29&emsp;&emsp;import berkeley.com.sleepycat.je.EnvironmentFailureException;</div>
<div>30&emsp;&emsp;import berkeley.com.sleepycat.je.LockConflictException;</div>
<div>31&emsp;&emsp;import berkeley.com.sleepycat.je.LockNotAvailableException;</div>
<div>32&emsp;&emsp;import berkeley.com.sleepycat.je.OperationResult;</div>
<div>33&emsp;&emsp;import berkeley.com.sleepycat.je.config.EnvironmentParams;</div>
<div>34&emsp;&emsp;import berkeley.com.sleepycat.je.latch.LatchSupport;</div>
<div>35&emsp;&emsp;import berkeley.com.sleepycat.je.log.LogItem;</div>
<div>36&emsp;&emsp;import berkeley.com.sleepycat.je.log.LogUtils;</div>
<div>37&emsp;&emsp;import berkeley.com.sleepycat.je.log.ReplicationContext;</div>
<div>38&emsp;&emsp;import berkeley.com.sleepycat.je.tree.BIN;</div>
<div>39&emsp;&emsp;import berkeley.com.sleepycat.je.tree.BINBoundary;</div>
<div>40&emsp;&emsp;import berkeley.com.sleepycat.je.tree.IN;</div>
<div>41&emsp;&emsp;import berkeley.com.sleepycat.je.tree.Key;</div>
<div>42&emsp;&emsp;import berkeley.com.sleepycat.je.tree.LN;</div>
<div>43&emsp;&emsp;import berkeley.com.sleepycat.je.tree.SearchResult;</div>
<div>44&emsp;&emsp;import berkeley.com.sleepycat.je.tree.StorageSize;</div>
<div>45&emsp;&emsp;import berkeley.com.sleepycat.je.tree.TrackingInfo;</div>
<div>46&emsp;&emsp;import berkeley.com.sleepycat.je.tree.Tree;</div>
<div>47&emsp;&emsp;import berkeley.com.sleepycat.je.tree.TreeWalkerStatsAccumulator;</div>
<div>48&emsp;&emsp;import berkeley.com.sleepycat.je.txn.LockGrantType;</div>
<div>49&emsp;&emsp;import berkeley.com.sleepycat.je.txn.LockInfo;</div>
<div>50&emsp;&emsp;import berkeley.com.sleepycat.je.txn.LockManager;</div>
<div>51&emsp;&emsp;import berkeley.com.sleepycat.je.txn.LockResult;</div>
<div>52&emsp;&emsp;import berkeley.com.sleepycat.je.txn.LockType;</div>
<div>53&emsp;&emsp;import berkeley.com.sleepycat.je.txn.Locker;</div>
<div>54&emsp;&emsp;import berkeley.com.sleepycat.je.txn.LockerFactory;</div>
<div>55&emsp;&emsp;import berkeley.com.sleepycat.je.txn.WriteLockInfo;</div>
<div>56&emsp;&emsp;import berkeley.com.sleepycat.je.utilint.DbLsn;</div>
<div>57&emsp;&emsp;import berkeley.com.sleepycat.je.utilint.LoggerUtils;</div>
<div>58&emsp;&emsp;import berkeley.com.sleepycat.je.utilint.Pair;</div>
<div>59&emsp;&emsp;import berkeley.com.sleepycat.je.utilint.StatGroup;</div>
<div>60&emsp;&emsp;import berkeley.com.sleepycat.je.utilint.TestHook;</div>
<div>61&emsp;&emsp;import berkeley.com.sleepycat.je.utilint.TestHookExecute;</div>
<div>62&emsp;&emsp;import berkeley.com.sleepycat.je.utilint.VLSN;</div>
<div>63&emsp;&emsp;</div>
<div>64&emsp;&emsp;/**</div>
<div>65&emsp;&emsp;&nbsp; * A CursorImpl is the internal implementation of the cursor.</div>
<div>66&emsp;&emsp;&nbsp; */</div>
<div style="background-color:limegreen;">67&emsp;&emsp;<b>public class CursorImpl implements Cloneable {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>68&emsp;&emsp;</div>
<div>69&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private static final boolean DEBUG = false;</div>
<div>70&emsp;&emsp;</div>
<div>71&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private static final byte CURSOR_NOT_INITIALIZED = 1;</div>
<div>72&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private static final byte CURSOR_INITIALIZED = 2;</div>
<div>73&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private static final byte CURSOR_CLOSED = 3;</div>
<div>74&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private static final String TRACE_DELETE = "Delete";</div>
<div>75&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private static final String TRACE_MOD = "Mod:";</div>
<div>76&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private static final String TRACE_INSERT = "Ins:";</div>
<div>77&emsp;&emsp;</div>
<div>78&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public static final int FOUND = 0x1;</div>
<div>79&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /* Exact match on the key portion. */</div>
<div>80&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public static final int EXACT_KEY = 0x2;</div>
<div>81&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /* Record found is the last one in the dbImpl. */</div>
<div>82&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public static final int FOUND_LAST = 0x4;</div>
<div>83&emsp;&emsp;</div>
<div>84&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /*</div>
<div>85&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Allocate hashCode ids from this. [#13896]</div>
<div>86&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>87&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private static long lastAllocatedId = 0;</div>
<div>88&emsp;&emsp;</div>
<div>89&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /*</div>
<div>90&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Unique id that we can return as a hashCode to prevent calls to</div>
<div>91&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Object.hashCode(). [#13896]</div>
<div>92&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>93&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private final int thisId;</div>
<div>94&emsp;&emsp;</div>
<div>95&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /* The dbImpl behind the handle. */</div>
<div>96&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private final DatabaseImpl dbImpl;</div>
<div>97&emsp;&emsp;</div>
<div>98&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /* Owning transaction. */</div>
<div>99&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private Locker locker;</div>
<div>100&emsp;&emsp;</div>
<div>101&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private final boolean retainNonTxnLocks;</div>
<div>102&emsp;&emsp;</div>
<div>103&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private final boolean isSecondaryCursor;</div>
<div>104&emsp;&emsp;</div>
<div>105&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /*</div>
<div>106&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Cursor location in the dbImpl, represented by a BIN and an index</div>
<div>107&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * in the BIN.  The bin is null if not established, and the index is</div>
<div>108&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * negative if not established.</div>
<div>109&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>110&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private volatile BIN bin;</div>
<div>111&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private volatile int index;</div>
<div>112&emsp;&emsp;</div>
<div>113&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /* State of the cursor. See CURSOR_XXX above. */</div>
<div>114&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private byte status;</div>
<div>115&emsp;&emsp;</div>
<div>116&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private CacheMode cacheMode;</div>
<div>117&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private boolean allowEviction;</div>
<div>118&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private BIN priorBIN;</div>
<div>119&emsp;&emsp;</div>
<div>120&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /*</div>
<div>121&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * A cache of the record version for the operation at the current position.</div>
<div>122&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Is null if the cursor is uninitialized.  For a secondary cursor, is the</div>
<div>123&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * version of the primary record.</div>
<div>124&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>125&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private RecordVersion currentRecordVersion;</div>
<div>126&emsp;&emsp;</div>
<div>127&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /*</div>
<div>128&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * A cache of the storage size for the operation at the cursor position.</div>
<div>129&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Both values are zero if the cursor is uninitialized. priStorageSize is</div>
<div>130&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * non-zero only if Cursor.readPrimaryAfterGet was called.</div>
<div>131&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>132&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private int storageSize;</div>
<div>133&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private int priStorageSize;</div>
<div>134&emsp;&emsp;</div>
<div>135&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /* Number of secondary records written by a primary put or delete. */</div>
<div>136&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private int nSecWrites;</div>
<div>137&emsp;&emsp;</div>
<div>138&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private ThreadLocal&#60;TreeWalkerStatsAccumulator> treeStatsAccumulatorTL;</div>
<div>139&emsp;&emsp;</div>
<div>140&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private TestHook testHook;</div>
<div>141&emsp;&emsp;</div>
<div>142&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>143&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Creates a cursor with retainNonTxnLocks=true, isSecondaryCursor=false.</div>
<div>144&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * These are the standard settings for an internal cursor.</div>
<div>145&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>146&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public CursorImpl(DatabaseImpl database, Locker locker) {</div>
<div>147&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        this(database, locker,</div>
<div>148&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             true /*retainNonTxnLocks*/,</div>
<div>149&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             false /*isSecondaryCursor*/);</div>
<div>150&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>151&emsp;&emsp;</div>
<div>152&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>153&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Creates a cursor.</div>
<div>154&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>155&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * A cursor always retains transactional locks when it is reset or closed.</div>
<div>156&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Non-transaction locks may be retained or not, depending on the</div>
<div>157&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * retainNonTxnLocks parameter value.</div>
<div>158&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>159&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Normally a user-created non-transactional Cursor releases locks on reset</div>
<div>160&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * and close, and a ThreadLocker is normally used.  However, by passing</div>
<div>161&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * true for retainNonTxnLocks a ThreadLocker can be made to retain locks;</div>
<div>162&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * this capability is used by SecondaryCursor.readPrimaryAfterGet.</div>
<div>163&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>164&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * For internal (non-user) cursors, a BasicLocker is often used and locks</div>
<div>165&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * are retained. In these internal use cases the caller explicitly calls</div>
<div>166&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * BasicLocker.operationEnd() after the cursor is closed, and</div>
<div>167&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * retainNonTxnLocks is set to true to prevent the locks acquired by the</div>
<div>168&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * BasicLocker from being released when the cursor is closed.</div>
<div>169&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>170&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * BasicLocker is also used for NameLN operations while opening a Database</div>
<div>171&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * handle.  Database handle locks must be retained, even if the Database is</div>
<div>172&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * opened non-transactionally.</div>
<div>173&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>174&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param retainNonTxnLocks is true if non-transactional locks should be</div>
<div>175&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * retained (not released automatically) when the cursor is reset or</div>
<div>176&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * closed.</div>
<div>177&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>178&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param isSecondaryCursor whether to treat this cursor as a secondary</div>
<div>179&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * cursor, e.g., secondary records don't have record versions.</div>
<div>180&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>181&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public CursorImpl(</div>
<div>182&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseImpl dbImpl,</div>
<div>183&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        Locker locker,</div>
<div>184&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean retainNonTxnLocks,</div>
<div>185&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean isSecondaryCursor) {</div>
<div>186&emsp;&emsp;</div>
<div>187&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        thisId = (int) getNextCursorId();</div>
<div>188&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        bin = null;</div>
<div>189&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        index = -1;</div>
<div>190&emsp;&emsp;</div>
<div>191&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        this.retainNonTxnLocks = retainNonTxnLocks;</div>
<div>192&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        this.isSecondaryCursor = isSecondaryCursor;</div>
<div>193&emsp;&emsp;</div>
<div>194&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Associate this cursor with the dbImpl. */</div>
<div>195&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        this.dbImpl = dbImpl;</div>
<div>196&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        this.locker = locker;</div>
<div>197&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        this.locker.registerCursor(this);</div>
<div>198&emsp;&emsp;</div>
<div>199&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>200&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * This default value is used only when the CursorImpl is used directly</div>
<div>201&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * (mainly for internal databases).  When the CursorImpl is created by</div>
<div>202&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * a Cursor, CursorImpl.setCacheMode will be called.</div>
<div>203&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>204&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        this.cacheMode = CacheMode.DEFAULT;</div>
<div>205&emsp;&emsp;</div>
<div>206&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        status = CURSOR_NOT_INITIALIZED;</div>
<div>207&emsp;&emsp;</div>
<div>208&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>209&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Do not perform eviction here because we may be synchronized on the</div>
<div>210&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Database instance. For example, this happens when we call</div>
<div>211&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Database.openCursor().  Also eviction may be disabled after the</div>
<div>212&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * cursor is constructed.</div>
<div>213&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>214&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>215&emsp;&emsp;</div>
<div>216&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>217&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Performs a shallow copy and returns the new cursor.</div>
<div>218&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>219&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param samePosition If true, this cursor's position is used for the new</div>
<div>220&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * cursor, and addCursor is called on the new cursor to register it with</div>
<div>221&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * the current BIN.  If false, the new cursor will be uninitialized.</div>
<div>222&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>223&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public CursorImpl cloneCursor(final boolean samePosition) {</div>
<div>224&emsp;&emsp;</div>
<div style="background-color:limegreen;">225&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert assertCursorState(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>226&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            false /*mustBeInitialized*/, false /*mustNotBeInitialized*/);</div>
<div>227&emsp;&emsp;</div>
<div>228&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        CursorImpl ret = null;</div>
<div>229&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>230&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            latchBIN();</div>
<div>231&emsp;&emsp;</div>
<div>232&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            ret = (CursorImpl) super.clone();</div>
<div>233&emsp;&emsp;</div>
<div style="background-color:limegreen;">234&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (!retainNonTxnLocks) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>235&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                ret.locker = locker.newNonTxnLocker();</div>
<div>236&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>237&emsp;&emsp;</div>
<div>238&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            ret.locker.registerCursor(ret);</div>
<div>239&emsp;&emsp;</div>
<div style="background-color:limegreen;">240&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (samePosition) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>241&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                ret.addCursor();</div>
<div>242&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            } else {</div>
<div>243&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                ret.clear();</div>
<div>244&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>245&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } catch (CloneNotSupportedException cannotOccur) {</div>
<div>246&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return null;</div>
<div>247&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div>248&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            releaseBIN();</div>
<div>249&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>250&emsp;&emsp;</div>
<div>251&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Perform eviction before and after each cursor operation. */</div>
<div>252&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        criticalEviction();</div>
<div>253&emsp;&emsp;</div>
<div>254&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return ret;</div>
<div>255&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>256&emsp;&emsp;</div>
<div>257&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /*</div>
<div>258&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Allocate a new hashCode id.  Doesn't need to be synchronized since it's</div>
<div>259&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * ok for two objects to have the same hashcode.</div>
<div>260&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>261&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private static long getNextCursorId() {</div>
<div>262&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return ++lastAllocatedId;</div>
<div>263&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>264&emsp;&emsp;</div>
<div>265&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    @Override</div>
<div>266&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public int hashCode() {</div>
<div>267&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return thisId;</div>
<div>268&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>269&emsp;&emsp;</div>
<div>270&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public Locker getLocker() {</div>
<div>271&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return locker;</div>
<div>272&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>273&emsp;&emsp;</div>
<div>274&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>275&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Called when a cursor has been duplicated prior to being moved.  The new</div>
<div>276&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * locker is informed of the old locker, so that a preempted lock taken by</div>
<div>277&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * the old locker can be ignored. [#16513]</div>
<div>278&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>279&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param closingCursor the old cursor that will be closed if the new</div>
<div>280&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * cursor is moved successfully.</div>
<div>281&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>282&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void setClosingLocker(CursorImpl closingCursor) {</div>
<div>283&emsp;&emsp;</div>
<div>284&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>285&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * If the two lockers are different, then the old locker will be closed</div>
<div>286&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * when the operation is complete.  This is currently the case only for</div>
<div>287&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * ReadCommitted cursors and non-transactional cursors that do not</div>
<div>288&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * retain locks.</div>
<div>289&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div style="background-color:limegreen;">290&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (!retainNonTxnLocks && locker != closingCursor.locker) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>291&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            locker.setClosingLocker(closingCursor.locker);</div>
<div>292&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>293&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>294&emsp;&emsp;</div>
<div>295&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>296&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Called when a cursor move operation is complete.  Clears the</div>
<div>297&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * closingLocker so that a reference to the old closed locker is not held.</div>
<div>298&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>299&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void clearClosingLocker() {</div>
<div>300&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        locker.setClosingLocker(null);</div>
<div>301&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>302&emsp;&emsp;</div>
<div>303&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public CacheMode getCacheMode() {</div>
<div>304&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return cacheMode;</div>
<div>305&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>306&emsp;&emsp;</div>
<div>307&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>308&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Sets the effective cache mode to use for the next operation.  The</div>
<div>309&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * cacheMode field will never be set to null, and can be passed directly to</div>
<div>310&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * latching methods.</div>
<div>311&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>312&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @see #performCacheModeEviction</div>
<div>313&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>314&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void setCacheMode(final CacheMode mode) {</div>
<div>315&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        cacheMode = mode;</div>
<div>316&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>317&emsp;&emsp;</div>
<div>318&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void setTreeStatsAccumulator(TreeWalkerStatsAccumulator tSA) {</div>
<div>319&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        maybeInitTreeStatsAccumulator();</div>
<div>320&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        treeStatsAccumulatorTL.set(tSA);</div>
<div>321&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>322&emsp;&emsp;</div>
<div>323&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void maybeInitTreeStatsAccumulator() {</div>
<div style="background-color:limegreen;">324&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (treeStatsAccumulatorTL == null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>325&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            treeStatsAccumulatorTL = new ThreadLocal&#60;>();</div>
<div>326&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>327&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>328&emsp;&emsp;</div>
<div>329&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private TreeWalkerStatsAccumulator getTreeStatsAccumulator() {</div>
<div style="background-color:limegreen;">330&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (EnvironmentImpl.getThreadLocalReferenceCount() > 0) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>331&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            maybeInitTreeStatsAccumulator();</div>
<div>332&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return treeStatsAccumulatorTL.get();</div>
<div>333&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</div>
<div>334&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return null;</div>
<div>335&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>336&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>337&emsp;&emsp;</div>
<div>338&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void incrementLNCount() {</div>
<div>339&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        TreeWalkerStatsAccumulator treeStatsAccumulator =</div>
<div>340&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            getTreeStatsAccumulator();</div>
<div style="background-color:limegreen;">341&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (treeStatsAccumulator != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>342&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            treeStatsAccumulator.incrementLNCount();</div>
<div>343&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>344&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>345&emsp;&emsp;</div>
<div>346&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public int getIndex() {</div>
<div>347&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return index;</div>
<div>348&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>349&emsp;&emsp;</div>
<div>350&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public BIN getBIN() {</div>
<div>351&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return bin;</div>
<div>352&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>353&emsp;&emsp;</div>
<div>354&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void setIndex(int idx) {</div>
<div>355&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        index = idx;</div>
<div>356&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>357&emsp;&emsp;</div>
<div>358&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void setOnFirstSlot() {</div>
<div>359&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        assert(bin.isLatchOwner());</div>
<div>360&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        index = 0;</div>
<div>361&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>362&emsp;&emsp;</div>
<div>363&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void setOnLastSlot() {</div>
<div>364&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        assert(bin.isLatchOwner());</div>
<div>365&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        index = bin.getNEntries() - 1;</div>
<div>366&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>367&emsp;&emsp;</div>
<div>368&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public boolean isOnBIN(BIN bin) {</div>
<div>369&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return this.bin == bin;</div>
<div>370&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>371&emsp;&emsp;</div>
<div>372&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void assertBIN(BIN bin) {</div>
<div>373&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        assert this.bin == bin :</div>
<div>374&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            "nodeId=" + bin.getNodeId() +</div>
<div>375&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            " cursor=" + dumpToString(true);</div>
<div>376&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>377&emsp;&emsp;</div>
<div>378&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public boolean isOnSamePosition(CursorImpl other) {</div>
<div>379&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return bin == other.bin && index == other.index;</div>
<div>380&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>381&emsp;&emsp;</div>
<div>382&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void setBIN(BIN newBin) {</div>
<div>383&emsp;&emsp;</div>
<div>384&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>385&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Historical note. In the past we checked here that the cursor was</div>
<div>386&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * removed for the prior BIN by calling BIN.containsCursor [#16280].</div>
<div>387&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Because the containsCursor method takes a latch on the prior BIN,</div>
<div>388&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * this causes a rare latch deadlock when newBin is latched (during an</div>
<div>389&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * insert, for example), since this thread will latch two BINs in</div>
<div>390&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * arbitrary order; so the assertion was removed [#21395].</div>
<div>391&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>392&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        bin = newBin;</div>
<div>393&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>394&emsp;&emsp;</div>
<div>395&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void latchBIN() {</div>
<div style="background-color:limegreen;">396&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        while (bin != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>397&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            BIN waitingOn = bin;</div>
<div>398&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            waitingOn.latch(cacheMode);</div>
<div style="background-color:limegreen;">399&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (bin == waitingOn) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>400&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return;</div>
<div>401&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>402&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            waitingOn.releaseLatch();</div>
<div>403&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>404&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>405&emsp;&emsp;</div>
<div>406&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void releaseBIN() {</div>
<div style="background-color:limegreen;">407&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (bin != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>408&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            bin.releaseLatchIfOwner();</div>
<div>409&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>410&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>411&emsp;&emsp;</div>
<div>412&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    void addCursor(BIN bin) {</div>
<div style="background-color:limegreen;">413&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (bin != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">414&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert bin.isLatchExclusiveOwner();&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>415&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            bin.addCursor(this);</div>
<div>416&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>417&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>418&emsp;&emsp;</div>
<div>419&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>420&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Add to the current cursor.</div>
<div>421&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>422&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    void addCursor() {</div>
<div style="background-color:limegreen;">423&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (bin != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>424&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            addCursor(bin);</div>
<div>425&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>426&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>427&emsp;&emsp;</div>
<div>428&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>429&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Change cursor to point to the given BIN/index.  If the new BIN is</div>
<div>430&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * different, then old BIN must be unlatched and the new BIN must be</div>
<div>431&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * latched.</div>
<div>432&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>433&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void setPosition(BIN newBin, int newIndex) {</div>
<div>434&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (bin != newBin) {</div>
<div>435&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (bin != null) {</div>
<div>436&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                latchBIN();</div>
<div>437&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin.removeCursor(this);</div>
<div>438&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin.releaseLatch();</div>
<div>439&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>440&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            setBIN(newBin);</div>
<div>441&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            addCursor();</div>
<div>442&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>443&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        setIndex(newIndex);</div>
<div>444&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>445&emsp;&emsp;</div>
<div>446&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>447&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Called for creating trace messages without any latching.</div>
<div>448&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>449&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public long getCurrentNodeId() {</div>
<div>450&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final BIN b = bin;</div>
<div style="background-color:limegreen;">451&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        return (b == null ? -1 : b.getNodeId());&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>452&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>453&emsp;&emsp;</div>
<div>454&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public long getCurrentLsn() {</div>
<div>455&emsp;&emsp;</div>
<div style="background-color:limegreen;">456&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert(bin != null && bin.isLatchOwner());&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">457&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert(index >= 0 && index &#60; bin.getNEntries());&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>458&emsp;&emsp;</div>
<div>459&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return bin.getLsn(index);</div>
<div>460&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>461&emsp;&emsp;</div>
<div>462&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public byte[] getCurrentKey() {</div>
<div>463&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return getCurrentKey(false);</div>
<div>464&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>465&emsp;&emsp;</div>
<div>466&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>467&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Returns the key at the current position, regardless of whether the</div>
<div>468&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * record is defunct.  Does not lock. The key returned is not a copy and</div>
<div>469&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * may not be returned directly to the user without copying it first.</div>
<div>470&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>471&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The cursor must be initialized.</div>
<div>472&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>473&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * TODO:</div>
<div>474&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The returned byte array is normally, but not always a copied, and then</div>
<div>475&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * copied again into the user's DatabaseEntry. If this method always</div>
<div>476&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * returns a copy, the extra copy into DatabaseEntry could be avoided.</div>
<div>477&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>478&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public byte[] getCurrentKey(boolean isLatched) {</div>
<div>479&emsp;&emsp;</div>
<div style="background-color:limegreen;">480&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (!isLatched) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>481&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            latchBIN();</div>
<div>482&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>483&emsp;&emsp;</div>
<div>484&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div style="background-color:limegreen;">485&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert(bin != null);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">486&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert(index >= 0 && index &#60; bin.getNEntries());&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>487&emsp;&emsp;</div>
<div>488&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return bin.getKey(index);</div>
<div>489&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div style="background-color:limegreen;">490&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (!isLatched) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>491&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                releaseBIN();</div>
<div>492&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>493&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>494&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>495&emsp;&emsp;</div>
<div>496&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public boolean isProbablyExpired() {</div>
<div>497&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        latchBIN();</div>
<div>498&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>499&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return bin.isProbablyExpired(index);</div>
<div>500&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div>501&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            releaseBIN();</div>
<div>502&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>503&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>504&emsp;&emsp;</div>
<div>505&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public long getExpirationTime() {</div>
<div>506&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        latchBIN();</div>
<div>507&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>508&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return TTL.expirationToSystemTime(</div>
<div>509&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin.getExpiration(index), bin.isExpirationInHours());</div>
<div>510&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div>511&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            releaseBIN();</div>
<div>512&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>513&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>514&emsp;&emsp;</div>
<div>515&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void setInitialized() {</div>
<div>516&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        status = CURSOR_INITIALIZED;</div>
<div>517&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>518&emsp;&emsp;</div>
<div>519&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>520&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @return true if this cursor is closed</div>
<div>521&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>522&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public boolean isClosed() {</div>
<div style="background-color:limegreen;">523&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        return (status == CURSOR_CLOSED);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>524&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>525&emsp;&emsp;</div>
<div>526&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>527&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @return true if this cursor is not initialized</div>
<div>528&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>529&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public boolean isNotInitialized() {</div>
<div style="background-color:limegreen;">530&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        return (status == CURSOR_NOT_INITIALIZED);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>531&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>532&emsp;&emsp;</div>
<div>533&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public boolean isInternalDbCursor() {</div>
<div>534&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return dbImpl.isInternalDb();</div>
<div>535&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>536&emsp;&emsp;</div>
<div>537&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public boolean hasDuplicates() {</div>
<div>538&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return dbImpl.getSortedDuplicates();</div>
<div>539&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>540&emsp;&emsp;</div>
<div>541&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>542&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * For a non-sticky cursor, this method is called when the cursor is</div>
<div>543&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * initialized and an advancing operation (next/prev/skip) is about to be</div>
<div>544&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * performed. The cursor position is not reset as it would be if the</div>
<div>545&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * operation were a search or an insertion, for example.</div>
<div>546&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>547&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void beforeNonStickyOp() {</div>
<div>548&emsp;&emsp;</div>
<div>549&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>550&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * When the cache mode dictates that we evict the LN or BIN, we evict</div>
<div>551&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * the LN here before the cursor's position changes. We can assume that</div>
<div>552&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * either the position will change or the cursor will be reset. The BIN</div>
<div>553&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * is evicted later.</div>
<div>554&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div style="background-color:limegreen;">555&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (cacheMode != CacheMode.DEFAULT &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>556&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            cacheMode != CacheMode.KEEP_HOT) {</div>
<div>557&emsp;&emsp;</div>
<div>558&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            latchBIN();</div>
<div>559&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            try {</div>
<div>560&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                performCacheModeLNEviction();</div>
<div>561&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            } finally {</div>
<div>562&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                releaseBIN();</div>
<div>563&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>564&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>565&emsp;&emsp;</div>
<div>566&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        releaseNonTxnLocks();</div>
<div>567&emsp;&emsp;</div>
<div>568&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        criticalEviction();</div>
<div>569&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>570&emsp;&emsp;</div>
<div>571&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>572&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * For a non-sticky cursor, this method is called after a successful</div>
<div>573&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * operation. The cursor position is not reset as it would be if the</div>
<div>574&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * operation failed.</div>
<div>575&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>576&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void afterNonStickyOp() {</div>
<div>577&emsp;&emsp;</div>
<div>578&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>579&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * To implement BIN eviction for a non-sticky cursor we must save the</div>
<div>580&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * prior BIN, and only evict it after the operation and only when the</div>
<div>581&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * BIN changes. The prior BIN is evicted after the operation (in this</div>
<div>582&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * method) and when the cursor is reset or closed.</div>
<div>583&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>584&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        performPriorBINEviction();</div>
<div>585&emsp;&emsp;</div>
<div style="background-color:limegreen;">586&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (priorBIN == null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>587&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            priorBIN = bin;</div>
<div>588&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>589&emsp;&emsp;</div>
<div>590&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        criticalEviction();</div>
<div>591&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>592&emsp;&emsp;</div>
<div>593&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>594&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Reset a cursor to an uninitialized state, but unlike close(), allow it</div>
<div>595&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * to be used further.</div>
<div>596&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>597&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void reset() {</div>
<div>598&emsp;&emsp;</div>
<div>599&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Must remove cursor before evicting BIN and releasing locks. */</div>
<div>600&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        removeCursorAndPerformCacheEviction(null /*newCursor*/);</div>
<div>601&emsp;&emsp;</div>
<div>602&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        releaseNonTxnLocks();</div>
<div>603&emsp;&emsp;</div>
<div>604&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Perform eviction before and after each cursor operation. */</div>
<div>605&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        criticalEviction();</div>
<div>606&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>607&emsp;&emsp;</div>
<div>608&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void clear() {</div>
<div>609&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        bin = null;</div>
<div>610&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        index = -1;</div>
<div>611&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        status = CURSOR_NOT_INITIALIZED;</div>
<div>612&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        currentRecordVersion = null;</div>
<div>613&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        storageSize = 0;</div>
<div>614&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        priStorageSize = 0;</div>
<div>615&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        nSecWrites = 0;</div>
<div>616&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        priorBIN = null;</div>
<div>617&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>618&emsp;&emsp;</div>
<div>619&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void releaseNonTxnLocks() {</div>
<div style="background-color:limegreen;">620&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (!retainNonTxnLocks) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>621&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            locker.releaseNonTxnLocks();</div>
<div>622&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>623&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>624&emsp;&emsp;</div>
<div>625&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void close() {</div>
<div>626&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        close(null);</div>
<div>627&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>628&emsp;&emsp;</div>
<div>629&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>630&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Close a cursor.</div>
<div>631&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>632&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param newCursor is another cursor that is kept open by the parent</div>
<div>633&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Cursor object, or null if no other cursor is kept open.</div>
<div>634&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>635&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void close(final CursorImpl newCursor) {</div>
<div>636&emsp;&emsp;</div>
<div style="background-color:limegreen;">637&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert assertCursorState(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>638&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            false /*mustBeInitialized*/, false /*mustNotBeInitialized*/);</div>
<div>639&emsp;&emsp;</div>
<div>640&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Must remove cursor before evicting BIN and releasing locks. */</div>
<div>641&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        removeCursorAndPerformCacheEviction(newCursor);</div>
<div>642&emsp;&emsp;</div>
<div>643&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        locker.unRegisterCursor(this);</div>
<div>644&emsp;&emsp;</div>
<div style="background-color:limegreen;">645&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (!retainNonTxnLocks) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>646&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            locker.nonTxnOperationEnd();</div>
<div>647&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>648&emsp;&emsp;</div>
<div>649&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        status = CURSOR_CLOSED;</div>
<div>650&emsp;&emsp;</div>
<div>651&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Perform eviction before and after each cursor operation. */</div>
<div>652&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        criticalEviction();</div>
<div>653&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>654&emsp;&emsp;</div>
<div>655&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void removeCursorAndPerformCacheEviction(CursorImpl newCursor) {</div>
<div>656&emsp;&emsp;</div>
<div>657&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        performPriorBINEviction();</div>
<div>658&emsp;&emsp;</div>
<div>659&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        latchBIN();</div>
<div>660&emsp;&emsp;</div>
<div style="background-color:limegreen;">661&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (bin == null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>662&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            clear(); // ensure that state is uninitialized</div>
<div>663&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return;</div>
<div>664&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>665&emsp;&emsp;</div>
<div>666&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>667&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* Must remove cursor before evicting BIN. */</div>
<div>668&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            bin.removeCursor(this);</div>
<div>669&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            performCacheModeEviction(newCursor); // may release latch</div>
<div>670&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div>671&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            releaseBIN();</div>
<div>672&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            clear();</div>
<div>673&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>674&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>675&emsp;&emsp;</div>
<div>676&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>677&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Performs cache mode-based eviction but for the prior BIN only. This is</div>
<div>678&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * called after a successful operation using a non-sticky cursor. The prior</div>
<div>679&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * BIN is evicted only if the BIN has changed.</div>
<div>680&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>681&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void performPriorBINEviction() {</div>
<div>682&emsp;&emsp;</div>
<div style="background-color:limegreen;">683&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (priorBIN == null || priorBIN == bin) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>684&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return;</div>
<div>685&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>686&emsp;&emsp;</div>
<div>687&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>688&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * This priorBIN should not be processed again, and setting it to null</div>
<div>689&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * enables the setting of a new priorBIN.</div>
<div>690&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>691&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        BIN binToEvict = priorBIN;</div>
<div>692&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        priorBIN = null;</div>
<div>693&emsp;&emsp;</div>
<div>694&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Short circuit modes that do not perform BIN eviction. */</div>
<div style="background-color:limegreen;">695&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (cacheMode== CacheMode.DEFAULT ||&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>696&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            cacheMode == CacheMode.KEEP_HOT ||</div>
<div>697&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            cacheMode == CacheMode.EVICT_LN) {</div>
<div>698&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return;</div>
<div>699&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>700&emsp;&emsp;</div>
<div>701&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        binToEvict.latch(CacheMode.UNCHANGED);</div>
<div>702&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>703&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            performCacheModeBINEviction(binToEvict);</div>
<div>704&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div>705&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            binToEvict.releaseLatchIfOwner();</div>
<div>706&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>707&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>708&emsp;&emsp;</div>
<div>709&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>710&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Disables or enables eviction during cursor operations.  For example, a</div>
<div>711&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * cursor used to implement eviction (e.g., in some UtilizationProfile and</div>
<div>712&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * most DbTree and VLSNIndex methods) should not itself perform eviction,</div>
<div>713&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * but eviction should be enabled for user cursors.  Eviction is disabled</div>
<div>714&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * by default.</div>
<div>715&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>716&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void setAllowEviction(boolean allowed) {</div>
<div>717&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        allowEviction = allowed;</div>
<div>718&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>719&emsp;&emsp;</div>
<div>720&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void criticalEviction() {</div>
<div>721&emsp;&emsp;</div>
<div>722&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>723&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * In addition to disabling critical eviction for internal cursors (see</div>
<div>724&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * setAllowEviction above), we do not perform critical eviction when</div>
<div>725&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * UNCHANGED, EVICT_BIN or MAKE_COLD is used and the BIN is not dirty.</div>
<div>726&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Operations using these modes for a non-dirty BIN generally do not</div>
<div>727&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * add any net memory to the cache, so they shouldn't have to perform</div>
<div>728&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * critical eviction or block while another thread performs eviction.</div>
<div>729&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div style="background-color:limegreen;">730&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (allowEviction &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">731&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            ((bin != null && bin.getDirty()) ||&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>732&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             (cacheMode != CacheMode.UNCHANGED &&</div>
<div>733&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;              cacheMode != CacheMode.EVICT_BIN &&</div>
<div>734&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;              cacheMode != CacheMode.MAKE_COLD))) {</div>
<div>735&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            dbImpl.getEnv().criticalEviction(false /*backgroundIO*/);</div>
<div>736&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>737&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>738&emsp;&emsp;</div>
<div>739&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>740&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * When multiple operations are performed, CacheMode-based eviction is</div>
<div>741&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * performed for a given operation at the end of the next operation, which</div>
<div>742&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * calls close() or reset() on the CursorImpl of the previous operation.</div>
<div>743&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Eviction for the last operation (including when only one operation is</div>
<div>744&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * performed) also occurs during Cursor.close(), which calls</div>
<div>745&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * CursorImpl.close().</div>
<div>746&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>747&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * By default, the CacheMode returned by DatabaseImpl.getCacheMode is used,</div>
<div>748&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * and the defaults specified by the user for the Database or Environment</div>
<div>749&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * are applied.  However, the default mode can be overridden by the user by</div>
<div>750&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * calling Cursor.setCacheMode, and the mode may be changed prior to each</div>
<div>751&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * operation, if desired.</div>
<div>752&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>753&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * To implement a per-operation CacheMode, two CacheMode fields are</div>
<div>754&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * maintained.  Cursor.cacheMode is the mode to use for the next operation.</div>
<div>755&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * CursorImpl.cacheMode is the mode that was used for the previous</div>
<div>756&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * operation, and that is used for eviction when that CursorImpl is closed</div>
<div>757&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * or reset.</div>
<div>758&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>759&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * This method must be called with the BIN latched but may release it,</div>
<div>760&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * namely when the BIN is evicted.</div>
<div>761&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>762&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void performCacheModeEviction(final CursorImpl newCursor) {</div>
<div>763&emsp;&emsp;</div>
<div>764&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Short circuit modes that do not perform LN or BIN eviction. */</div>
<div style="background-color:limegreen;">765&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (cacheMode == CacheMode.DEFAULT ||&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>766&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            cacheMode == CacheMode.KEEP_HOT) {</div>
<div>767&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return;</div>
<div>768&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>769&emsp;&emsp;</div>
<div>770&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean movedOffBin;</div>
<div>771&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean movedOffLn;</div>
<div>772&emsp;&emsp;</div>
<div style="background-color:limegreen;">773&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (newCursor != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">774&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            movedOffBin = (bin != newCursor.bin);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">775&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            movedOffLn = (movedOffBin || index != newCursor.index);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>776&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</div>
<div>777&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            movedOffBin = true;</div>
<div>778&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            movedOffLn = true;</div>
<div>779&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>780&emsp;&emsp;</div>
<div style="background-color:limegreen;">781&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (movedOffLn) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>782&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            performCacheModeLNEviction();</div>
<div>783&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>784&emsp;&emsp;</div>
<div>785&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Short circuit modes that do not perform BIN eviction. */</div>
<div style="background-color:limegreen;">786&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (cacheMode == CacheMode.EVICT_LN) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>787&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return;</div>
<div>788&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>789&emsp;&emsp;</div>
<div style="background-color:limegreen;">790&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (movedOffBin) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>791&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            performCacheModeBINEviction(bin);</div>
<div>792&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>793&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>794&emsp;&emsp;</div>
<div>795&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>796&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Performs the LN portion of CacheMode eviction. The BIN is latched on</div>
<div>797&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * method entry and exit. Must be called only for CacheMode.EVICT_LN,</div>
<div>798&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * EVICT_BIN, UNCHANGED and MAKE_COLD.</div>
<div>799&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>800&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void performCacheModeLNEviction() {</div>
<div style="background-color:limegreen;">801&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        switch (cacheMode) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>802&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        case EVICT_LN:</div>
<div>803&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        case EVICT_BIN:</div>
<div>804&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            evictLN(true /*isLatched*/, false /*ifFetchedCold*/);</div>
<div>805&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            break;</div>
<div>806&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        case UNCHANGED:</div>
<div>807&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        case MAKE_COLD:</div>
<div>808&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            evictLN(true /*isLatched*/, true /*ifFetchedCold*/);</div>
<div>809&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            break;</div>
<div>810&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        default:</div>
<div style="background-color:limegreen;">811&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert false;&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>812&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>813&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>814&emsp;&emsp;</div>
<div>815&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>816&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Performs the BIN portion of CacheMode eviction. The BIN is latched on</div>
<div>817&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * method entry, but may or may not be latched on exit. Must be called only</div>
<div>818&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * for CacheMode.EVICT_BIN, UNCHANGED and MAKE_COLD.</div>
<div>819&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>820&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void performCacheModeBINEviction(BIN binToEvict) {</div>
<div style="background-color:limegreen;">821&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        switch (cacheMode) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>822&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        case EVICT_BIN:</div>
<div>823&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            evictBIN(binToEvict, CacheMode.EVICT_BIN);</div>
<div>824&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            break;</div>
<div>825&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        case UNCHANGED:</div>
<div>826&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        case MAKE_COLD:</div>
<div style="background-color:limegreen;">827&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (binToEvict.getFetchedCold()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>828&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                evictBIN(binToEvict, CacheMode.UNCHANGED);</div>
<div>829&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>830&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            break;</div>
<div>831&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        default:</div>
<div style="background-color:limegreen;">832&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert false;&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>833&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>834&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>835&emsp;&emsp;</div>
<div>836&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>837&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Evict the given BIN. Must already be latched. The latch will be released</div>
<div>838&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * inside the doCacheModeEvict() call.</div>
<div>839&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>840&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void evictBIN(BIN binToEvict, CacheMode cacheMode) {</div>
<div>841&emsp;&emsp;</div>
<div>842&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        dbImpl.getEnv().getEvictor().doCacheModeEvict(binToEvict, cacheMode);</div>
<div>843&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>844&emsp;&emsp;</div>
<div>845&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>846&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Evict the LN node at the cursor position.</div>
<div>847&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>848&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void evictLN() {</div>
<div>849&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        evictLN(false /*isLatched*/, false /*ifFetchedCold*/);</div>
<div>850&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>851&emsp;&emsp;</div>
<div>852&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>853&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Evict the LN node at the cursor position.</div>
<div>854&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>855&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void evictLN(boolean isLatched, boolean ifFetchedCold) {</div>
<div>856&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div style="background-color:limegreen;">857&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (!isLatched) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>858&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                latchBIN();</div>
<div>859&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div style="background-color:limegreen;">860&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (index >= 0) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>861&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin.evictLN(index, ifFetchedCold);</div>
<div>862&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>863&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div style="background-color:limegreen;">864&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (!isLatched) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>865&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                releaseBIN();</div>
<div>866&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>867&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>868&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>869&emsp;&emsp;</div>
<div>870&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private boolean shouldEmbedLN(byte[] data) {</div>
<div>871&emsp;&emsp;</div>
<div style="background-color:limegreen;">872&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        return data.length &#60;= dbImpl.getEnv().getMaxEmbeddedLN() &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">873&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            !dbImpl.getSortedDuplicates() &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">874&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            !dbImpl.getDbType().isInternal();&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>875&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>876&emsp;&emsp;</div>
<div>877&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>878&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Delete the item pointed to by the cursor. If the item is already</div>
<div>879&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * defunct, return KEYEMPTY. Returns with nothing latched.</div>
<div>880&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>881&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public OperationResult deleteCurrentRecord(ReplicationContext repContext) {</div>
<div>882&emsp;&emsp;</div>
<div style="background-color:limegreen;">883&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert assertCursorState(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>884&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            true /*mustBeInitialized*/, false /*mustNotBeInitialized*/);</div>
<div>885&emsp;&emsp;</div>
<div>886&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final EnvironmentImpl envImpl = dbImpl.getEnv();</div>
<div>887&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final DbType dbType = dbImpl.getDbType();</div>
<div>888&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final long currLsn;</div>
<div>889&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LogItem logItem;</div>
<div>890&emsp;&emsp;</div>
<div>891&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean  success = false;</div>
<div>892&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        </div>
<div>893&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        latchBIN();</div>
<div>894&emsp;&emsp;</div>
<div>895&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>896&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>897&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Get a write lock. An uncontended lock is permitted because we</div>
<div>898&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * will log a new LN before releasing the BIN latch.</div>
<div>899&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>900&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            final LockStanding lockStanding = lockLN(</div>
<div>901&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                LockType.WRITE, true /*allowUncontended*/, false /*noWait*/);</div>
<div>902&emsp;&emsp;</div>
<div style="background-color:limegreen;">903&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (!lockStanding.recordExists()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>904&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                revertLock(lockStanding);</div>
<div>905&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                success = true;</div>
<div>906&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return null;</div>
<div>907&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>908&emsp;&emsp;</div>
<div>909&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            currLsn = lockStanding.lsn;</div>
<div style="background-color:limegreen;">910&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert(currLsn != DbLsn.NULL_LSN);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>911&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            final boolean currEmbeddedLN = bin.isEmbeddedLN(index);</div>
<div>912&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            final int currLoggedSize = bin.getLastLoggedSize(index);</div>
<div>913&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            final byte[] currKey = bin.getKey(index);</div>
<div>914&emsp;&emsp;</div>
<div>915&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            final int expiration = bin.getExpiration(index);</div>
<div>916&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            final boolean expirationInHours = bin.isExpirationInHours();</div>
<div>917&emsp;&emsp;</div>
<div>918&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>919&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Must fetch LN if the LN is not embedded and any of the following</div>
<div>920&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * are true:</div>
<div>921&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             *  - CLEANER_FETCH_OBSOLETE_SIZE is configured and lastLoggedSize</div>
<div>922&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             *    is unknown</div>
<div>923&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             *  - this database does not use the standard LN class and we</div>
<div>924&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             *    cannot call DbType.createdDeletedLN further below</div>
<div>925&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * For other cases, we are careful not to fetch, in order to avoid</div>
<div>926&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * a random read during a delete operation.</div>
<div>927&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>928&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            LN ln;</div>
<div style="background-color:limegreen;">929&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if ((currLoggedSize == 0 &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>930&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 !currEmbeddedLN &&</div>
<div style="background-color:limegreen;">931&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                 envImpl.getCleaner().getFetchObsoleteSize(dbImpl)) ||&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">932&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                !dbType.mayCreateDeletedLN()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>933&emsp;&emsp;</div>
<div>934&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                ln = bin.fetchLN(index, cacheMode);</div>
<div style="background-color:limegreen;">935&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if (ln == null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>936&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    /* An expired LN was purged. */</div>
<div>937&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    revertLock(lockStanding);</div>
<div>938&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    success = true;</div>
<div>939&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    return null;</div>
<div>940&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>941&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            } else {</div>
<div>942&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                ln = bin.getLN(index, cacheMode);</div>
<div>943&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>944&emsp;&emsp;</div>
<div>945&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>946&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Make the existing LN deleted, if cached; otherwise, create a</div>
<div>947&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * new deleted LN (with ln.data == null), but do not attach it</div>
<div>948&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * to the tree yet.</div>
<div>949&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>950&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            long oldLNMemSize = 0;</div>
<div style="background-color:limegreen;">951&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (ln != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>952&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                oldLNMemSize = ln.getMemorySizeIncludedByParent();</div>
<div>953&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                ln.delete();</div>
<div>954&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            } else {</div>
<div>955&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                ln = dbType.createDeletedLN(envImpl);</div>
<div>956&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>957&emsp;&emsp;</div>
<div>958&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* Get a wli to log. */</div>
<div>959&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            final WriteLockInfo wli = lockStanding.prepareForUpdate(bin, index);</div>
<div>960&emsp;&emsp;</div>
<div>961&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* Log the deleted record version and lock its new LSN. */</div>
<div>962&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            logItem = ln.optionalLog(</div>
<div>963&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                envImpl, dbImpl, locker, wli,</div>
<div>964&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                currEmbeddedLN /*newEmbeddedLN*/, currKey /*newKey*/,</div>
<div>965&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                expiration, expirationInHours,</div>
<div>966&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                currEmbeddedLN, currLsn, currLoggedSize,</div>
<div>967&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                false/*isInsertion*/, repContext);</div>
<div>968&emsp;&emsp;</div>
<div>969&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>970&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Now update the parent BIN to reference the logrec written</div>
<div>971&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * above, set the PD flag on, and do the BIN memory counting.</div>
<div>972&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>973&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            bin.deleteRecord(</div>
<div>974&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                index, oldLNMemSize, logItem.lsn,</div>
<div>975&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                ln.getVLSNSequence(), logItem.size);</div>
<div>976&emsp;&emsp;</div>
<div>977&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>978&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * If the LN is not cached, we don't need to attach the LN to the</div>
<div>979&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * tree, because as long as the PD flag is on, the record's data</div>
<div>980&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * will  never be accessed. But for DW DBs, we must attach the LN</div>
<div>981&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * because no logrec was generated above, and as a result, the LN</div>
<div>982&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * must be in the tree so that a logrec will be generated when</div>
<div>983&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * a db.sync() occurs later (that logrec is needed for crash</div>
<div>984&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * recovery, because BINs are not replayed during crash recovery).</div>
<div>985&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             *</div>
<div>986&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * If the LN child is cached, it is desirable to evict it because</div>
<div>987&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * as long as the PD flag is on, the record's data will  never be</div>
<div>988&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * accessed. But for DW DBs we should not evict the dirty LN since</div>
<div>989&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * it will be logged unnecessarily.</div>
<div>990&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div style="background-color:limegreen;">991&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (bin.getTarget(index) == null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">992&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if (dbImpl.isDeferredWriteMode()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>993&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    bin.attachNode(index, ln, null /*lnKey*/);</div>
<div>994&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>995&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            } else {</div>
<div style="background-color:limegreen;">996&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if (!dbImpl.isDeferredWriteMode()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>997&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    bin.evictLN(index);</div>
<div>998&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>999&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1000&emsp;&emsp;</div>
<div>1001&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* Cache record version/size for delete operation. */</div>
<div>1002&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            setCurrentVersion(ln.getVLSNSequence(), logItem.lsn);</div>
<div>1003&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            setStorageSize();</div>
<div>1004&emsp;&emsp;</div>
<div>1005&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            locker.addDeleteInfo(bin);</div>
<div>1006&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            success = true;</div>
<div>1007&emsp;&emsp;</div>
<div>1008&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            trace(Level.FINER, TRACE_DELETE, bin, index, currLsn, logItem.lsn);</div>
<div>1009&emsp;&emsp;</div>
<div>1010&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return DbInternal.makeResult(expiration, expirationInHours);</div>
<div>1011&emsp;&emsp;</div>
<div>1012&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div>1013&emsp;&emsp;</div>
<div style="background-color:limegreen;">1014&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (success &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">1015&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                !dbImpl.isInternalDb() &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1016&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin != null &&</div>
<div style="background-color:limegreen;">1017&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                bin.isBINDelta()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1018&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                dbImpl.getEnv().incBinDeltaDeletes();</div>
<div>1019&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1020&emsp;&emsp;</div>
<div>1021&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            releaseBIN();</div>
<div>1022&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1023&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>1024&emsp;&emsp;</div>
<div>1025&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>1026&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Modify the current record with the given data, and optionally replace</div>
<div>1027&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * the key.</div>
<div>1028&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1029&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param key The new key value for the BIN slot S to be updated. Cannot</div>
<div>1030&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * be partial. For a no-dups DB, it is null. For dups DBs it is a 2-part</div>
<div>1031&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * key combining the current primary key of slot S with the original,</div>
<div>1032&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * user-provided data. "key" (if not null) must compare equal to S.key</div>
<div>1033&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * (otherwise DuplicateDataException is thrown), but the 2 keys may not</div>
<div>1034&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * be identical if custom comparators are used. So, S.key will actually</div>
<div>1035&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * be replaced by "key".</div>
<div>1036&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1037&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param data The new data to (perhaps partially) replace the data of the</div>
<div>1038&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * LN associated with the BIN slot. For dups DBs it is EMPTY_DUPS_DATA.</div>
<div>1039&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Note: for dups DBs the original, user-provided "data" must not be</div>
<div>1040&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * partial.</div>
<div>1041&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1042&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param returnOldData To receive the old LN data (before the update).</div>
<div>1043&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * It is needed only by DBs with indexes/triggers; will be null otherwise.</div>
<div>1044&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1045&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param returnNewData To receive the full data of the updated LN.</div>
<div>1046&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * It is needed only by DBs with indexes/triggers and only if "data" is</div>
<div>1047&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * partial; will be null otherwise. Note: "returnNewData" may be different</div>
<div>1048&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * than "data" only if "data" is partial.</div>
<div>1049&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1050&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @return OperationResult, or null if an expired LN was purged and a</div>
<div>1051&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * partial 'data' param was supplied.</div>
<div>1052&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>1053&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public OperationResult updateCurrentRecord(</div>
<div>1054&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseEntry key,</div>
<div>1055&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseEntry data,</div>
<div>1056&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        ExpirationInfo expInfo,</div>
<div>1057&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseEntry returnOldData,</div>
<div>1058&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseEntry returnNewData,</div>
<div>1059&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        ReplicationContext repContext) {</div>
<div>1060&emsp;&emsp;</div>
<div style="background-color:limegreen;">1061&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert assertCursorState(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1062&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            true /*mustBeInitialized*/, false /*mustNotBeInitialized*/);</div>
<div>1063&emsp;&emsp;</div>
<div style="background-color:limegreen;">1064&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (returnOldData != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1065&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            returnOldData.setData(null);</div>
<div>1066&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div style="background-color:limegreen;">1067&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (returnNewData != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1068&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            returnNewData.setData(null);</div>
<div>1069&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1070&emsp;&emsp;</div>
<div>1071&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LockStanding lockStanding;</div>
<div>1072&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        OperationResult result = null;</div>
<div>1073&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean success = false;</div>
<div>1074&emsp;&emsp;</div>
<div>1075&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        latchBIN();</div>
<div>1076&emsp;&emsp;</div>
<div>1077&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>1078&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* Get a write lock. */</div>
<div>1079&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            lockStanding = lockLN(</div>
<div>1080&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                LockType.WRITE, true /*allowUncontended*/, false /*noWait*/);</div>
<div>1081&emsp;&emsp;</div>
<div style="background-color:limegreen;">1082&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (!lockStanding.recordExists()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1083&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                revertLock(lockStanding);</div>
<div>1084&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            } else {</div>
<div style="background-color:limegreen;">1085&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                result = updateRecordInternal(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1086&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    (key != null ? Key.makeKey(key) : null), data,</div>
<div>1087&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    expInfo, returnOldData, returnNewData,</div>
<div>1088&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    lockStanding, repContext);</div>
<div>1089&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1090&emsp;&emsp;</div>
<div>1091&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            success = true;</div>
<div>1092&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return result;</div>
<div>1093&emsp;&emsp;</div>
<div>1094&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div>1095&emsp;&emsp;</div>
<div style="background-color:limegreen;">1096&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (success &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">1097&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                !dbImpl.isInternalDb() &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1098&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin != null &&</div>
<div style="background-color:limegreen;">1099&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                bin.isBINDelta()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1100&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                dbImpl.getEnv().incBinDeltaUpdates();</div>
<div>1101&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1102&emsp;&emsp;</div>
<div>1103&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            releaseBIN();</div>
<div>1104&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1105&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>1106&emsp;&emsp;</div>
<div>1107&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>1108&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Insert the given record (key + LN) in the tree or return false if the</div>
<div>1109&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * key is already present.</div>
<div>1110&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1111&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The cursor must initially be uninitialized.</div>
<div>1112&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1113&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * This method is called directly internally for putting tree map LNs</div>
<div>1114&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * and file summary LNs.</div>
<div>1115&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>1116&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public boolean insertRecord(</div>
<div>1117&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        byte[] key,</div>
<div>1118&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        LN ln,</div>
<div>1119&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean blindInsertion,</div>
<div>1120&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        ReplicationContext repContext) {</div>
<div>1121&emsp;&emsp;</div>
<div style="background-color:limegreen;">1122&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert assertCursorState(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1123&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            false /*mustBeInitialized*/, true /*mustNotBeInitialized*/);</div>
<div style="background-color:limegreen;">1124&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (LatchSupport.TRACK_LATCHES) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1125&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            LatchSupport.expectBtreeLatchesHeld(0);</div>
<div>1126&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1127&emsp;&emsp;</div>
<div>1128&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>1129&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            final Pair&#60;LockStanding, OperationResult> result =</div>
<div>1130&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                insertRecordInternal(</div>
<div>1131&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    key, ln, null /*expirationInfo*/, blindInsertion,</div>
<div>1132&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    null /*returnNewData*/, repContext);</div>
<div>1133&emsp;&emsp;</div>
<div style="background-color:limegreen;">1134&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            return result.second() != null;&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1135&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div>1136&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            releaseBIN();</div>
<div>1137&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1138&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>1139&emsp;&emsp;</div>
<div>1140&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>1141&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Insert or update a given record. The method searches for the record</div>
<div>1142&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * using its key. It will perform an update if the record is found, </div>
<div>1143&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * otherwise an insertion.</div>
<div>1144&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1145&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The cursor must initially be uninitialized.</div>
<div>1146&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1147&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Called by all the Cursor.putXXX() ops, except putCurrent().</div>
<div>1148&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1149&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param key The new key value for the BIN slot S to be inserted/updated.</div>
<div>1150&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Cannot be partial. For dups DBs it is a 2-part key combining the</div>
<div>1151&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * original, user-provided key and data. In case of update, "key" must</div>
<div>1152&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * compare equal to S.key (otherwise DuplicateDataException is thrown),</div>
<div>1153&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * but the 2 keys may not be identical if custom comparators are used.</div>
<div>1154&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * So, S.key will actually be replaced by "key".</div>
<div>1155&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1156&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param data In case of update, the new data to (perhaps partially)</div>
<div>1157&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * replace the data of the LN associated with the BIN slot. For dups DBs</div>
<div>1158&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * it is EMPTY_DUPS_DATA. Note: for dups DBs the original, user-provided</div>
<div>1159&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * "data" must not be partial.</div>
<div>1160&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1161&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param ln is normally a new LN node that is created for insertion, and</div>
<div>1162&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * will be discarded if an update occurs.  However, HA will pass an</div>
<div>1163&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * existing node.</div>
<div>1164&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1165&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param putMode OVERWRITE or NO_OVERWRITE</div>
<div>1166&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1167&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param returnOldData To receive, in case of update, the old LN data</div>
<div>1168&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * (before the update). It is needed only by DBs with indexes/triggers;</div>
<div>1169&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * will be null otherwise.</div>
<div>1170&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1171&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param returnNewData To receive the full data of the new or updated LN.</div>
<div>1172&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * It is needed only by DBs with indexes/triggers and only if "data" is</div>
<div>1173&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * partial; will be null otherwise. Note: "returnNewData" may be different</div>
<div>1174&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * than "data" only if "data" is partial.</div>
<div>1175&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1176&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @return OperationResult where isUpdate() distinguishes insertions and</div>
<div>1177&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * updates. Is null only if an expired LN was purged and a partial 'data'</div>
<div>1178&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * param was supplied.</div>
<div>1179&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>1180&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public OperationResult insertOrUpdateRecord(</div>
<div>1181&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final DatabaseEntry key,</div>
<div>1182&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final DatabaseEntry data,</div>
<div>1183&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LN ln,</div>
<div>1184&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final ExpirationInfo expInfo,</div>
<div>1185&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final PutMode putMode,</div>
<div>1186&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final DatabaseEntry returnOldData,</div>
<div>1187&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final DatabaseEntry returnNewData,</div>
<div>1188&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final ReplicationContext repContext) {</div>
<div>1189&emsp;&emsp;</div>
<div>1190&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        assert key != null;</div>
<div style="background-color:limegreen;">1191&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert data != null;&nbsp;&#8594; [TRANSACTIONAL]</b></div>
<div style="background-color:limegreen;">1192&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert ln != null;&nbsp;&#8594; [TRANSACTIONAL] & [TRANSACTIONAL]</b></div>
<div style="background-color:limegreen;">1193&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert putMode != null;&nbsp;&#8594; [TRANSACTIONAL] & [TRANSACTIONAL]</b></div>
<div style="background-color:limegreen;">1194&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert assertCursorState(&nbsp;&#8594; [TRANSACTIONAL] & [TRANSACTIONAL]</b></div>
<div>1195&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            false /*mustBeInitialized*/, true /*mustNotBeInitialized*/);</div>
<div style="background-color:limegreen;">1196&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (LatchSupport.TRACK_LATCHES) {&nbsp;&#8594; [TRANSACTIONAL]</b></div>
<div>1197&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            LatchSupport.expectBtreeLatchesHeld(0);</div>
<div>1198&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1199&emsp;&emsp;</div>
<div style="background-color:limegreen;">1200&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (putMode != PutMode.OVERWRITE &&&nbsp;&#8594; [TRANSACTIONAL] & [TRANSACTIONAL]</b></div>
<div>1201&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            putMode != PutMode.NO_OVERWRITE) {</div>
<div>1202&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            throw EnvironmentFailureException.unexpectedState(</div>
<div>1203&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                putMode.toString());</div>
<div>1204&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1205&emsp;&emsp;</div>
<div>1206&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean success = false;</div>
<div>1207&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean inserted = false;</div>
<div>1208&emsp;&emsp;</div>
<div>1209&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        byte[] keyCopy = Key.makeKey(key);</div>
<div>1210&emsp;&emsp;</div>
<div>1211&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>1212&emsp;&emsp;</div>
<div>1213&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>1214&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Try to insert the key/data pair as a new record. Will succeed if</div>
<div>1215&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * the record does not exist in the DB already. Otherwise, the </div>
<div>1216&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * insertRecord() returns with the cursor registered on the slot</div>
<div>1217&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * whose key is equal to "key", with the LSN of that slot locked</div>
<div>1218&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * in WRITE mode, and with the containing BIN latched. </div>
<div>1219&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>1220&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            Pair&#60;LockStanding, OperationResult> insertResult =</div>
<div>1221&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                insertRecordInternal(</div>
<div>1222&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    keyCopy, ln, expInfo,</div>
<div>1223&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    false /*blindInsertion*/,</div>
<div>1224&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    returnNewData, repContext);</div>
<div>1225&emsp;&emsp;</div>
<div style="background-color:limegreen;">1226&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (insertResult.second() != null) {&nbsp;&#8594; [TRANSACTIONAL]</b></div>
<div>1227&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                inserted = true;</div>
<div>1228&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                success = true;</div>
<div>1229&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return insertResult.second();</div>
<div>1230&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1231&emsp;&emsp;</div>
<div>1232&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>1233&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * There is a non-defunct slot whose key is == "key". So, this is</div>
<div>1234&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * going to be an update. Note: Cursor has been registered on the</div>
<div>1235&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * existing slot by insertRecord()</div>
<div>1236&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div style="background-color:limegreen;">1237&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (putMode == PutMode.NO_OVERWRITE) {&nbsp;&#8594; [TRANSACTIONAL]</b></div>
<div>1238&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                success = true;</div>
<div>1239&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return null;</div>
<div>1240&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1241&emsp;&emsp;</div>
<div>1242&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>1243&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Update the non-defunct record at the cursor position. We have</div>
<div>1244&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * optimized by preferring to take an uncontended lock. The</div>
<div>1245&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * lockStanding var is guaranteed to be non-null in this case.</div>
<div>1246&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * The BIN must remain latched when calling this method.</div>
<div>1247&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>1248&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            final OperationResult result = updateRecordInternal(</div>
<div>1249&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                keyCopy, data, expInfo,</div>
<div>1250&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                returnOldData, returnNewData,</div>
<div>1251&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                insertResult.first(), repContext);</div>
<div>1252&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;       </div>
<div>1253&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            success = true;</div>
<div>1254&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return result;</div>
<div>1255&emsp;&emsp;</div>
<div>1256&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div>1257&emsp;&emsp;</div>
<div style="background-color:limegreen;">1258&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (success &&&nbsp;&#8594; [TRANSACTIONAL]</b></div>
<div style="background-color:limegreen;">1259&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                !dbImpl.isInternalDb() &&&nbsp;&#8594; [TRANSACTIONAL] & [TRANSACTIONAL] & [TRANSACTIONAL] & [TRANSACTIONAL] & [TRANSACTIONAL] & [TRANSACTIONAL] & [TRANSACTIONAL]</b></div>
<div>1260&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin != null &&</div>
<div style="background-color:limegreen;">1261&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                bin.isBINDelta()) {&nbsp;&#8594; [TRANSACTIONAL] & [TRANSACTIONAL]</b></div>
<div>1262&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (inserted) {</div>
<div>1263&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    dbImpl.getEnv().incBinDeltaInserts();</div>
<div>1264&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                } else {</div>
<div>1265&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    dbImpl.getEnv().incBinDeltaUpdates();</div>
<div>1266&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>1267&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1268&emsp;&emsp;</div>
<div>1269&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            releaseBIN();</div>
<div>1270&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1271&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>1272&emsp;&emsp;</div>
<div>1273&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>1274&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Try to insert the key/data pair as a new record. Will succeed if a</div>
<div>1275&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * non-defunct record does not exist already with the given key.</div>
<div>1276&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1277&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The cursor must initially be uninitialized.</div>
<div>1278&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1279&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * On return, this.bin is latched.</div>
<div>1280&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1281&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @return a non-null pair of LockStanding and OperationResult.</div>
<div>1282&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1283&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *   + LockStanding will be non-null if a slot with the given key already</div>
<div>1284&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *     exists, whether or not we reuse the slot for this record (i.e.,</div>
<div>1285&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *     whether or not the result is non-null). In other words, we always</div>
<div>1286&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *     lock the record in an existing slot for the give key.</div>
<div>1287&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1288&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *   + OperationResult will be non-null if we inserted a slot or reused a</div>
<div>1289&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *     slot having a defunct record, or null if the insertion failed</div>
<div>1290&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *     because a non-defunct record exists with the given key.</div>
<div>1291&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>1292&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private Pair&#60;LockStanding, OperationResult> insertRecordInternal(</div>
<div>1293&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final byte[] key,</div>
<div>1294&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LN ln,</div>
<div>1295&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        ExpirationInfo expInfo,</div>
<div>1296&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean blindInsertion,</div>
<div>1297&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final DatabaseEntry returnNewData,</div>
<div>1298&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final ReplicationContext repContext) {</div>
<div>1299&emsp;&emsp;</div>
<div>1300&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final EnvironmentImpl envImpl = dbImpl.getEnv();</div>
<div>1301&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final Tree tree = dbImpl.getTree();</div>
<div>1302&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        WriteLockInfo wli;</div>
<div>1303&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        LockStanding lockStanding = null;</div>
<div>1304&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean isSlotReuse;</div>
<div>1305&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final long currLsn;</div>
<div>1306&emsp;&emsp;</div>
<div>1307&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean currEmbeddedLN;</div>
<div>1308&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean newEmbeddedLN;</div>
<div>1309&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final byte[] data;</div>
<div>1310&emsp;&emsp;</div>
<div style="background-color:limegreen;">1311&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (shouldEmbedLN(ln.getData())) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1312&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            data = ln.getData();</div>
<div>1313&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            newEmbeddedLN = true;</div>
<div>1314&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</div>
<div>1315&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            newEmbeddedLN = false;</div>
<div>1316&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            data = null;</div>
<div>1317&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1318&emsp;&emsp;</div>
<div style="background-color:limegreen;">1319&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (expInfo == null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1320&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            expInfo = ExpirationInfo.DEFAULT;</div>
<div>1321&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1322&emsp;&emsp;</div>
<div>1323&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>1324&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * At this point, this cursor does not have a position so it cannot be</div>
<div>1325&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * registered with the BIN that will be used. This is good because it</div>
<div>1326&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * allows slot compression to occur before BIN splits (thus avoiding</div>
<div>1327&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * splits if compression finds and removes any defunct slots). However,</div>
<div>1328&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * if another cursor, including the one from which this was cloned, is</div>
<div>1329&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * registered with the BIN, then splits won't be allowed. This is a</div>
<div>1330&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * good reason to use non-sticky cursors for insertions, especially</div>
<div>1331&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * sequential insertions since they will often end up in the same BIN.</div>
<div>1332&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         *</div>
<div>1333&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Find and latch the BIN that should contain the "key". On return from</div>
<div>1334&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * the tree search, this.bin is latched, but "this" is still not</div>
<div>1335&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * registered.</div>
<div>1336&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>1337&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        bin = tree.findBinForInsert(key, getCacheMode());</div>
<div>1338&emsp;&emsp;</div>
<div>1339&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>1340&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * In the case where logging occurs before locking, allow lockers to</div>
<div>1341&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * reject the operation (e.g., if writing on a replica) and also</div>
<div>1342&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * prepare to undo in the (very unlikely) event that logging succeeds</div>
<div>1343&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * but locking fails. Call this method BEFORE slot insertion, in case</div>
<div>1344&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * it throws an exception which would leave the slot with a null LSN.</div>
<div>1345&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         *</div>
<div>1346&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * For Txn, creates the writeInfo map (if not done already), and</div>
<div>1347&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * inserts dbImpl in the undoDatabases map. Noop for other</div>
<div>1348&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * non-HA lockers.</div>
<div>1349&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>1350&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        locker.preLogWithoutLock(dbImpl);</div>
<div>1351&emsp;&emsp;</div>
<div>1352&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>1353&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * If the key exists already, insertEntry1() does not insert, but</div>
<div>1354&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * returns the index of the existing key.</div>
<div>1355&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         *</div>
<div>1356&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * If bin is a delta and it does not contain the key, then:</div>
<div>1357&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * (a) if blindInsertion is false, insertEntry1() will mutate it to a</div>
<div>1358&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * full BIN and check again if the key exists or not.</div>
<div>1359&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * (b) if blindInsertion is true, insertEntry1() will not mutate the</div>
<div>1360&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * delta; it will just insert the key into the delta. This is OK,</div>
<div>1361&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * because blindInsertion will be true only if we know already that the</div>
<div>1362&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * key does not exist in the tree.</div>
<div>1363&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>1364&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        int insertIndex = bin.insertEntry1(</div>
<div>1365&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            ln, key, data, DbLsn.NULL_LSN, blindInsertion);</div>
<div>1366&emsp;&emsp;</div>
<div style="background-color:limegreen;">1367&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if ((insertIndex & IN.INSERT_SUCCESS) == 0) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1368&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>1369&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Key exists. Insertion was not successful. Register the cursor on</div>
<div>1370&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * the existing slot. If the slot is defunct, the key does not</div>
<div>1371&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * really exist and the slot can be reused to do an insertion.</div>
<div>1372&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>1373&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            isSlotReuse = true;</div>
<div>1374&emsp;&emsp;</div>
<div>1375&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            setIndex(insertIndex);</div>
<div>1376&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            addCursor();</div>
<div>1377&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            setInitialized();</div>
<div>1378&emsp;&emsp;</div>
<div>1379&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>1380&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Lock the LSN for the existing LN slot, and check defunct-ness.</div>
<div>1381&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * An uncontended lock request is permitted because we are holding</div>
<div>1382&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * the bin latch. If no locker holds a lock on the slot, then no</div>
<div>1383&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * lock is taken by this cursor either.</div>
<div>1384&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>1385&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            lockStanding = lockLN(</div>
<div>1386&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                LockType.WRITE, true /*allowUncontended*/, false /*noWait*/);</div>
<div style="background-color:limegreen;">1387&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert(lockStanding != null);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1388&emsp;&emsp;</div>
<div style="background-color:limegreen;">1389&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (lockStanding.recordExists()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1390&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return new Pair&#60;>(lockStanding, null);</div>
<div>1391&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1392&emsp;&emsp;</div>
<div>1393&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>1394&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * The record in the current slot is defunct. Note: it may have</div>
<div>1395&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * been made defunct by this.locker itself.</div>
<div>1396&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>1397&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            currLsn = lockStanding.lsn;</div>
<div>1398&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            currEmbeddedLN = bin.isEmbeddedLN(index);</div>
<div>1399&emsp;&emsp;</div>
<div>1400&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>1401&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Create a new WriteLockInfo or get an existing one for the LSN</div>
<div>1402&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * of the current slot, and set its abortLSN and abortKD fields,</div>
<div>1403&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * if needed, i.e, if it is not the current txn the one who created</div>
<div>1404&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * this LSN. The abortLSN and abortKD fields of the wli will be</div>
<div>1405&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * included in the new logrec.</div>
<div>1406&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>1407&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            wli = lockStanding.prepareForUpdate(bin, index);</div>
<div>1408&emsp;&emsp;</div>
<div>1409&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</div>
<div>1410&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>1411&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Register the cursor at the slot that has been successfully</div>
<div>1412&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * inserted.</div>
<div>1413&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>1414&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            isSlotReuse = false;</div>
<div>1415&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            currEmbeddedLN = newEmbeddedLN;</div>
<div>1416&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            currLsn = DbLsn.NULL_LSN;</div>
<div>1417&emsp;&emsp;</div>
<div>1418&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            setIndex(insertIndex &= ~IN.INSERT_SUCCESS);</div>
<div>1419&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            addCursor();</div>
<div>1420&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            setInitialized();</div>
<div>1421&emsp;&emsp;</div>
<div>1422&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* Create a new WriteLockInfo */</div>
<div>1423&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            wli = LockStanding.prepareForInsert(bin);</div>
<div>1424&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1425&emsp;&emsp;</div>
<div>1426&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>1427&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Log the new LN and lock the LSN of the new logrec in WRITE mode.</div>
<div>1428&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Note: in case of slot reuse, we pass NULL_LSN for the oldLsn param</div>
<div>1429&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * because the old defunct LN is counted obsolete by other means.</div>
<div>1430&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>1431&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        LogItem logItem = null;</div>
<div>1432&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>1433&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            logItem = ln.optionalLog(</div>
<div>1434&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                envImpl, dbImpl, locker, wli,</div>
<div>1435&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                newEmbeddedLN, key,</div>
<div>1436&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                expInfo.expiration, expInfo.expirationInHours,</div>
<div>1437&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                currEmbeddedLN, currLsn, 0/*currSize*/,</div>
<div>1438&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                true/*isInsertion*/, repContext);</div>
<div>1439&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div style="background-color:limegreen;">1440&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (logItem == null && !isSlotReuse) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1441&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                /*</div>
<div>1442&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * Possible buffer overflow, out-of-memory, or I/O exception</div>
<div>1443&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * during logging. The BIN entry will contain a NULL_LSN. To</div>
<div>1444&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * prevent an exception during a future fetchLN() call, we</div>
<div>1445&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * set the KD flag. We do not call BIN.deleteEntry because it</div>
<div>1446&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * does not adjust cursors. We do not add this entry to the</div>
<div>1447&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * compressor queue to avoid complexity (this situation is</div>
<div>1448&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * rare).</div>
<div>1449&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 */</div>
<div>1450&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin.setKnownDeletedAndEvictLN(index);</div>
<div>1451&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1452&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1453&emsp;&emsp;</div>
<div style="background-color:limegreen;">1454&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert logItem != null;&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1455&emsp;&emsp;</div>
<div style="background-color:limegreen;">1456&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (lockStanding == null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1457&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>1458&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * No slot reuse; straight insertion. Update LSN in BIN slot.</div>
<div>1459&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * The LN is already in the slot.</div>
<div>1460&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>1461&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            bin.updateEntry(</div>
<div>1462&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                index, logItem.lsn, ln.getVLSNSequence(),</div>
<div>1463&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                logItem.size);</div>
<div>1464&emsp;&emsp;</div>
<div>1465&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            bin.setExpiration(</div>
<div>1466&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                index, expInfo.expiration, expInfo.expirationInHours);</div>
<div>1467&emsp;&emsp;</div>
<div>1468&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>1469&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * The following call accounts for extra marshaled memory, i.e.,</div>
<div>1470&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * memory that was added to the LN as a side-effect of logging it.</div>
<div>1471&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * This can happen for FileSummaryLN's only (it is a noop for</div>
<div>1472&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * other kinds of LNs).</div>
<div>1473&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             *</div>
<div>1474&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * To avoid violating assertions (e.g., in IN.changeMemorySize), we</div>
<div>1475&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * must must finish the memory adjustment while the BIN is still</div>
<div>1476&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * latched. [#20069]</div>
<div>1477&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             *</div>
<div>1478&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * This special handling does not apply to slot reuse, because the</div>
<div>1479&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * updateEntry() version used in the slot reuse case will recalc</div>
<div>1480&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * the BIN memory from scratch, and as a result, will take into</div>
<div>1481&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * account the extra marshaled memory. [#20845]</div>
<div>1482&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div style="background-color:limegreen;">1483&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (bin.getTarget(index) == ln) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1484&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                ln.addExtraMarshaledMemorySize(bin);</div>
<div>1485&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1486&emsp;&emsp;</div>
<div>1487&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</div>
<div>1488&emsp;&emsp;</div>
<div>1489&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>1490&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Slot reuse. When reusing a slot, the key is replaced in the BIN</div>
<div>1491&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * slot. This ensures that the correct key value is used when the</div>
<div>1492&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * new key is non-identical to the key in the slot but is</div>
<div>1493&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * considered equal by the btree comparator.</div>
<div>1494&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>1495&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            bin.insertRecord(</div>
<div>1496&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                index, ln, logItem.lsn, logItem.size, key, data,</div>
<div>1497&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                expInfo.expiration, expInfo.expirationInHours);</div>
<div>1498&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1499&emsp;&emsp;</div>
<div style="background-color:limegreen;">1500&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (returnNewData != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1501&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            returnNewData.setData(null);</div>
<div>1502&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            ln.setEntry(returnNewData);</div>
<div>1503&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1504&emsp;&emsp;</div>
<div>1505&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Cursor is positioned on new record. */</div>
<div>1506&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        setInitialized();</div>
<div>1507&emsp;&emsp;</div>
<div>1508&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Cache record version/size for insertion operation. */</div>
<div>1509&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        setCurrentVersion(ln.getVLSNSequence(), bin.getLsn(index));</div>
<div>1510&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        setStorageSize();</div>
<div>1511&emsp;&emsp;</div>
<div>1512&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>1513&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * It is desirable to evict the LN in a duplicates DB because it will</div>
<div>1514&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * never be fetched again. But for deferred-write DBs we should not</div>
<div>1515&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * evict a dirty LN since it may be logged unnecessarily.</div>
<div>1516&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div style="background-color:limegreen;">1517&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (dbImpl.getSortedDuplicates() &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">1518&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            !dbImpl.isDeferredWriteMode() &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">1519&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            bin.getTarget(index) != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1520&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            bin.evictLN(index);</div>
<div>1521&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1522&emsp;&emsp;</div>
<div>1523&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        traceInsert(Level.FINER, bin, logItem.lsn, index);</div>
<div>1524&emsp;&emsp;</div>
<div>1525&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return new Pair&#60;>(</div>
<div>1526&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            lockStanding,</div>
<div>1527&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            DbInternal.makeResult(</div>
<div>1528&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                expInfo.expiration, expInfo.expirationInHours));</div>
<div>1529&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>1530&emsp;&emsp;</div>
<div>1531&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>1532&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Update the record where the cursor is currently positioned at. The</div>
<div>1533&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * cursor is registered with this position, the associated bin is latched,</div>
<div>1534&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * the BIN slot is not defunct, and it has been locked in WRITE mode.</div>
<div>1535&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1536&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param returnOldData if non-null, will be filled in with the</div>
<div>1537&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * pre-existing record's data. However, if an expired LN was purged, it</div>
<div>1538&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * will not be filled in and the caller should expect this; see {@link</div>
<div>1539&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Cursor#putNotify}.</div>
<div>1540&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1541&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @return OperationResult, or null if an expired LN was purged and a</div>
<div>1542&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * partial 'data' param was supplied.</div>
<div>1543&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>1544&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private OperationResult updateRecordInternal(</div>
<div>1545&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final byte[] key,</div>
<div>1546&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final DatabaseEntry data,</div>
<div>1547&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final ExpirationInfo expInfo,</div>
<div>1548&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final DatabaseEntry returnOldData,</div>
<div>1549&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final DatabaseEntry returnNewData,</div>
<div>1550&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LockStanding lockStanding,</div>
<div>1551&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final ReplicationContext repContext) {</div>
<div>1552&emsp;&emsp;</div>
<div style="background-color:limegreen;">1553&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert(lockStanding.recordExists());&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1554&emsp;&emsp;</div>
<div>1555&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final EnvironmentImpl envImpl = dbImpl.getEnv();</div>
<div>1556&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final DbType dbType = dbImpl.getDbType();</div>
<div>1557&emsp;&emsp;</div>
<div>1558&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final long currLsn = lockStanding.lsn;</div>
<div style="background-color:limegreen;">1559&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert(currLsn != DbLsn.NULL_LSN);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1560&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final int currLoggedSize = bin.getLastLoggedSize(index);</div>
<div>1561&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final byte[] currKey = bin.getKey(index);</div>
<div>1562&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final byte[] currData;</div>
<div>1563&emsp;&emsp;</div>
<div>1564&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean currEmbeddedLN = bin.isEmbeddedLN(index);</div>
<div>1565&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean newEmbeddedLN;</div>
<div>1566&emsp;&emsp;</div>
<div>1567&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LogItem logItem;</div>
<div>1568&emsp;&emsp;</div>
<div>1569&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>1570&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Must fetch LN if it is not embedded and any of the following</div>
<div>1571&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * are true:</div>
<div>1572&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         *  - returnOldData is non-null: data needs to be returned</div>
<div>1573&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         *  - data is a partial entry: needs to be resolved</div>
<div>1574&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         *  - CLEANER_FETCH_OBSOLETE_SIZE is configured and lastLoggedSize</div>
<div>1575&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         *    is unknown</div>
<div>1576&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         *  - this database does not use the standard LN class and we</div>
<div>1577&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         *    cannot call DbType.createdUpdatedLN further below (this is</div>
<div>1578&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         *    the case for NameLNs, MapLNs, and FileSummaryLNs).</div>
<div>1579&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * For other cases, we are careful not to fetch, in order to avoid</div>
<div>1580&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * a random read during an update operation.</div>
<div>1581&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>1582&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        LN ln;</div>
<div style="background-color:limegreen;">1583&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (returnOldData != null ||&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">1584&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            data.getPartial() ||&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1585&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            (currLoggedSize == 0 &&</div>
<div>1586&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             !currEmbeddedLN &&</div>
<div style="background-color:limegreen;">1587&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>             envImpl.getCleaner().getFetchObsoleteSize(dbImpl)) ||&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">1588&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            !dbType.mayCreateUpdatedLN()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1589&emsp;&emsp;</div>
<div style="background-color:limegreen;">1590&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (currEmbeddedLN) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1591&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                currData = bin.getData(index);</div>
<div>1592&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                ln = bin.getLN(index, cacheMode);</div>
<div>1593&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            } else {</div>
<div>1594&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                ln = bin.fetchLN(index, cacheMode);</div>
<div style="background-color:limegreen;">1595&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                currData = (ln != null ? ln.getData() : null);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1596&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1597&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</div>
<div>1598&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            ln = bin.getLN(index, cacheMode);</div>
<div style="background-color:limegreen;">1599&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            currData = (ln != null ? ln.getData() : null);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1600&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1601&emsp;&emsp;</div>
<div>1602&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final byte[] newData;</div>
<div style="background-color:limegreen;">1603&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (data.getPartial()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">1604&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (currData == null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1605&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                /* Expired LN was purged. Cannot use a partial entry. */</div>
<div>1606&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return null;</div>
<div>1607&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1608&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            newData = LN.resolvePartialEntry(data, currData);</div>
<div>1609&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</div>
<div>1610&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            newData = LN.copyEntryData(data);</div>
<div>1611&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1612&emsp;&emsp;</div>
<div>1613&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>1614&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * If the key is changed (according to the comparator), we assume</div>
<div>1615&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * it is actually the data that has changed for a duplicate's DB.</div>
<div>1616&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div style="background-color:limegreen;">1617&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (key != null &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">1618&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            Key.compareKeys(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1619&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                currKey, key, dbImpl.getKeyComparator()) != 0) {</div>
<div>1620&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            throw new DuplicateDataException(</div>
<div>1621&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                "Can't replace a duplicate with new data that is not " +</div>
<div>1622&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                "equal to the existing data according to the duplicate " +</div>
<div>1623&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                " comparator.");</div>
<div>1624&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1625&emsp;&emsp;</div>
<div style="background-color:limegreen;">1626&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (returnOldData != null && currData != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1627&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            returnOldData.setData(null);</div>
<div>1628&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            LN.setEntry(returnOldData, currData);</div>
<div>1629&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1630&emsp;&emsp;</div>
<div>1631&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        newEmbeddedLN = shouldEmbedLN(newData);</div>
<div>1632&emsp;&emsp;</div>
<div>1633&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Update the existing LN, if cached, else create new LN. */</div>
<div>1634&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final long oldLNMemSize;</div>
<div style="background-color:limegreen;">1635&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (ln != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1636&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            oldLNMemSize = ln.getMemorySizeIncludedByParent();</div>
<div>1637&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            ln.modify(newData);</div>
<div>1638&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</div>
<div>1639&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            oldLNMemSize = 0;</div>
<div>1640&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            ln = dbType.createUpdatedLN(envImpl, newData);</div>
<div>1641&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1642&emsp;&emsp;</div>
<div>1643&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final int oldExpiration = bin.getExpiration(index);</div>
<div>1644&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean oldExpirationInHours = bin.isExpirationInHours();</div>
<div>1645&emsp;&emsp;</div>
<div style="background-color:limegreen;">1646&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (expInfo != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1647&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            expInfo.setOldExpirationTime(</div>
<div>1648&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                TTL.expirationToSystemTime(</div>
<div>1649&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    oldExpiration, oldExpirationInHours));</div>
<div>1650&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1651&emsp;&emsp;</div>
<div>1652&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final int expiration;</div>
<div>1653&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean expirationInHours;</div>
<div>1654&emsp;&emsp;</div>
<div style="background-color:limegreen;">1655&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (expInfo != null && expInfo.updateExpiration) {&nbsp;&#8594; [ALLOWCREATE, READONLY] & [ALLOWCREATE, READONLY]</b></div>
<div style="background-color:limegreen;">1656&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (expInfo.expiration != oldExpiration ||&nbsp;&#8594; [ALLOWCREATE, READONLY] & [ALLOWCREATE, READONLY]</b></div>
<div>1657&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                expInfo.expirationInHours != oldExpirationInHours) {</div>
<div>1658&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                expInfo.setExpirationUpdated(true);</div>
<div>1659&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1660&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            expiration = expInfo.expiration;</div>
<div>1661&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            expirationInHours = expInfo.expirationInHours;</div>
<div>1662&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</div>
<div>1663&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            expiration = oldExpiration;</div>
<div>1664&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            expirationInHours = oldExpirationInHours;</div>
<div>1665&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1666&emsp;&emsp;</div>
<div>1667&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>1668&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Create a new WriteLockInfo or get an existing one for the LSN</div>
<div>1669&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * of the current slot, and set its abortLSN and abortKD fields,</div>
<div>1670&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * if needed, i.e, if it is not the current txn the one who created</div>
<div>1671&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * this LSN. The abortLSN and abortKD fields of the wli will be</div>
<div>1672&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * included in the new logrec.</div>
<div>1673&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>1674&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final WriteLockInfo wli = lockStanding.prepareForUpdate(bin, index);</div>
<div>1675&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        </div>
<div>1676&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Log the new record version and lock its new LSN . */</div>
<div style="background-color:limegreen;">1677&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        logItem = ln.optionalLog(&nbsp;&#8594; [ALLOWCREATE, READONLY]</b></div>
<div>1678&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            envImpl, dbImpl, locker, wli,</div>
<div>1679&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            newEmbeddedLN, (key != null ? key : currKey),</div>
<div>1680&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            expiration, expirationInHours,</div>
<div>1681&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            currEmbeddedLN, currLsn, currLoggedSize,</div>
<div>1682&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            false/*isInsertion*/, repContext);</div>
<div>1683&emsp;&emsp;</div>
<div>1684&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Return a copy of resulting data, if requested. [#16932] */</div>
<div style="background-color:limegreen;">1685&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (returnNewData != null) {&nbsp;&#8594; [ALLOWCREATE, READONLY]</b></div>
<div>1686&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            returnNewData.setData(null);</div>
<div>1687&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            ln.setEntry(returnNewData);</div>
<div>1688&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1689&emsp;&emsp;</div>
<div>1690&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>1691&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Update the parent BIN. Update the key, if changed. [#15704]</div>
<div>1692&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>1693&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        bin.updateRecord(</div>
<div style="background-color:limegreen;">1694&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            index, oldLNMemSize, logItem.lsn, ln.getVLSNSequence(),&nbsp;&#8594; [ALLOWCREATE, READONLY]</b></div>
<div>1695&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            logItem.size, key, (newEmbeddedLN ? newData : null),</div>
<div>1696&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            expiration, expirationInHours);</div>
<div>1697&emsp;&emsp;</div>
<div>1698&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>1699&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * If the LN child is not cached, attach it to the tree if the DB</div>
<div>1700&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * is a DW one or if the record is not embedded in the BIN. For</div>
<div>1701&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * DW DBs, we must attach the LN even if the record in embedded,</div>
<div>1702&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * because no logrec was generated above, and as a result, the LN</div>
<div>1703&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * must be in the tree so that a logrec will be generated when</div>
<div>1704&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * a db.sync() occurs later (that logrec is needed for crash</div>
<div>1705&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * recovery, because BINs are not replayed during crash recovery).</div>
<div>1706&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         *</div>
<div>1707&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * If the LN child is cached, it is desirable to evict it if the</div>
<div>1708&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * record is embedded because it will never be fetched again.</div>
<div>1709&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * But for DW DBs we should not evict a dirty LN since it will</div>
<div>1710&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * be logged unnecessarily.</div>
<div>1711&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>1712&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean shouldCache =</div>
<div style="background-color:limegreen;">1713&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            (dbImpl.isDeferredWriteMode() ||&nbsp;&#8594; [ALLOWCREATE, READONLY]</b></div>
<div style="background-color:limegreen;">1714&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>             (!dbImpl.getSortedDuplicates() && !newEmbeddedLN));&nbsp;&#8594; [ALLOWCREATE, READONLY] & [ALLOWCREATE, READONLY]</b></div>
<div>1715&emsp;&emsp;</div>
<div style="background-color:limegreen;">1716&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (bin.getTarget(index) == null) {&nbsp;&#8594; [ALLOWCREATE, READONLY]</b></div>
<div style="background-color:limegreen;">1717&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (shouldCache) {&nbsp;&#8594; [ALLOWCREATE, READONLY]</b></div>
<div>1718&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin.attachNode(index, ln, null /*lnKey*/);</div>
<div>1719&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1720&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</div>
<div style="background-color:limegreen;">1721&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (!shouldCache) {&nbsp;&#8594; [ALLOWCREATE, READONLY]</b></div>
<div>1722&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin.evictLN(index);</div>
<div>1723&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1724&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1725&emsp;&emsp;</div>
<div>1726&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Cache record version/size for update operation. */</div>
<div>1727&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        setCurrentVersion(ln.getVLSNSequence(), logItem.lsn);</div>
<div>1728&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        setStorageSize();</div>
<div>1729&emsp;&emsp;</div>
<div>1730&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        trace(Level.FINER, TRACE_MOD, bin, index, currLsn, logItem.lsn);</div>
<div>1731&emsp;&emsp;</div>
<div>1732&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return DbInternal.makeUpdateResult(expiration, expirationInHours);</div>
<div>1733&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>1734&emsp;&emsp;</div>
<div>1735&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>1736&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Position the cursor at the first or last record of the dbImpl.</div>
<div>1737&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * It's okay if this record is defunct.</div>
<div>1738&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1739&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The cursor must initially be uninitialized.</div>
<div>1740&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1741&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Returns with the target BIN latched!</div>
<div>1742&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1743&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @return true if a first or last position is found, false if the</div>
<div>1744&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * tree being searched is empty.</div>
<div>1745&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>1746&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public boolean positionFirstOrLast(boolean first) {</div>
<div>1747&emsp;&emsp;</div>
<div style="background-color:limegreen;">1748&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert assertCursorState(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1749&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            false /*mustBeInitialized*/, true /*mustNotBeInitialized*/);</div>
<div>1750&emsp;&emsp;</div>
<div>1751&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean found = false;</div>
<div>1752&emsp;&emsp;</div>
<div>1753&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div style="background-color:limegreen;">1754&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (first) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1755&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin = dbImpl.getTree().getFirstNode(cacheMode);</div>
<div>1756&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            } else {</div>
<div>1757&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin = dbImpl.getTree().getLastNode(cacheMode);</div>
<div>1758&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1759&emsp;&emsp;</div>
<div style="background-color:limegreen;">1760&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (bin != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1761&emsp;&emsp;</div>
<div>1762&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                TreeWalkerStatsAccumulator treeStatsAccumulator =</div>
<div>1763&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    getTreeStatsAccumulator();</div>
<div>1764&emsp;&emsp;</div>
<div style="background-color:limegreen;">1765&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if (bin.getNEntries() == 0) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1766&emsp;&emsp;</div>
<div>1767&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    /*</div>
<div>1768&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * An IN was found. Even if it's empty, let Cursor</div>
<div>1769&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * handle moving to the first non-defunct entry.</div>
<div>1770&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     */</div>
<div>1771&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    found = true;</div>
<div>1772&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    index = -1;</div>
<div>1773&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                } else {</div>
<div style="background-color:limegreen;">1774&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    index = (first ? 0 : (bin.getNEntries() - 1));&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1775&emsp;&emsp;</div>
<div style="background-color:limegreen;">1776&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    if (treeStatsAccumulator != null &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">1777&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                        !bin.isEntryKnownDeleted(index) &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">1778&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                        !bin.isEntryPendingDeleted(index)) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1779&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        treeStatsAccumulator.incrementLNCount();</div>
<div>1780&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</div>
<div>1781&emsp;&emsp;</div>
<div>1782&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    /*</div>
<div>1783&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * Even if the entry is defunct, just leave our</div>
<div>1784&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * position here and return.</div>
<div>1785&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     */</div>
<div>1786&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    found = true;</div>
<div>1787&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>1788&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1789&emsp;&emsp;</div>
<div>1790&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            addCursor(bin);</div>
<div>1791&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            setInitialized();</div>
<div>1792&emsp;&emsp;</div>
<div>1793&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return found;</div>
<div>1794&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } catch (final Throwable e) {</div>
<div>1795&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* Release latch on error. */</div>
<div>1796&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            releaseBIN();</div>
<div>1797&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            throw e;</div>
<div>1798&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1799&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>1800&emsp;&emsp;</div>
<div>1801&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>1802&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Position this cursor on the slot whose key is the max key less or equal</div>
<div>1803&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * to the given search key.</div>
<div>1804&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1805&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * To be more precise, let K1 be search key. The method positions the</div>
<div>1806&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * cursor on the BIN that should contain K1. If the BIN does contain K1,</div>
<div>1807&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * this.index is set to the containing slot. Otherwise, this.index is</div>
<div>1808&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * set to the right-most slot whose key is &#60; K1, or to -1 if K1 is &#60; than</div>
<div>1809&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * all keys in the BIN.</div>
<div>1810&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1811&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The cursor must initially be uninitialized.</div>
<div>1812&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1813&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The method returns with the BIN latched, unless an exception is raised.</div>
<div>1814&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1815&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The method returns an integer that encodes the search outcome: If the</div>
<div>1816&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * FOUND bit is not set, the tree is completely empty (has no BINs). If</div>
<div>1817&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * the FOUND bit is set, the EXACT_KEY bit says whether K1 was found or</div>
<div>1818&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * not and the FOUND_LAST bit says whether the cursor is positioned to the</div>
<div>1819&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * very last slot of the BTree (note that this state can only be counted</div>
<div>1820&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * on as long as the BIN is latched). </div>
<div>1821&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1822&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Even if the search returns an exact result, the record may be defunct.</div>
<div>1823&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The caller must therefore check  whether the cursor is positioned on a</div>
<div>1824&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * defunct record.</div>
<div>1825&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1826&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * This method does not lock the record. The caller is expected to call</div>
<div>1827&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * lockAndGetCurrent to perform locking.</div>
<div>1828&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>1829&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public int searchRange(</div>
<div>1830&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseEntry searchKey,</div>
<div>1831&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        Comparator&#60;byte[]> comparator) {</div>
<div>1832&emsp;&emsp;</div>
<div style="background-color:limegreen;">1833&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert assertCursorState(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1834&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            false /*mustBeInitialized*/, true /*mustNotBeInitialized*/);</div>
<div>1835&emsp;&emsp;</div>
<div>1836&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean foundSomething = false;</div>
<div>1837&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean foundExactKey = false;</div>
<div>1838&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean foundLast = false;</div>
<div>1839&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        BINBoundary binBoundary = new BINBoundary();</div>
<div>1840&emsp;&emsp;</div>
<div>1841&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>1842&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            byte[] key = Key.makeKey(searchKey);</div>
<div>1843&emsp;&emsp;</div>
<div>1844&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            bin = dbImpl.getTree().search(</div>
<div>1845&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                key, Tree.SearchType.NORMAL, binBoundary, cacheMode,</div>
<div>1846&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                comparator);</div>
<div>1847&emsp;&emsp;</div>
<div style="background-color:limegreen;">1848&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (bin != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1849&emsp;&emsp;</div>
<div>1850&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                foundSomething = true;</div>
<div style="background-color:limegreen;">1851&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if (bin.isBINDelta() && comparator != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1852&emsp;&emsp;</div>
<div>1853&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    /*</div>
<div>1854&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * We must mutate a BIN delta if a non-null comparator is</div>
<div>1855&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * used. Otherwise, if we positioned the cursor on the</div>
<div>1856&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * delta using the non-null comparator, we would not be</div>
<div>1857&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * able to adjust its position correctly later when the</div>
<div>1858&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * delta gets mutated for some reason (because at that</div>
<div>1859&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * later time, the comparator used here would not be</div>
<div>1860&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * known).</div>
<div>1861&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     */</div>
<div>1862&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    bin.mutateToFullBIN(false /*leaveFreeSlot*/);</div>
<div>1863&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>1864&emsp;&emsp;</div>
<div>1865&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                index = bin.findEntry(</div>
<div>1866&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    key, true /*indicateIfExact*/, false/*exact*/, comparator);</div>
<div>1867&emsp;&emsp;</div>
<div style="background-color:limegreen;">1868&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if (bin.isBINDelta() &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1869&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    (index &#60; 0 ||</div>
<div>1870&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     (index & IN.EXACT_MATCH) == 0 ||</div>
<div>1871&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     binBoundary.isLastBin)) {</div>
<div>1872&emsp;&emsp;</div>
<div>1873&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    /*</div>
<div>1874&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * Note: if binBoundary.isLastBin, we must mutate the BIN</div>
<div>1875&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * in order to compute the foundLast flag below.</div>
<div>1876&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     */</div>
<div>1877&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    bin.mutateToFullBIN(false /*leaveFreeSlot*/);</div>
<div>1878&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    index = bin.findEntry(key, true, false, comparator);</div>
<div>1879&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>1880&emsp;&emsp;</div>
<div style="background-color:limegreen;">1881&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if (index >= 0) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">1882&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    if ((index & IN.EXACT_MATCH) != 0) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1883&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        foundExactKey = true;</div>
<div>1884&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        index &= ~IN.EXACT_MATCH;</div>
<div>1885&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</div>
<div>1886&emsp;&emsp;</div>
<div style="background-color:limegreen;">1887&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    foundLast = (binBoundary.isLastBin &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">1888&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                                 index == bin.getNEntries() - 1);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1889&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>1890&emsp;&emsp;</div>
<div>1891&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                /*</div>
<div>1892&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * Must call addCursor after mutateToFullBIN() to avoid having</div>
<div>1893&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * to reposition "this" inside mutateToFullBIN(), which would</div>
<div>1894&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * be both unnecessary and wrong given that this.index could</div>
<div>1895&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * have the IN.EXACT_MATCH still on.</div>
<div>1896&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 */</div>
<div>1897&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                addCursor(bin);</div>
<div>1898&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1899&emsp;&emsp;</div>
<div>1900&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            setInitialized();</div>
<div>1901&emsp;&emsp;</div>
<div>1902&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* Return a multi-part status value */</div>
<div style="background-color:limegreen;">1903&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            return ((foundSomething ? FOUND : 0) |&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1904&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    (foundExactKey ? EXACT_KEY : 0) |</div>
<div>1905&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    (foundLast ? FOUND_LAST : 0));</div>
<div>1906&emsp;&emsp;</div>
<div>1907&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } catch (final Throwable e) {</div>
<div>1908&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            releaseBIN();</div>
<div>1909&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            throw e;</div>
<div>1910&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1911&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>1912&emsp;&emsp;</div>
<div>1913&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public boolean searchExact(DatabaseEntry searchKey, LockType lockType) {</div>
<div style="background-color:limegreen;">1914&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        return searchExact(searchKey, lockType, false, false) != null;&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1915&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>1916&emsp;&emsp;</div>
<div>1917&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>1918&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Position this cursor on the slot (if any) whose key matches the given</div>
<div>1919&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * search key. If no such slot is found or the slot does not hold a "valid"</div>
<div>1920&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * record, return null. Otherwise, lock the found record with the specified</div>
<div>1921&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * lock type (which may be NONE) and return the LockStanding obj that was</div>
<div>1922&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * created by the locking op. Whether the slot contains a "valid" record or</div>
<div>1923&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * not depends on the slot's KD/PD flags and the lockType and dirtyReadAll</div>
<div>1924&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * parameters. Four cases are considered; they are described in the</div>
<div>1925&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * lockLNAndCheckDefunct() method.</div>
<div>1926&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1927&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The cursor must initially be uninitialized.</div>
<div>1928&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1929&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The method returns with the BIN latched, unless an exception is raised.</div>
<div>1930&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1931&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * In all cases, the method registers the cursor with the BIN that contains</div>
<div>1932&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * or should contain the search key.</div>
<div>1933&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>1934&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @return the LockStanding for the found record, or null if no record was</div>
<div>1935&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * found.</div>
<div>1936&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>1937&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public LockStanding searchExact(</div>
<div>1938&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final DatabaseEntry searchKey,</div>
<div>1939&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LockType lockType,</div>
<div>1940&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean dirtyReadAll,</div>
<div>1941&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean dataRequested) {</div>
<div>1942&emsp;&emsp;</div>
<div style="background-color:limegreen;">1943&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert assertCursorState(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1944&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            false /*mustBeInitialized*/, true /*mustNotBeInitialized*/);</div>
<div>1945&emsp;&emsp;</div>
<div>1946&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        LockStanding lockStanding = null;</div>
<div>1947&emsp;&emsp;</div>
<div>1948&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>1949&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            byte[] key = Key.makeKey(searchKey);</div>
<div>1950&emsp;&emsp;</div>
<div>1951&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            bin = dbImpl.getTree().search(key, cacheMode);</div>
<div>1952&emsp;&emsp;</div>
<div style="background-color:limegreen;">1953&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (bin != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1954&emsp;&emsp;</div>
<div>1955&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                index = bin.findEntry(key, false, true /*exact*/);</div>
<div>1956&emsp;&emsp;</div>
<div style="background-color:limegreen;">1957&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if (index &#60; 0 && bin.isBINDelta()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1958&emsp;&emsp;</div>
<div style="background-color:limegreen;">1959&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    if (bin.mayHaveKeyInFullBin(key)) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1960&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        bin.mutateToFullBIN(false /*leaveFreeSlot*/);</div>
<div>1961&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        index = bin.findEntry(key, false, true /*exact*/);</div>
<div>1962&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</div>
<div>1963&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>1964&emsp;&emsp;</div>
<div>1965&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                addCursor(bin);</div>
<div>1966&emsp;&emsp;</div>
<div style="background-color:limegreen;">1967&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if (index >= 0) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>1968&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    lockStanding = lockLNAndCheckDefunct(</div>
<div>1969&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        lockType, dirtyReadAll, dataRequested);</div>
<div>1970&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>1971&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>1972&emsp;&emsp;</div>
<div>1973&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            setInitialized();</div>
<div>1974&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return lockStanding;</div>
<div>1975&emsp;&emsp;</div>
<div>1976&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } catch (final Throwable e) {</div>
<div>1977&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* Release latch on error. */</div>
<div>1978&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            releaseBIN();</div>
<div>1979&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            throw e;</div>
<div>1980&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>1981&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>1982&emsp;&emsp;</div>
<div>1983&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>1984&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Lock and copy current record into the key and data DatabaseEntry.</div>
<div>1985&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * When calling this method, this.bin should not be latched already.</div>
<div>1986&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * On return, this.bin is unlatched.</div>
<div>1987&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>1988&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public OperationResult lockAndGetCurrent(</div>
<div>1989&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseEntry foundKey,</div>
<div>1990&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseEntry foundData,</div>
<div>1991&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LockType lockType) {</div>
<div>1992&emsp;&emsp;</div>
<div>1993&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return lockAndGetCurrent(</div>
<div>1994&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            foundKey, foundData, lockType, false, false, true);</div>
<div>1995&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>1996&emsp;&emsp;</div>
<div>1997&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>1998&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Let S be the slot where this cursor is currently positioned on. If S</div>
<div>1999&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * does not hold a "valid" record, return null. Otherwise, lock the</div>
<div>2000&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * record in S with the specified lock type(which may be NONE), copy its</div>
<div>2001&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * key and data into the key and data DatabaseEntries, and return SUCCESS.</div>
<div>2002&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Whether the slot contains a "valid" record or not depends on the slot's</div>
<div>2003&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * KD/PD flags, the lockType and dirtyReadAll parameters, and whether the</div>
<div>2004&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * record has expired. For details see {@link #lockLNAndCheckDefunct}.</div>
<div>2005&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2006&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * On entry, the isLatched param says whether this.bin is latched or not.</div>
<div>2007&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * On return, this.bin is unlatched if the unlatch param is true or an</div>
<div>2008&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * exception is thrown.</div>
<div>2009&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2010&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @return OperationResult, or null if the LN has been cleaned and cannot</div>
<div>2011&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * be fetched.</div>
<div>2012&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>2013&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public OperationResult lockAndGetCurrent(</div>
<div>2014&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseEntry foundKey,</div>
<div>2015&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseEntry foundData,</div>
<div>2016&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LockType lockType,</div>
<div>2017&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean dirtyReadAll,</div>
<div>2018&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean isLatched,</div>
<div>2019&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean unlatch) {</div>
<div>2020&emsp;&emsp;</div>
<div>2021&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Used in the finally to indicate whether exception was raised. */</div>
<div>2022&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean success = false;</div>
<div>2023&emsp;&emsp;</div>
<div>2024&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div style="background-color:limegreen;">2025&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert assertCursorState(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2026&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                true /*mustBeInitialized*/, false /*mustNotBeInitialized*/);</div>
<div>2027&emsp;&emsp;</div>
<div style="background-color:limegreen;">2028&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert checkAlreadyLatched(isLatched) : dumpToString(true);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2029&emsp;&emsp;</div>
<div style="background-color:limegreen;">2030&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (!isLatched) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2031&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                latchBIN();</div>
<div>2032&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2033&emsp;&emsp;</div>
<div style="background-color:limegreen;">2034&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert(bin.getCursorSet().contains(this));&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2035&emsp;&emsp;</div>
<div>2036&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            TreeWalkerStatsAccumulator treeStatsAccumulator =</div>
<div>2037&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                getTreeStatsAccumulator();</div>
<div>2038&emsp;&emsp;</div>
<div>2039&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>2040&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * If we encounter a deleted slot, opportunistically add the BIN</div>
<div>2041&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * to the compressor queue. We do not queue expired slots to avoid</div>
<div>2042&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * frequent compression, especially in the CRUD path; we rely</div>
<div>2043&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * instead on the evictor to perform expired slot compression.</div>
<div>2044&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div style="background-color:limegreen;">2045&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (index >= 0 &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">2046&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                index &#60; bin.getNEntries() &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">2047&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                bin.isDeleted(index)) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2048&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin.queueSlotDeletion(index);</div>
<div>2049&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2050&emsp;&emsp;</div>
<div>2051&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>2052&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Check the KD flag in the BIN slot and make sure this isn't an</div>
<div>2053&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * empty BIN. The BIN could be empty by virtue of the compressor</div>
<div>2054&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * running the size of this BIN to 0 but not having yet removed</div>
<div>2055&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * it from the tree.</div>
<div>2056&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             *</div>
<div>2057&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * The index may be negative if we're at an intermediate stage in</div>
<div>2058&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * an higher level operation (e.g., the starting search for a range</div>
<div>2059&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * scan op), and we expect a higher level method to do a next or</div>
<div>2060&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * prev operation after this returns KEYEMPTY. [#11700]</div>
<div>2061&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div style="background-color:limegreen;">2062&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (index &#60; 0 ||&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">2063&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                index >= bin.getNEntries() ||&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">2064&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                bin.isEntryKnownDeleted(index)) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2065&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                /* Node is no longer present. */</div>
<div style="background-color:limegreen;">2066&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if (treeStatsAccumulator != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2067&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    treeStatsAccumulator.incrementDeletedLNCount();</div>
<div>2068&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>2069&emsp;&emsp;</div>
<div>2070&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                success = true;</div>
<div>2071&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return null;</div>
<div>2072&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2073&emsp;&emsp;</div>
<div style="background-color:limegreen;">2074&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert TestHookExecute.doHookIfSet(testHook);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2075&emsp;&emsp;</div>
<div style="background-color:limegreen;">2076&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            final boolean dataRequested =&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2077&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                (foundData != null &&</div>
<div style="background-color:limegreen;">2078&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                (!foundData.getPartial() ||&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">2079&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                 foundData.getPartialLength() != 0));&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2080&emsp;&emsp;</div>
<div style="background-color:limegreen;">2081&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (lockLNAndCheckDefunct(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2082&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                lockType, dirtyReadAll, dataRequested) == null) {</div>
<div style="background-color:limegreen;">2083&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if (treeStatsAccumulator != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2084&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    treeStatsAccumulator.incrementDeletedLNCount();</div>
<div>2085&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>2086&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                success = true;</div>
<div>2087&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return null;</div>
<div>2088&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2089&emsp;&emsp;</div>
<div>2090&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            final OperationResult result = getCurrent(foundKey, foundData);</div>
<div>2091&emsp;&emsp;</div>
<div>2092&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            success = true;</div>
<div>2093&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return result;</div>
<div>2094&emsp;&emsp;</div>
<div>2095&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div style="background-color:limegreen;">2096&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (unlatch || !success) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2097&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                releaseBIN();</div>
<div>2098&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2099&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2100&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2101&emsp;&emsp;</div>
<div>2102&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>2103&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Let S be the slot where this cursor is currently positioned on. The</div>
<div>2104&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * method locks S (i.e. its LSN), and depending on S's KD/PD flags and</div>
<div>2105&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * expired status, it returns either null or the LockStanding obj that was</div>
<div>2106&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * created by the locking op. The following 4 cases are considered. By</div>
<div>2107&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * "defunct" below we mean S is KD/PD or expired.</div>
<div>2108&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2109&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * 1. If S is not defunct, return the LockStanding obj. In this case, we</div>
<div>2110&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * know that S holds a valid (non-defunct) record.</div>
<div>2111&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2112&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * 2. If S is defunct, and the lock type is not NONE, return null. In this</div>
<div>2113&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * case, we know that the record that used to be in S is definitely defunct.</div>
<div>2114&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2115&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * 3. If S is defunct, the lock kind is NONE, and dirtyReadAll is false,</div>
<div>2116&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * return null. This case corresponds to the READ_UNCOMMITTED LockMode.</div>
<div>2117&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The record in S is defunct, but the deleting txn may be active still,</div>
<div>2118&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * and if it aborts later, the record will be restored. To avoid a</div>
<div>2119&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * potentially blocking lock, in READ_UNCOMMITTED mode we consider the</div>
<div>2120&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * record to be non-existing and return null.</div>
<div>2121&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2122&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * 4. If S is defunct, the lock kind is NONE, and dirtyReadAll is true,</div>
<div>2123&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * lock the record in READ mode. This case corresponds to the</div>
<div>2124&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * READ_UNCOMMITTED_ALL LockMode, which requires that we do not skip</div>
<div>2125&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * "provisionally defunct" records. There are two sub-cases:</div>
<div>2126&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2127&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *  4a. If dataRequested is true, we wait until the deleting txn finishes.</div>
<div>2128&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *      In this case the READ lock is blocking. If after the lock is</div>
<div>2129&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *      granted S is still defunct, release the lock and return null.</div>
<div>2130&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *      Otherwise, release the lock and return the LockStanding obj.</div>
<div>2131&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2132&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *  4b. If dataRequested is false, then we check whether the deleting txn is</div>
<div>2133&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *      still open by requested a non-blocking READ lock. If the lock is</div>
<div>2134&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *      granted then the writing txn is closed or this cursor's locker is</div>
<div>2135&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *      the writer, and we proceed as if the READ lock was granted in 4a.</div>
<div>2136&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *      If the lock is denied then the deleting txn is still open, and we</div>
<div>2137&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *      return the LockStanding obj so that the record is not skipped.</div>
<div>2138&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2139&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The BIN must be latched on entry and is latched on exit.</div>
<div>2140&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2141&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param dirtyReadAll is true if using LockMode.READ_UNCOMMITTED_ALL.</div>
<div>2142&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2143&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param dataRequested is true if the read operation should return the</div>
<div>2144&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * record data, meaning that a blocking lock must be used for dirtyReadAll.</div>
<div>2145&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Is ignored if dirtyReadAll is false. Is always false for a dup DB,</div>
<div>2146&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * since data is never requested for dup DB ops at the CursorImpl level.</div>
<div>2147&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>2148&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private LockStanding lockLNAndCheckDefunct(</div>
<div>2149&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LockType lockType,</div>
<div>2150&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean dirtyReadAll,</div>
<div>2151&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean dataRequested) {</div>
<div>2152&emsp;&emsp;</div>
<div style="background-color:limegreen;">2153&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert !(dirtyReadAll && lockType != LockType.NONE);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">2154&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert !(dataRequested && dbImpl.getSortedDuplicates());&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2155&emsp;&emsp;</div>
<div>2156&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        LockStanding standing = lockLN(lockType);</div>
<div>2157&emsp;&emsp;</div>
<div style="background-color:limegreen;">2158&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (standing.recordExists()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2159&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return standing;</div>
<div>2160&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2161&emsp;&emsp;</div>
<div>2162&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* The slot is defunct. */</div>
<div>2163&emsp;&emsp;</div>
<div style="background-color:limegreen;">2164&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (lockType != LockType.NONE) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2165&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            revertLock(standing);</div>
<div>2166&emsp;&emsp;</div>
<div>2167&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>2168&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * The record was committed by another locker, or has been</div>
<div>2169&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * performed by this locker.</div>
<div>2170&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>2171&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return null;</div>
<div>2172&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2173&emsp;&emsp;</div>
<div>2174&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* We're using dirty-read.  The lockLN above did not actually lock. */</div>
<div>2175&emsp;&emsp;</div>
<div style="background-color:limegreen;">2176&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (!dirtyReadAll) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2177&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* READ_UNCOMMITTED -- skip defunct records without locking. */</div>
<div>2178&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return null;</div>
<div>2179&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2180&emsp;&emsp;</div>
<div>2181&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>2182&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * READ_UNCOMMITTED_ALL -- get a read lock. Whether we can request a</div>
<div>2183&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * no-wait or a blocking lock depends on the dataRequested parameter.</div>
<div>2184&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         *</div>
<div>2185&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Although there is some redundant processing in the sense that lockLN</div>
<div>2186&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * is called more than once (above and below), this is not considered a</div>
<div>2187&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * performance issue because accessing defunct records is normally</div>
<div>2188&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * infrequent. Deleted slots are normally compressed away quickly.</div>
<div>2189&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div style="background-color:limegreen;">2190&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        standing = lockLN(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2191&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            LockType.READ, false /*allowUncontended*/,</div>
<div>2192&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            !dataRequested /*noWait*/);</div>
<div>2193&emsp;&emsp;</div>
<div style="background-color:limegreen;">2194&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (standing.lockResult.getLockGrant() == LockGrantType.DENIED) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2195&emsp;&emsp;</div>
<div>2196&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>2197&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * The no-wait lock request was denied, which means the data is not</div>
<div>2198&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * needed and the writing transaction is still open. The defunct</div>
<div>2199&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * record should not be skipped in this case, according to the</div>
<div>2200&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * definition of READ_UNCOMMITTED_ALL.</div>
<div>2201&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div style="background-color:limegreen;">2202&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert !standing.recordExists();&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2203&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return standing;</div>
<div>2204&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2205&emsp;&emsp;</div>
<div>2206&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* We have acquired a temporary read lock. */</div>
<div>2207&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        revertLock(standing);</div>
<div>2208&emsp;&emsp;</div>
<div style="background-color:limegreen;">2209&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (standing.recordExists()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2210&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>2211&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Another txn aborted the deletion or expiration time change while</div>
<div>2212&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * we waited.</div>
<div>2213&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>2214&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return standing;</div>
<div>2215&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2216&emsp;&emsp;</div>
<div>2217&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>2218&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * The write was committed by another locker, or has been performed by</div>
<div>2219&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * this locker.</div>
<div>2220&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>2221&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return null;</div>
<div>2222&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2223&emsp;&emsp;</div>
<div>2224&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>2225&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Copy current record into the key and data DatabaseEntry.</div>
<div>2226&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2227&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @return OperationResult, or null if the LN has been cleaned and cannot</div>
<div>2228&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * be fetched.</div>
<div>2229&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>2230&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public OperationResult getCurrent(</div>
<div>2231&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final DatabaseEntry foundKey,</div>
<div>2232&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final DatabaseEntry foundData) {</div>
<div>2233&emsp;&emsp;</div>
<div style="background-color:limegreen;">2234&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert(bin.isLatchExclusiveOwner());&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">2235&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert(index >= 0 && index &#60; bin.getNEntries());&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">2236&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert(!bin.isEntryKnownDeleted(index));&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2237&emsp;&emsp;</div>
<div>2238&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>2239&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * We don't need to fetch the LN if the user has not requested that we</div>
<div>2240&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * return the data, or if we know for sure that the LN is empty.</div>
<div>2241&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>2242&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean isEmptyLN = dbImpl.isLNImmediatelyObsolete();</div>
<div>2243&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean isEmbeddedLN = bin.isEmbeddedLN(index);</div>
<div>2244&emsp;&emsp;</div>
<div style="background-color:limegreen;">2245&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        final boolean dataRequested = &nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2246&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            (foundData != null &&</div>
<div style="background-color:limegreen;">2247&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>             (!foundData.getPartial() || foundData.getPartialLength() != 0));&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2248&emsp;&emsp;</div>
<div>2249&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LN ln;</div>
<div style="background-color:limegreen;">2250&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (!isEmptyLN && !isEmbeddedLN && dataRequested) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2251&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            ln = bin.fetchLN(index, cacheMode);</div>
<div style="background-color:limegreen;">2252&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (ln == null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2253&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                /* An expired LN was purged. */</div>
<div>2254&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return null;</div>
<div>2255&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2256&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</div>
<div>2257&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            ln = null;</div>
<div>2258&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2259&emsp;&emsp;</div>
<div>2260&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Return the data. */</div>
<div style="background-color:limegreen;">2261&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (dataRequested) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2262&emsp;&emsp;</div>
<div>2263&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            byte[] data;</div>
<div>2264&emsp;&emsp;</div>
<div style="background-color:limegreen;">2265&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (ln != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2266&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                data = ln.getData();</div>
<div style="background-color:limegreen;">2267&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            } else if (isEmptyLN || bin.isNoDataLN(index)) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2268&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                data = LogUtils.ZERO_LENGTH_BYTE_ARRAY;</div>
<div>2269&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            } else {</div>
<div style="background-color:limegreen;">2270&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                assert(isEmbeddedLN);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2271&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                data = bin.getData(index);</div>
<div>2272&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2273&emsp;&emsp;</div>
<div>2274&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            LN.setEntry(foundData, data);</div>
<div>2275&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2276&emsp;&emsp;</div>
<div>2277&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Return the key */</div>
<div style="background-color:limegreen;">2278&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (foundKey != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2279&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            LN.setEntry(foundKey, bin.getKey(index));</div>
<div>2280&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2281&emsp;&emsp;</div>
<div>2282&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Cache record version/size for fetch operation. */</div>
<div style="background-color:limegreen;">2283&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        final long vlsn = (ln != null ?&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2284&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                           ln.getVLSNSequence() :</div>
<div>2285&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                           bin.getVLSN(index, false /*allowFetch*/, cacheMode));</div>
<div>2286&emsp;&emsp;</div>
<div>2287&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        setCurrentVersion(vlsn, bin.getLsn(index));</div>
<div>2288&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        setStorageSize();</div>
<div>2289&emsp;&emsp;</div>
<div>2290&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return DbInternal.makeResult(</div>
<div>2291&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            bin.getExpiration(index), bin.isExpirationInHours());</div>
<div>2292&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2293&emsp;&emsp;</div>
<div>2294&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public LN getCurrentLN(final boolean isLatched, final boolean unlatch) {</div>
<div>2295&emsp;&emsp;</div>
<div>2296&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Used in the finally to indicate whether exception was raised. */</div>
<div>2297&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean success = false;</div>
<div>2298&emsp;&emsp;</div>
<div>2299&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div style="background-color:limegreen;">2300&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert assertCursorState(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2301&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                true /*mustBeInitialized*/, false /*mustNotBeInitialized*/);</div>
<div style="background-color:limegreen;">2302&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert checkAlreadyLatched(isLatched) : dumpToString(true);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2303&emsp;&emsp;</div>
<div style="background-color:limegreen;">2304&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (!isLatched) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2305&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                latchBIN();</div>
<div>2306&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2307&emsp;&emsp;</div>
<div style="background-color:limegreen;">2308&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert(bin.getCursorSet().contains(this));&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">2309&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert(!bin.isEmbeddedLN(index));&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2310&emsp;&emsp;</div>
<div>2311&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            LN ln = bin.fetchLN(index, cacheMode);</div>
<div>2312&emsp;&emsp;</div>
<div>2313&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            success = true;</div>
<div>2314&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return ln;</div>
<div>2315&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div style="background-color:limegreen;">2316&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (unlatch || !success) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2317&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                releaseBIN();</div>
<div>2318&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2319&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2320&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2321&emsp;&emsp;</div>
<div>2322&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>2323&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Retrieve the current LN. BIN is unlatched on entry and exit.</div>
<div>2324&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>2325&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public LN lockAndGetCurrentLN(final LockType lockType) {</div>
<div>2326&emsp;&emsp;</div>
<div>2327&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div style="background-color:limegreen;">2328&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert assertCursorState(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2329&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                true /*mustBeInitialized*/, false /*mustNotBeInitialized*/);</div>
<div style="background-color:limegreen;">2330&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert checkAlreadyLatched(false) : dumpToString(true);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2331&emsp;&emsp;</div>
<div>2332&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            latchBIN();</div>
<div>2333&emsp;&emsp;</div>
<div style="background-color:limegreen;">2334&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert(bin.getCursorSet().contains(this));&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2335&emsp;&emsp;</div>
<div>2336&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            LockStanding lockStanding = lockLN(lockType);</div>
<div>2337&emsp;&emsp;</div>
<div style="background-color:limegreen;">2338&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (!lockStanding.recordExists()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2339&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                revertLock(lockStanding);</div>
<div>2340&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return null;</div>
<div>2341&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2342&emsp;&emsp;</div>
<div style="background-color:limegreen;">2343&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert(!bin.isEmbeddedLN(index));&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2344&emsp;&emsp;</div>
<div>2345&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return bin.fetchLN(index, cacheMode);</div>
<div>2346&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div>2347&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            releaseBIN();</div>
<div>2348&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2349&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2350&emsp;&emsp;</div>
<div>2351&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>2352&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Returns the VLSN and LSN for the record at the current position.  Must</div>
<div>2353&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * be called when the cursor is positioned on a record.</div>
<div>2354&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2355&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * If this method is called on a secondary cursor, the version of the</div>
<div>2356&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * associated primary record is returned.  In that case, the allowFetch</div>
<div>2357&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * parameter is ignored, and the version is available only if the primary</div>
<div>2358&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * record was retrieved (see setSecondaryCurrentVersion).</div>
<div>2359&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2360&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param allowFetch is true to fetch the LN to get the VLSN, or false to</div>
<div>2361&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * return -1 for the VLSN if both the LN and VLSN are not cached.</div>
<div>2362&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2363&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @throws IllegalStateException if the cursor is closed or uninitialized,</div>
<div>2364&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * or this is a secondary cursor and the version is not cached.</div>
<div>2365&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>2366&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public RecordVersion getCurrentVersion(boolean allowFetch) {</div>
<div>2367&emsp;&emsp;</div>
<div>2368&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Ensure cursor is open and initialized. */</div>
<div>2369&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        checkCursorState(</div>
<div>2370&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            true /*mustBeInitialized*/, false /*mustNotBeInitialized*/);</div>
<div>2371&emsp;&emsp;</div>
<div>2372&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>2373&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * For a secondary cursor, the cached version is all we have.</div>
<div>2374&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * See setSecondaryCurrentVersion.</div>
<div>2375&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>2376&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (isSecondaryCursor) {</div>
<div>2377&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (currentRecordVersion == null) {</div>
<div>2378&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                throw new IllegalStateException(</div>
<div>2379&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    "Record version is available via a SecondaryCursor only " +</div>
<div>2380&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    "if the associated primary record was retrieved.");</div>
<div>2381&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2382&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return currentRecordVersion;</div>
<div>2383&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2384&emsp;&emsp;</div>
<div>2385&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>2386&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Use cached version if available.  Do not use cached version if it</div>
<div>2387&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * does not contain a VLSN, and VLSNs are preserved, and fetching is</div>
<div>2388&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * allowed; instead, try to fetch it below.</div>
<div>2389&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>2390&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (currentRecordVersion != null) {</div>
<div>2391&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if ((currentRecordVersion.getVLSN() !=</div>
<div>2392&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 VLSN.NULL_VLSN_SEQUENCE) ||</div>
<div>2393&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                !allowFetch ||</div>
<div>2394&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                !dbImpl.getEnv().getPreserveVLSN()) {</div>
<div>2395&emsp;&emsp;</div>
<div>2396&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return currentRecordVersion;</div>
<div>2397&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2398&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2399&emsp;&emsp;</div>
<div>2400&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Get the VLSN from the BIN, create the version and cache it. */</div>
<div>2401&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        latchBIN();</div>
<div>2402&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>2403&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            setCurrentVersion(</div>
<div>2404&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin.getVLSN(index, allowFetch, cacheMode), bin.getLsn(index));</div>
<div>2405&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div>2406&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            releaseBIN();</div>
<div>2407&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2408&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return currentRecordVersion;</div>
<div>2409&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2410&emsp;&emsp;</div>
<div>2411&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void setCurrentVersion(long vlsn, long lsn) {</div>
<div>2412&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        currentRecordVersion = new RecordVersion(vlsn, lsn);</div>
<div>2413&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2414&emsp;&emsp;</div>
<div>2415&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>2416&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Returns the estimated disk storage size for the record at the current</div>
<div>2417&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * position. This method does not fetch the LN. Must be called when the</div>
<div>2418&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * cursor is positioned on a record.</div>
<div>2419&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2420&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * When called on a secondary cursor that was used to return the primary</div>
<div>2421&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * data, the size of the primary record is returned by this method.</div>
<div>2422&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Otherwise the size of the record at this cursor position is returned.</div>
<div>2423&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2424&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @return the estimated storage size, or zero when the size is unknown</div>
<div>2425&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * because a non-embedded LN is not resident and the LN was logged with a</div>
<div>2426&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * JE version prior to 6.0.</div>
<div>2427&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2428&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @throws IllegalStateException if the cursor is closed or uninitialized.</div>
<div>2429&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2430&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @see StorageSize</div>
<div>2431&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>2432&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public int getStorageSize() {</div>
<div>2433&emsp;&emsp;</div>
<div>2434&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        assert assertCursorState(</div>
<div>2435&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            true /*mustBeInitialized*/, false /*mustNotBeInitialized*/);</div>
<div>2436&emsp;&emsp;</div>
<div>2437&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return (priStorageSize > 0) ? priStorageSize : storageSize;</div>
<div>2438&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2439&emsp;&emsp;</div>
<div>2440&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void setStorageSize() {</div>
<div>2441&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        storageSize = StorageSize.getStorageSize(bin, index);</div>
<div>2442&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2443&emsp;&emsp;</div>
<div>2444&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>2445&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * When the primary record is read during a secondary operation, this</div>
<div>2446&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * method is called to copy the primary version and storage size here.</div>
<div>2447&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * This allows the secondary cursor API to return the version and size of</div>
<div>2448&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * the primary record. Note that a secondary record does not have a version</div>
<div>2449&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * of its own.</div>
<div>2450&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2451&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param sourceCursor contains the primary info, but may be a primary or</div>
<div>2452&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * secondary cursor.</div>
<div>2453&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>2454&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void setPriInfo(final CursorImpl sourceCursor) {</div>
<div>2455&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        currentRecordVersion = sourceCursor.currentRecordVersion;</div>
<div>2456&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        priStorageSize = sourceCursor.storageSize;</div>
<div>2457&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2458&emsp;&emsp;</div>
<div>2459&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>2460&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Returns the number of secondary records written by the last put/delete</div>
<div>2461&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * operation at the current cursor position.</div>
<div>2462&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2463&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * NOTE: this method does not work (returns 0) if primary deletions are</div>
<div>2464&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * performed via a secondary (SecondaryDatabase/SecondaryCursor.delete).</div>
<div>2465&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2466&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @return number of writes, or zero if a put/delete operation was not</div>
<div>2467&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * performed.</div>
<div>2468&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>2469&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public int getNSecondaryWrites() {</div>
<div>2470&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return nSecWrites;</div>
<div>2471&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2472&emsp;&emsp;</div>
<div>2473&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void setNSecondaryWrites(final int nWrites) {</div>
<div>2474&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        nSecWrites = nWrites;</div>
<div>2475&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2476&emsp;&emsp;</div>
<div>2477&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>2478&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Advance a cursor.  Used so that verify can advance a cursor even in the</div>
<div>2479&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * face of an exception [12932].</div>
<div>2480&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param key on return contains the key if available, or null.</div>
<div>2481&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param data on return contains the data if available, or null.</div>
<div>2482&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>2483&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public boolean advanceCursor(DatabaseEntry key, DatabaseEntry data) {</div>
<div>2484&emsp;&emsp;</div>
<div>2485&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        BIN oldBin = bin;</div>
<div>2486&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        int oldIndex = index;</div>
<div>2487&emsp;&emsp;</div>
<div>2488&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        key.setData(null);</div>
<div>2489&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        data.setData(null);</div>
<div>2490&emsp;&emsp;</div>
<div>2491&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>2492&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            getNext(</div>
<div>2493&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                key, data, LockType.NONE, false /*dirtyReadAll*/,</div>
<div>2494&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                true /*forward*/, false /*isLatched*/,</div>
<div>2495&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                null /*rangeConstraint*/);</div>
<div>2496&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } catch (DatabaseException ignored) {</div>
<div>2497&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* Klockwork - ok */</div>
<div>2498&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2499&emsp;&emsp;</div>
<div>2500&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>2501&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * If the position changed, regardless of an exception, then we believe</div>
<div>2502&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * that we have advanced the cursor.</div>
<div>2503&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>2504&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (bin != oldBin || index != oldIndex) {</div>
<div>2505&emsp;&emsp;</div>
<div>2506&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>2507&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Return the key and data from the BIN entries, if we were not</div>
<div>2508&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * able to read it above.</div>
<div>2509&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>2510&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (key.getData() == null && bin != null && index > 0) {</div>
<div>2511&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                LN.setEntry(key, bin.getKey(index));</div>
<div>2512&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2513&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return true;</div>
<div>2514&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</div>
<div>2515&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return false;</div>
<div>2516&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2517&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2518&emsp;&emsp;</div>
<div>2519&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>2520&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Move the cursor forward and return the next "valid" record. Whether a</div>
<div>2521&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * slot contains a "valid" record or not depends on the slot's KD/PD flags</div>
<div>2522&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * and the lockType and dirtyReadAll parameters. Four cases are considered;</div>
<div>2523&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * they are described in the lockLNAndCheckDefunct() method.</div>
<div>2524&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2525&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * This will cross BIN boundaries. On return, no latches are held. If no</div>
<div>2526&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * exceptions, the cursor is registered with its new location.</div>
<div>2527&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2528&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param foundKey DatabaseEntry to use for returning key</div>
<div>2529&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2530&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param foundData DatabaseEntry to use for returning data</div>
<div>2531&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2532&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param forward if true, move forward, else move backwards</div>
<div>2533&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2534&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param isLatched if true, the bin that we're on is already</div>
<div>2535&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * latched.</div>
<div>2536&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2537&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param rangeConstraint if non-null, is called to determine whether a key</div>
<div>2538&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * is out of range.</div>
<div>2539&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>2540&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public OperationResult getNext(</div>
<div>2541&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseEntry foundKey,</div>
<div>2542&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseEntry foundData,</div>
<div>2543&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        LockType lockType,</div>
<div>2544&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean dirtyReadAll,</div>
<div>2545&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean forward,</div>
<div>2546&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean isLatched,</div>
<div>2547&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        RangeConstraint rangeConstraint) {</div>
<div>2548&emsp;&emsp;</div>
<div style="background-color:limegreen;">2549&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert assertCursorState(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2550&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            true /*mustBeInitialized*/, false /*mustNotBeInitialized*/);</div>
<div>2551&emsp;&emsp;</div>
<div style="background-color:limegreen;">2552&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert checkAlreadyLatched(isLatched) : dumpToString(true);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2553&emsp;&emsp;</div>
<div>2554&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        OperationResult result = null;</div>
<div>2555&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        BIN anchorBIN = null;</div>
<div>2556&emsp;&emsp;</div>
<div>2557&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div style="background-color:limegreen;">2558&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            while (bin != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2559&emsp;&emsp;</div>
<div style="background-color:limegreen;">2560&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                assert checkAlreadyLatched(isLatched) : dumpToString(true);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2561&emsp;&emsp;</div>
<div style="background-color:limegreen;">2562&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if (!isLatched) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2563&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    latchBIN();</div>
<div>2564&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    isLatched = true;</div>
<div>2565&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>2566&emsp;&emsp;</div>
<div>2567&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (DEBUG) {</div>
<div>2568&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    verifyCursor(bin);</div>
<div>2569&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>2570&emsp;&emsp;</div>
<div>2571&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin.mutateToFullBIN(false /*leaveFreeSlot*/);</div>
<div>2572&emsp;&emsp;</div>
<div>2573&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                /* Is there anything left on this BIN? */</div>
<div style="background-color:limegreen;">2574&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if ((forward && ++index &#60; bin.getNEntries()) ||&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2575&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    (!forward && --index > -1)) {</div>
<div>2576&emsp;&emsp;</div>
<div style="background-color:limegreen;">2577&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    if (rangeConstraint != null &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">2578&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                        !rangeConstraint.inBounds(bin.getKey(index))) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2579&emsp;&emsp;</div>
<div>2580&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        result = null;</div>
<div>2581&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        releaseBIN();</div>
<div>2582&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        break;</div>
<div>2583&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</div>
<div>2584&emsp;&emsp;</div>
<div>2585&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    OperationResult ret = lockAndGetCurrent(</div>
<div>2586&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        foundKey, foundData, lockType, dirtyReadAll,</div>
<div>2587&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        true /*isLatched*/, false /*unlatch*/);</div>
<div>2588&emsp;&emsp;</div>
<div style="background-color:limegreen;">2589&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    if (LatchSupport.TRACK_LATCHES) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2590&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        LatchSupport.expectBtreeLatchesHeld(1);</div>
<div>2591&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</div>
<div>2592&emsp;&emsp;</div>
<div style="background-color:limegreen;">2593&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    if (ret != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2594&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        incrementLNCount();</div>
<div>2595&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        releaseBIN();</div>
<div>2596&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        result = ret;</div>
<div>2597&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        break;</div>
<div>2598&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</div>
<div>2599&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                } else {</div>
<div>2600&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    /*</div>
<div>2601&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * Make sure that the current BIN will not be pruned away</div>
<div>2602&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * if it is or becomes empty after it gets unlatched by</div>
<div>2603&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * Tree.getNextBin() or Tree.getPrevBin(). The operation</div>
<div>2604&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * of these Tree methods relies on the current BIN not</div>
<div>2605&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * getting pruned. </div>
<div>2606&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     */</div>
<div>2607&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    anchorBIN = bin;</div>
<div>2608&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    anchorBIN.pin();</div>
<div>2609&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    bin.removeCursor(this);</div>
<div>2610&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    bin = null;</div>
<div>2611&emsp;&emsp;</div>
<div>2612&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    final Tree tree = dbImpl.getTree();</div>
<div>2613&emsp;&emsp;</div>
<div>2614&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    /* SR #12736 Try to prune away oldBin */</div>
<div style="background-color:limegreen;">2615&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    assert TestHookExecute.doHookIfSet(testHook);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2616&emsp;&emsp;</div>
<div style="background-color:limegreen;">2617&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    if (forward) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2618&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        bin = tree.getNextBin(anchorBIN, cacheMode);</div>
<div>2619&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        index = -1;</div>
<div>2620&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    } else {</div>
<div>2621&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        bin = tree.getPrevBin(anchorBIN, cacheMode);</div>
<div style="background-color:limegreen;">2622&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                        if (bin != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2623&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            index = bin.getNEntries();</div>
<div>2624&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</div>
<div>2625&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</div>
<div>2626&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    isLatched = true;</div>
<div>2627&emsp;&emsp;</div>
<div style="background-color:limegreen;">2628&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    if (bin == null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">2629&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                        if (LatchSupport.TRACK_LATCHES) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2630&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            LatchSupport.expectBtreeLatchesHeld(0);</div>
<div>2631&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</div>
<div>2632&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        result = null;</div>
<div>2633&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        break;</div>
<div>2634&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    } else {</div>
<div style="background-color:limegreen;">2635&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                        if (LatchSupport.TRACK_LATCHES) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2636&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            LatchSupport.expectBtreeLatchesHeld(1);</div>
<div>2637&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</div>
<div>2638&emsp;&emsp;</div>
<div>2639&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        addCursor();</div>
<div>2640&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        anchorBIN.unpin();</div>
<div>2641&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        anchorBIN = null;</div>
<div>2642&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</div>
<div>2643&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>2644&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2645&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div style="background-color:limegreen;">2646&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (anchorBIN != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2647&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                anchorBIN.unpin();</div>
<div>2648&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2649&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2650&emsp;&emsp;</div>
<div style="background-color:limegreen;">2651&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (LatchSupport.TRACK_LATCHES) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2652&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            LatchSupport.expectBtreeLatchesHeld(0);</div>
<div>2653&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2654&emsp;&emsp;</div>
<div>2655&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return result;</div>
<div>2656&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2657&emsp;&emsp;</div>
<div>2658&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>2659&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Used to detect phantoms during "get next" operations with serializable</div>
<div>2660&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * isolation.  If this method returns true, the caller should restart the</div>
<div>2661&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * operation from the prior position.</div>
<div>2662&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2663&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Something may have been added to the original cursor (cursorImpl) while</div>
<div>2664&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * we were getting the next BIN.  cursorImpl would have been adjusted</div>
<div>2665&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * properly but we would have skipped a BIN in the process.  This can</div>
<div>2666&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * happen when all INs are unlatched in Tree.getNextBin.  It can also</div>
<div>2667&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * happen without a split, simply due to inserted entries in the previous</div>
<div>2668&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * BIN.</div>
<div>2669&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2670&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @return true if an unaccounted for insertion happened.</div>
<div>2671&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2672&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * TODO:</div>
<div>2673&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Unfortunately, this method doesn't cover all cases where a phantom may</div>
<div>2674&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * have been inserted.  Another case is described below.</div>
<div>2675&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2676&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                        IN-0</div>
<div>2677&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                        ----------------------</div>
<div>2678&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                        |    | 50 | 100 |    |</div>
<div>2679&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                        ----------------------</div>
<div>2680&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                        /    /         \     \</div>
<div>2681&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                            /           \</div>
<div>2682&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                       /----             ----\</div>
<div>2683&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *        IN-1          /                       \       IN-2</div>
<div>2684&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *        ----------------                   ----------------</div>
<div>2685&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *        | 60 | 70 | 80 |                   |    |    |    |</div>
<div>2686&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *        ----------------                   ----------------</div>
<div>2687&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *         /      |      \                     /</div>
<div>2688&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *        /       |       \                   /</div>
<div>2689&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                   ----------------     -----------------</div>
<div>2690&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                   | 81 | 83 | 85 |     | 110 |    |    |</div>
<div>2691&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                   ----------------     -----------------</div>
<div>2692&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                   BIN-3                BIN-4</div>
<div>2693&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2694&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Initially, the tree looks as above and a cursor (C) is located on the</div>
<div>2695&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * last slot of BIN-3. For simplicity, assume no duplicates and no</div>
<div>2696&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * serializable isolation. Also assume that C is a sticky cursor.</div>
<div>2697&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2698&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * 1. Thread 1 calls C.getNext(), which calls retrieveNextAllowPhantoms(),</div>
<div>2699&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    which duplicates C's cursorImpl, and calls dup.getNext().</div>
<div>2700&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2701&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    dup.getNext() latches BIN-3, sets dup.binToBeRemoved to BIN-3 and</div>
<div>2702&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    then calls Tree.getNextBin(BIN-3).</div>
<div>2703&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2704&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    Tree.getNextBin(BIN-3) does the following:</div>
<div>2705&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - sets searchKey to 85</div>
<div>2706&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - calls Tree.getParentINForChildIN(BIN-3).</div>
<div>2707&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - Tree.getParentINForChildIN(BIN-3) unlatches BIN-3 and searches for</div>
<div>2708&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *       BIN-3 parent, thus reaching IN-1.</div>
<div>2709&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - IN-1.findEntry(85) sets "index" to 2,</div>
<div>2710&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - "index" is incremented,</div>
<div>2711&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - "moreEntriesThisIn" is set to false,</div>
<div>2712&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - "next" is set to IN-1, .</div>
<div>2713&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - Tree.getParentINForChildIN(IN-1) is called and unlatches IN-1.</div>
<div>2714&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2715&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    Assume at this point thread 1 looses the cpu.</div>
<div>2716&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2717&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * 2. Thread 2 inserts keys 90 and 95, causing a split of both BIN-3 and</div>
<div>2718&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    IN-1. So the tree now looks like this:</div>
<div>2719&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2720&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                       IN-0</div>
<div>2721&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                       ---------------------------</div>
<div>2722&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                       |    | 50 | 80 | 100 |    |</div>
<div>2723&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                       ---------------------------</div>
<div>2724&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                       /    /      |      \      \</div>
<div>2725&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                           /       |       \</div>
<div>2726&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                 /---------        |        ----------\</div>
<div>2727&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *       IN-1     /                  |                   \       IN-2</div>
<div>2728&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *               /              IN-5 |                    \</div>
<div>2729&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *       -----------            -----------               ----------------</div>
<div>2730&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *       | 60 | 70 |            | 80 | 90 |               |    |    |    |</div>
<div>2731&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *       -----------            -----------               ----------------</div>
<div>2732&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *        /      |              /         \                /</div>
<div>2733&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *       /       |             /           \              /</div>
<div>2734&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                     ----------------  -----------   -----------------</div>
<div>2735&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                     | 81 | 83 | 85 |  | 90 | 95 |   | 110 |    |    |</div>
<div>2736&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                     ----------------  -----------   -----------------</div>
<div>2737&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                     BIN-3             BIN-6         BIN-4</div>
<div>2738&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2739&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2740&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    Notice that C.cursorImpl still points to the last slot of BIN-3.</div>
<div>2741&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2742&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * 3. Thread 1 resumes:</div>
<div>2743&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2744&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - Tree.getParentINForChildIN(IN-1) reaches IN-0.</div>
<div>2745&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - IN-0.findEntry(85) sets "index" to 2,</div>
<div>2746&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - "index" is incremented,</div>
<div>2747&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - "nextIN" is set to IN-2, which is latched.</div>
<div>2748&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - Tree.searchSubTree(IN-2, LEFT) is called, and returns BIN-4.</div>
<div>2749&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - BIN-4 is the result of Tree.getNextBin(BIN-3), i.e., BIN-6 was</div>
<div>2750&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *      skipped</div>
<div>2751&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2752&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *      Now we are back in dup.getNext():</div>
<div>2753&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - dup.bin is set to BIN-4, dup.index to -1, and dup is added to BIN-4</div>
<div>2754&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - the while loop repeats, dup.index is set to 0, the 1st slot of</div>
<div>2755&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *      BIN-4 is locked, and dup.getNext() returns SUCCESS.</div>
<div>2756&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2757&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *      Now we are back in C.retrieveNextAllowPhantoms():</div>
<div>2758&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - C.checkForInsertion() is called</div>
<div>2759&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *    - C.cursorImpl and dup are on different BINs, but the condition:</div>
<div>2760&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *      origBIN.getNEntries() - 1 > origCursor.getIndex()</div>
<div>2761&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *      is false, so C.checkForInsertion() returns false.</div>
<div>2762&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2763&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The end result is that BIN-6 has been missed. This is not be a "bug" for</div>
<div>2764&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * non-serializable isolation, but the above scenario applies to</div>
<div>2765&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * serializable isolation as well, and in that case, BIN-6 should really</div>
<div>2766&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * not be missed. This could be solved by re-implementing</div>
<div>2767&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Tree.getNext/PrevBIN() do a more "logical" kind of search.</div>
<div>2768&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>2769&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public boolean checkForInsertion(</div>
<div>2770&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final GetMode getMode,</div>
<div>2771&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final CursorImpl dupCursor) {</div>
<div>2772&emsp;&emsp;</div>
<div>2773&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final CursorImpl origCursor = this;</div>
<div>2774&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean forward = getMode.isForward();</div>
<div>2775&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean ret = false;</div>
<div>2776&emsp;&emsp;</div>
<div style="background-color:limegreen;">2777&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (origCursor.bin != dupCursor.bin) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2778&emsp;&emsp;</div>
<div>2779&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>2780&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * We jumped to the next BIN during getNext().</div>
<div>2781&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             *</div>
<div>2782&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Be sure to operate on the BIN returned by latchBIN, not a cached</div>
<div>2783&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * var [#21121].</div>
<div>2784&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             *</div>
<div>2785&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Note that a cursor BIN can change after the check above, but</div>
<div>2786&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * that's not relevant; what we're trying to detect are BIN changes</div>
<div>2787&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * during the operation that has already completed.</div>
<div>2788&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             *</div>
<div>2789&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Note that we can call isDefunct without locking.  If we see a</div>
<div>2790&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * non-committed defunct entry, we'll just iterate around in the</div>
<div>2791&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * caller. So a false positive is ok.</div>
<div>2792&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>2793&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            origCursor.latchBIN();</div>
<div>2794&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            final BIN origBIN = origCursor.bin;</div>
<div>2795&emsp;&emsp;</div>
<div>2796&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            origBIN.mutateToFullBIN(false /*leaveFreeSlot*/);</div>
<div>2797&emsp;&emsp;</div>
<div>2798&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            try {</div>
<div style="background-color:limegreen;">2799&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if (forward) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">2800&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    if (origBIN.getNEntries() - 1 > origCursor.getIndex()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2801&emsp;&emsp;</div>
<div>2802&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        /*</div>
<div>2803&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                         * We were adjusted to something other than the</div>
<div>2804&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                         * last entry so some insertion happened.</div>
<div>2805&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                         */</div>
<div>2806&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        for (int i = origCursor.getIndex() + 1;</div>
<div style="background-color:limegreen;">2807&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                             i &#60; origBIN.getNEntries();&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2808&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                             i++) {</div>
<div style="background-color:limegreen;">2809&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                            if (!origBIN.isDefunct(i)) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2810&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                /* See comment above about locking. */</div>
<div>2811&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                ret = true;</div>
<div>2812&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                break;</div>
<div>2813&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            }</div>
<div>2814&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</div>
<div>2815&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</div>
<div>2816&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                } else {</div>
<div style="background-color:limegreen;">2817&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    if (origCursor.getIndex() > 0) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2818&emsp;&emsp;</div>
<div>2819&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        /*</div>
<div>2820&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                         * We were adjusted to something other than the</div>
<div>2821&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                         * first entry so some insertion happened.</div>
<div>2822&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                         */</div>
<div style="background-color:limegreen;">2823&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                        for (int i = 0; i &#60; origCursor.getIndex(); i++) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">2824&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                            if (!origBIN.isDefunct(i)) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>2825&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                /* See comment above about locking. */</div>
<div>2826&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                ret = true;</div>
<div>2827&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                break;</div>
<div>2828&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            }</div>
<div>2829&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</div>
<div>2830&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</div>
<div>2831&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>2832&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            } finally {</div>
<div>2833&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                origCursor.releaseBIN();</div>
<div>2834&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>2835&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return ret;</div>
<div>2836&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2837&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return false;</div>
<div>2838&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2839&emsp;&emsp;</div>
<div>2840&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>2841&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Skips over entries until a boundary condition is satisfied, either</div>
<div>2842&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * because maxCount is reached or RangeConstraint.inBounds returns false.</div>
<div>2843&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2844&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * If a maxCount is passed, this allows advancing the cursor quickly by N</div>
<div>2845&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * entries.  If a rangeConstraint is passed, this allows returning the</div>
<div>2846&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * entry count after advancing until the predicate returns false, e.g., the</div>
<div>2847&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * number of entries in a key range.  In either case, the number of entries</div>
<div>2848&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * advanced is returned.</div>
<div>2849&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2850&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Optimized to scan using level two of the tree when possible, to avoid</div>
<div>2851&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * calling getNextBin/getPrevBin for every BIN of the database.  All BINs</div>
<div>2852&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * beneath a level two IN can be skipped quickly, with the level two parent</div>
<div>2853&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * IN latched, when all of its children BINs are resident and can be</div>
<div>2854&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * latched without waiting.  When a child BIN is not resident or latching</div>
<div>2855&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * waits, we revert to the getNextBin/getPrevBin approach, to avoid keeping</div>
<div>2856&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * the parent IN latched for long time periods.</div>
<div>2857&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2858&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Although this method positions the cursor on the last non-defunct entry</div>
<div>2859&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * seen (before the boundary condition is satisfied), because it does not</div>
<div>2860&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * lock the LN it is possible that it is made defunct by another thread</div>
<div>2861&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * after the BIN is unlatched.</div>
<div>2862&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2863&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param forward is true to skip forward, false to skip backward.</div>
<div>2864&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2865&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param maxCount is the maximum number of non-defunct entries to skip,</div>
<div>2866&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * and may be LTE zero if no maximum is enforced.</div>
<div>2867&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2868&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param rangeConstraint is a predicate that returns false at a position</div>
<div>2869&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * where advancement should stop, or null if no predicate is enforced.</div>
<div>2870&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>2871&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @return the number of non-defunct entries that were skipped.</div>
<div>2872&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>2873&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public long skip(</div>
<div>2874&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean forward,</div>
<div>2875&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        long maxCount,</div>
<div>2876&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        RangeConstraint rangeConstraint) {</div>
<div>2877&emsp;&emsp;</div>
<div>2878&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final CursorImpl c = cloneCursor(true /*samePosition*/);</div>
<div>2879&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        c.setCacheMode(CacheMode.UNCHANGED);</div>
<div>2880&emsp;&emsp;</div>
<div>2881&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>2882&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return c.skipInternal(forward, maxCount, rangeConstraint, this);</div>
<div>2883&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } catch (final Throwable e) {</div>
<div>2884&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /*</div>
<div>2885&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * Get more info on dbsim duplicate.conf failure when c.close below</div>
<div>2886&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * throws because the BIN latch is already held.  It should have</div>
<div>2887&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * been released by skipInternal and therefore an unexpected</div>
<div>2888&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * exception must have been throw and the error handling must be</div>
<div>2889&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             * incorrect.</div>
<div>2890&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;             */</div>
<div>2891&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            e.printStackTrace(System.out);</div>
<div>2892&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            throw e;</div>
<div>2893&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div>2894&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            c.close();</div>
<div>2895&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>2896&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>2897&emsp;&emsp;</div>
<div>2898&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>2899&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Use this cursor to reference the current BIN in the traversal, to</div>
<div>2900&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * prevent the current BIN from being compressed away.  But set the given</div>
<div>2901&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * finalPositionCursor (the 'user' cursor) position only at non-defunct</div>
<div>2902&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * entries, since it should be positioned on a valid entry when this method</div>
<div>2903&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * returns.</div>
<div>2904&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>2905&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private long skipInternal(</div>
<div>2906&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean forward,</div>
<div>2907&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        long maxCount,</div>
<div>2908&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        RangeConstraint rangeConstraint,</div>
<div>2909&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        CursorImpl finalPositionCursor) {</div>
<div>2910&emsp;&emsp;</div>
<div>2911&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Start with the entry at the cursor position. */</div>
<div>2912&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final Tree tree = dbImpl.getTree();</div>
<div>2913&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        </div>
<div>2914&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        latchBIN();</div>
<div>2915&emsp;&emsp;</div>
<div>2916&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        IN parent = null;</div>
<div>2917&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        BIN prevBin = null;</div>
<div>2918&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        BIN curBin = bin;</div>
<div>2919&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        int curIndex = getIndex();</div>
<div>2920&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        long count = 0;</div>
<div>2921&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean success = false;</div>
<div>2922&emsp;&emsp;</div>
<div>2923&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>2924&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            while (true) {</div>
<div>2925&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                curBin.mutateToFullBIN(false /*leaveFreeSlot*/);</div>
<div>2926&emsp;&emsp;</div>
<div>2927&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                /* Skip entries in the current BIN. */</div>
<div>2928&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                count = skipEntries(</div>
<div>2929&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    forward, maxCount, rangeConstraint, finalPositionCursor,</div>
<div>2930&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    curBin, curIndex, count);</div>
<div>2931&emsp;&emsp;</div>
<div>2932&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (count &#60; 0) {</div>
<div>2933&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    curBin.releaseLatch();</div>
<div>2934&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    success = true;</div>
<div>2935&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    return (- count);</div>
<div>2936&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>2937&emsp;&emsp;</div>
<div>2938&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                /*</div>
<div>2939&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * Get the parent IN at level two. The BIN is unlatched by</div>
<div>2940&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * getParentINForChildIN.  Before releasing the BIN latch, get</div>
<div>2941&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * the search key for the last entry.</div>
<div>2942&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 */</div>
<div>2943&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                final byte[] idKey =</div>
<div>2944&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    (curBin.getNEntries() == 0 ?</div>
<div>2945&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     curBin.getIdentifierKey() :</div>
<div>2946&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     (forward ?</div>
<div>2947&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                      curBin.getKey(curBin.getNEntries() - 1) :</div>
<div>2948&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                      curBin.getKey(0)));</div>
<div>2949&emsp;&emsp;</div>
<div>2950&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                final SearchResult result = tree.getParentINForChildIN(</div>
<div>2951&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    curBin, false, /*useTargetLevel*/</div>
<div>2952&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    true, /*doFetch*/ CacheMode.DEFAULT);</div>
<div>2953&emsp;&emsp;</div>
<div>2954&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                parent = result.parent;</div>
<div>2955&emsp;&emsp;</div>
<div>2956&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (!result.exactParentFound) {</div>
<div>2957&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    throw EnvironmentFailureException.unexpectedState(</div>
<div>2958&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        "Cannot get parent of BIN id=" +</div>
<div>2959&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        curBin.getNodeId() + " key=" +</div>
<div>2960&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        Arrays.toString(idKey));</div>
<div>2961&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>2962&emsp;&emsp;</div>
<div>2963&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                /*</div>
<div>2964&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * Find and latch previous child BIN by matching idKey rather</div>
<div>2965&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * than using result.index, as in Tree.getNextIN (see comments</div>
<div>2966&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * there).</div>
<div>2967&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 */</div>
<div>2968&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                int parentIndex = parent.findEntry(idKey, false, false);</div>
<div>2969&emsp;&emsp;</div>
<div>2970&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                curBin = (BIN) parent.fetchIN(parentIndex, CacheMode.DEFAULT);</div>
<div>2971&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                curBin.latch();</div>
<div>2972&emsp;&emsp;</div>
<div>2973&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (forward ?</div>
<div>2974&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    (parentIndex &#60; parent.getNEntries() - 1) :</div>
<div>2975&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    (parentIndex > 0)) {</div>
<div>2976&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    </div>
<div>2977&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    /*</div>
<div>2978&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * There are more entries in the parent. Skip entries for</div>
<div>2979&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * child BINs that are resident and can be latched no-wait.</div>
<div>2980&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     */</div>
<div>2981&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    final int incr = forward ? 1 : (-1);</div>
<div>2982&emsp;&emsp;</div>
<div>2983&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    for (parentIndex += incr;; parentIndex += incr) {</div>
<div>2984&emsp;&emsp;</div>
<div>2985&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        prevBin = curBin;</div>
<div>2986&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        curBin = null;</div>
<div>2987&emsp;&emsp;</div>
<div>2988&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        /* Break is no more entries in parent. */</div>
<div>2989&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        if ((forward ?</div>
<div>2990&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                             parentIndex >= parent.getNEntries() :</div>
<div>2991&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                             parentIndex &#60; 0)) {</div>
<div>2992&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            parent.releaseLatch();</div>
<div>2993&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            break;</div>
<div>2994&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</div>
<div>2995&emsp;&emsp;</div>
<div>2996&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        /*</div>
<div>2997&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                         * Latch next child BIN, if cached and unlatched.</div>
<div>2998&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                         *</div>
<div>2999&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                         * Note that although 2 BINs are latched here, this</div>
<div>3000&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                         * can't cause deadlocks because the 2nd latch is</div>
<div>3001&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                         * no-wait.</div>
<div>3002&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                         */</div>
<div>3003&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        curBin = (BIN) parent.getTarget(parentIndex);</div>
<div>3004&emsp;&emsp;</div>
<div>3005&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        if (curBin == null ||</div>
<div>3006&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            !curBin.latchNoWait(CacheMode.DEFAULT)) {</div>
<div>3007&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            parent.releaseLatch();</div>
<div>3008&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            break;</div>
<div>3009&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</div>
<div>3010&emsp;&emsp;</div>
<div>3011&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        /* Unlatch the prev BIN */</div>
<div>3012&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        prevBin.releaseLatch();</div>
<div>3013&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        prevBin = null;</div>
<div>3014&emsp;&emsp;</div>
<div>3015&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        /* Position at new BIN to prevent compression. */</div>
<div>3016&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        setPosition(curBin, -1);</div>
<div>3017&emsp;&emsp;</div>
<div>3018&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        curBin.mutateToFullBIN(false /*leaveFreeSlot*/);</div>
<div>3019&emsp;&emsp;</div>
<div>3020&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        /* Skip entries in new child BIN. */</div>
<div>3021&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        count = skipEntries(</div>
<div>3022&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            forward, maxCount, rangeConstraint,</div>
<div>3023&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            finalPositionCursor, curBin,</div>
<div>3024&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            forward ? (-1) : curBin.getNEntries(), count);</div>
<div>3025&emsp;&emsp;</div>
<div>3026&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        if (count &#60; 0) {</div>
<div>3027&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            parent.releaseLatch();</div>
<div>3028&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            curBin.releaseLatch();</div>
<div>3029&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            success = true;</div>
<div>3030&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            return (- count);</div>
<div>3031&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</div>
<div>3032&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</div>
<div>3033&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                } else {</div>
<div>3034&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    /* No more entries in the parent. */</div>
<div>3035&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    parent.releaseLatch();</div>
<div>3036&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    prevBin = curBin;</div>
<div>3037&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>3038&emsp;&emsp;</div>
<div>3039&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                /*</div>
<div>3040&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * Only the prevBin is still latched here. Move to the next</div>
<div>3041&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * BIN the "hard" way (i.e., via full tree searches).</div>
<div>3042&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 */</div>
<div>3043&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                curBin = forward ?</div>
<div>3044&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    tree.getNextBin(prevBin, CacheMode.DEFAULT) :</div>
<div>3045&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    tree.getPrevBin(prevBin, CacheMode.DEFAULT);</div>
<div>3046&emsp;&emsp;</div>
<div>3047&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                assert(!prevBin.isLatchOwner());</div>
<div>3048&emsp;&emsp;</div>
<div>3049&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (curBin == null) {</div>
<div>3050&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    success = true;</div>
<div>3051&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    return count;</div>
<div>3052&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>3053&emsp;&emsp;</div>
<div>3054&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                prevBin = null;</div>
<div>3055&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                curIndex = forward ? (-1) : curBin.getNEntries();</div>
<div>3056&emsp;&emsp;</div>
<div>3057&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                /* Position at new BIN to prevent compression. */</div>
<div>3058&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                setPosition(curBin, -1);</div>
<div>3059&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3060&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div>3061&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (curBin != null && !success) {</div>
<div>3062&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                curBin.releaseLatchIfOwner();</div>
<div>3063&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3064&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (prevBin != null && !success) {</div>
<div>3065&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                prevBin.releaseLatchIfOwner();</div>
<div>3066&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3067&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (parent != null && !success) {</div>
<div>3068&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                parent.releaseLatchIfOwner();</div>
<div>3069&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3070&emsp;&emsp;</div>
<div>3071&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (LatchSupport.TRACK_LATCHES) {</div>
<div>3072&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                LatchSupport.expectBtreeLatchesHeld(0);</div>
<div>3073&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3074&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3075&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3076&emsp;&emsp;</div>
<div>3077&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3078&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Skip entries in curBin from one past curIndex and onward.  Returns</div>
<div>3079&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * non-negative count if skipping should continue, or negative count if</div>
<div>3080&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * bounds is exceeded.</div>
<div>3081&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3082&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private long skipEntries(</div>
<div>3083&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean forward,</div>
<div>3084&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        long maxCount,</div>
<div>3085&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        RangeConstraint rangeConstraint,</div>
<div>3086&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        CursorImpl finalPositionCursor,</div>
<div>3087&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        BIN curBin,</div>
<div>3088&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        int curIndex,</div>
<div>3089&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        long count) {</div>
<div>3090&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        </div>
<div>3091&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        assert(!curBin.isBINDelta());</div>
<div>3092&emsp;&emsp;</div>
<div>3093&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final int incr = forward ? 1 : (-1);</div>
<div>3094&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        </div>
<div>3095&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        for (int i = curIndex + incr;; i += incr) {</div>
<div>3096&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (forward ? (i >= curBin.getNEntries()) : (i &#60; 0)) {</div>
<div>3097&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                break;</div>
<div>3098&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3099&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (rangeConstraint != null &&</div>
<div>3100&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                !rangeConstraint.inBounds(curBin.getKey(i))) {</div>
<div>3101&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return (- count);</div>
<div>3102&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3103&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (!curBin.isDefunct(i)) {</div>
<div>3104&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                count += 1;</div>
<div>3105&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                finalPositionCursor.setPosition(curBin, i);</div>
<div>3106&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (maxCount > 0 && count >= maxCount) {</div>
<div>3107&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    return (- count);</div>
<div>3108&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>3109&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3110&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3111&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return count;</div>
<div>3112&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3113&emsp;&emsp;</div>
<div>3114&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3115&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Returns the stack of ancestor TrackingInfo for the BIN at the cursor, or</div>
<div>3116&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * null if a split occurs and the information returned would be</div>
<div>3117&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * inconsistent.</div>
<div>3118&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3119&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Used by CountEstimator.</div>
<div>3120&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3121&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public List&#60;TrackingInfo> getAncestorPath() {</div>
<div>3122&emsp;&emsp;</div>
<div>3123&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>3124&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Search for parent of BIN, get TrackingInfo for ancestors.  If the</div>
<div>3125&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * exact parent is not found, a split occurred and null is returned.</div>
<div>3126&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>3127&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final List&#60;TrackingInfo> trackingList = new ArrayList&#60;>();</div>
<div>3128&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        </div>
<div>3129&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        latchBIN();</div>
<div>3130&emsp;&emsp;</div>
<div>3131&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final BIN origBin = bin;</div>
<div>3132&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final Tree tree = dbImpl.getTree();</div>
<div>3133&emsp;&emsp;</div>
<div>3134&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final SearchResult result = tree.getParentINForChildIN(</div>
<div>3135&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            origBin, false, /*useTargetLevel*/</div>
<div>3136&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            true /*doFetch*/, CacheMode.UNCHANGED, trackingList);</div>
<div>3137&emsp;&emsp;</div>
<div>3138&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (!result.exactParentFound) {</div>
<div>3139&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* Must have been a split. */</div>
<div>3140&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return null;</div>
<div>3141&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3142&emsp;&emsp;</div>
<div>3143&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>3144&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * The parent was found and is now latched. If the child BIN does not</div>
<div>3145&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * match the cursor's BIN, then a split occurred and null is returned.</div>
<div>3146&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>3147&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final long binLsn;</div>
<div>3148&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>3149&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (origBin != result.parent.getTarget(result.index) ||</div>
<div>3150&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                origBin != bin) {</div>
<div>3151&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                /* Must have been a split. */</div>
<div>3152&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return null;</div>
<div>3153&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3154&emsp;&emsp;</div>
<div>3155&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            binLsn = result.parent.getLsn(result.index);</div>
<div>3156&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            bin.latch();</div>
<div>3157&emsp;&emsp;</div>
<div>3158&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div>3159&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            result.parent.releaseLatch();</div>
<div>3160&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3161&emsp;&emsp;</div>
<div>3162&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>3163&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * The child BIN is now latched. Subtract defunct entries from BIN's</div>
<div>3164&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * total entries and adjust the index accordingly.  Add TrackingInfo</div>
<div>3165&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * for child BIN.</div>
<div>3166&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>3167&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>3168&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            int binEntries = bin.getNEntries();</div>
<div>3169&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            int binIndex = getIndex();</div>
<div>3170&emsp;&emsp;</div>
<div>3171&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            for (int i = bin.getNEntries() - 1; i >= 0; i -= 1) {</div>
<div>3172&emsp;&emsp;</div>
<div>3173&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (bin.isDefunct(i)) {</div>
<div>3174&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    binEntries -= 1;</div>
<div>3175&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (i &#60; binIndex) {</div>
<div>3176&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        binIndex -= 1;</div>
<div>3177&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</div>
<div>3178&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>3179&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3180&emsp;&emsp;</div>
<div>3181&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            final TrackingInfo info = new TrackingInfo(</div>
<div>3182&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                binLsn, bin.getNodeId(), binEntries, binIndex);</div>
<div>3183&emsp;&emsp;</div>
<div>3184&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            trackingList.add(info);</div>
<div>3185&emsp;&emsp;</div>
<div>3186&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return trackingList;</div>
<div>3187&emsp;&emsp;</div>
<div>3188&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div>3189&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            bin.releaseLatch();</div>
<div>3190&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3191&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3192&emsp;&emsp;</div>
<div>3193&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3194&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Search for the next key following the given key, and acquire a range</div>
<div>3195&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * insert lock on it.  If there are no more records following the given</div>
<div>3196&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * key, lock the special EOF node for the dbImpl.</div>
<div>3197&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3198&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void lockNextKeyForInsert(DatabaseEntry key) {</div>
<div>3199&emsp;&emsp;</div>
<div>3200&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseEntry tempKey = new DatabaseEntry(</div>
<div>3201&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            key.getData(), key.getOffset(), key.getSize());</div>
<div>3202&emsp;&emsp;</div>
<div>3203&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean lockedNextKey = false;</div>
<div>3204&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean latched = true;</div>
<div>3205&emsp;&emsp;</div>
<div>3206&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>3207&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            while (true) {</div>
<div>3208&emsp;&emsp;</div>
<div>3209&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                int searchResult = searchRange(tempKey, null /*comparator*/);</div>
<div>3210&emsp;&emsp;</div>
<div>3211&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if ((searchResult & FOUND) != 0 &&</div>
<div>3212&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    (searchResult & FOUND_LAST) == 0) {</div>
<div>3213&emsp;&emsp;</div>
<div>3214&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    /*</div>
<div>3215&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * The search positioned "this" on the BIN that should</div>
<div>3216&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * contain K1 and this BIN is now latched. If the BIN does</div>
<div>3217&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * contain K1, this.index points to K1's slot. Otherwise,</div>
<div>3218&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * this.index points to the right-most slot whose key is</div>
<div>3219&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * &#60; K1 (or this.index is -1 if K1 is &#60; than all keys in</div>
<div>3220&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * the BIN). Furthermore, "this" is NOT positioned on the</div>
<div>3221&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * very last slot of the BTree.</div>
<div>3222&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     *</div>
<div>3223&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * Call getNext() to advance "this" to the next *valid*</div>
<div>3224&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * (i.e., not defunct) slot and lock that slot in</div>
<div>3225&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * RANGE_INSERT mode. Normally, getNext() will move the</div>
<div>3226&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * cursor to the 1st slot with a key K2 > K1. However, it</div>
<div>3227&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * is possible that K2 &#60;= K1 (see the comments in</div>
<div>3228&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * Cursor.searchRangeAdvanceAndCheckKey() about how this</div>
<div>3229&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * can happen. We handle this race condition by restarting</div>
<div>3230&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * the search.</div>
<div>3231&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     */</div>
<div>3232&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    DatabaseEntry tempData = new DatabaseEntry();</div>
<div>3233&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    tempData.setPartial(0, 0, true);</div>
<div>3234&emsp;&emsp;</div>
<div>3235&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    OperationResult result = getNext(</div>
<div>3236&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        tempKey, tempData, LockType.RANGE_INSERT,</div>
<div>3237&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        false, true, true,</div>
<div>3238&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        null /*rangeConstraint*/);</div>
<div>3239&emsp;&emsp;</div>
<div>3240&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    latched = false;</div>
<div>3241&emsp;&emsp;</div>
<div>3242&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (result != null) {</div>
<div>3243&emsp;&emsp;</div>
<div>3244&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        Comparator&#60;byte[]> comparator =</div>
<div>3245&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            dbImpl.getKeyComparator();</div>
<div>3246&emsp;&emsp;</div>
<div>3247&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        int c = Key.compareKeys(tempKey, key, comparator);</div>
<div>3248&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        if (c &#60;= 0) {</div>
<div>3249&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            tempKey.setData(</div>
<div>3250&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                key.getData(), key.getOffset(), key.getSize());</div>
<div>3251&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            continue;</div>
<div>3252&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</div>
<div>3253&emsp;&emsp;</div>
<div>3254&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        lockedNextKey = true;</div>
<div>3255&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</div>
<div>3256&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>3257&emsp;&emsp;</div>
<div>3258&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                break;</div>
<div>3259&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3260&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div style="background-color:limegreen;">3261&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (latched) {&nbsp;&#8594; [TRANSACTIONAL]</b></div>
<div>3262&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                releaseBIN();</div>
<div>3263&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3264&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3265&emsp;&emsp;</div>
<div>3266&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Lock the EOF node if no next key was found. */</div>
<div>3267&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (!lockedNextKey) {</div>
<div>3268&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            lockEof(LockType.RANGE_INSERT);</div>
<div>3269&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3270&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3271&emsp;&emsp;</div>
<div>3272&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /*</div>
<div>3273&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Locking</div>
<div>3274&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3275&emsp;&emsp;</div>
<div>3276&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3277&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Holds the result of a lockLN operation.  A lock may not actually be</div>
<div>3278&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * held (getLockResult may return null) if an uncontended lock is allowed.</div>
<div>3279&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3280&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public static class LockStanding {</div>
<div>3281&emsp;&emsp;</div>
<div>3282&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        private long lsn;</div>
<div>3283&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        private boolean defunct;</div>
<div>3284&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        private LockResult lockResult;</div>
<div>3285&emsp;&emsp;</div>
<div>3286&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /**</div>
<div>3287&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Returns true if the record is not deleted or expired.</div>
<div>3288&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>3289&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        public boolean recordExists() {</div>
<div style="background-color:limegreen;">3290&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            return !defunct;&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3291&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3292&emsp;&emsp;</div>
<div>3293&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /**</div>
<div>3294&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Called by update and delete ops, after lockLN() and before logging</div>
<div>3295&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * the LN and updating the BIN. It returns a WriteLockInfo that is</div>
<div>3296&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * meant to be passed to the LN logging method, where its info will</div>
<div>3297&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * be included in the LN log entry and also copied into the new</div>
<div>3298&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * WriteLockInfo that will be created for the new LSN.</div>
<div>3299&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         *</div>
<div>3300&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * If the locker is not transactional, or the current LSN has not been</div>
<div>3301&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * write-locked before by this locker, a new WriteLockInfo is created</div>
<div>3302&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * here and its abortLsn and abortKD fields are set. (note: even though</div>
<div>3303&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * lockLN() is called before prepareForUpdate(), it may not actually</div>
<div>3304&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * acquire a lock because of the uncontended optimization).</div>
<div>3305&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * </div>
<div>3306&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Otherwise, a WriteLockInfo exists already. It may have been created</div>
<div>3307&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * by the lockLN() call during the current updating op, or a lockLN()</div>
<div>3308&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * call during an earlier updating op by the same txn. In the later</div>
<div>3309&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * case, the abortLsn and abortKD have been set already and should not</div>
<div>3310&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * be overwriten here.</div>
<div>3311&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>3312&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        public WriteLockInfo prepareForUpdate(BIN bin, int idx) {</div>
<div>3313&emsp;&emsp;</div>
<div>3314&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            DatabaseImpl db = bin.getDatabase();</div>
<div style="background-color:limegreen;">3315&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            boolean abortKD = !recordExists();&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3316&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            byte[] abortKey = null;</div>
<div>3317&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            byte[] abortData = null;</div>
<div>3318&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            long abortVLSN = VLSN.NULL_VLSN.getSequence();</div>
<div>3319&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            int abortExpiration = bin.getExpiration(idx);</div>
<div>3320&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            boolean abortExpirationInHours = bin.isExpirationInHours();</div>
<div>3321&emsp;&emsp;</div>
<div style="background-color:limegreen;">3322&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (bin.isEmbeddedLN(idx)) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3323&emsp;&emsp;</div>
<div>3324&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                abortData = bin.getData(idx);</div>
<div>3325&emsp;&emsp;</div>
<div>3326&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                abortVLSN = bin.getVLSN(</div>
<div>3327&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    idx, false/*allowFetch*/, null/*cacheMode*/);</div>
<div>3328&emsp;&emsp;</div>
<div style="background-color:limegreen;">3329&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if (bin.getDatabase().allowsKeyUpdates()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3330&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    abortKey = bin.getKey(idx);</div>
<div>3331&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>3332&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3333&emsp;&emsp;</div>
<div style="background-color:limegreen;">3334&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            WriteLockInfo wri = (lockResult == null ?&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3335&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                 null :</div>
<div>3336&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                 lockResult.getWriteLockInfo());</div>
<div style="background-color:limegreen;">3337&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (wri == null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3338&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                wri = new WriteLockInfo();</div>
<div>3339&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                wri.setAbortLsn(lsn);</div>
<div>3340&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                wri.setAbortKnownDeleted(abortKD);</div>
<div>3341&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                wri.setAbortKey(abortKey);</div>
<div>3342&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                wri.setAbortData(abortData);</div>
<div>3343&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                wri.setAbortVLSN(abortVLSN);</div>
<div>3344&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                wri.setAbortExpiration(abortExpiration, abortExpirationInHours);</div>
<div>3345&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                wri.setDb(db);</div>
<div>3346&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            } else {</div>
<div>3347&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                lockResult.setAbortInfo(</div>
<div>3348&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    lsn, abortKD, abortKey, abortData, abortVLSN,</div>
<div>3349&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    abortExpiration, abortExpirationInHours, db);</div>
<div>3350&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3351&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return wri;</div>
<div>3352&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3353&emsp;&emsp;</div>
<div>3354&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /**</div>
<div>3355&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Creates WriteLockInfo that is appropriate for a newly inserted slot.</div>
<div>3356&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * The return value is meant to be passed to an LN logging method and</div>
<div>3357&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * copied into the WriteLockInfo for the new LSN.  This method is</div>
<div>3358&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * static because lockLN is never called prior to logging an LN for a</div>
<div>3359&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * newly inserted slot.</div>
<div>3360&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>3361&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        public static WriteLockInfo prepareForInsert(BIN bin) {</div>
<div>3362&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            WriteLockInfo wri = new WriteLockInfo();</div>
<div>3363&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            wri.setDb(bin.getDatabase());</div>
<div>3364&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return wri;</div>
<div>3365&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3366&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3367&emsp;&emsp;</div>
<div>3368&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /** Does not allow uncontended locks.  See lockLN(LockType, boolean). */</div>
<div>3369&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public LockStanding lockLN(LockType lockType)</div>
<div>3370&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        throws LockConflictException {</div>
<div>3371&emsp;&emsp;</div>
<div>3372&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return lockLN(lockType, false /*allowUncontended*/, false /*noWait*/);</div>
<div>3373&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3374&emsp;&emsp;</div>
<div>3375&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3376&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Locks the LN at the cursor position.  Attempts to use a non-blocking</div>
<div>3377&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * lock to avoid unlatching/relatching.</div>
<div>3378&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3379&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Retries if necessary, to handle the case where the LSN is changed while</div>
<div>3380&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * the BIN is unlatched.  Because it re-latches the BIN to check the LSN,</div>
<div>3381&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * this serializes access to the LSN for locking, guaranteeing that two</div>
<div>3382&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * lockers cannot obtain conflicting locks on the old and new LSNs.</div>
<div>3383&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3384&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Preconditions: The BIN must be latched.</div>
<div>3385&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3386&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Postconditions: The BIN is latched.</div>
<div>3387&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3388&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * LN Locking Rules</div>
<div>3389&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * ----------------</div>
<div>3390&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The lock ID for an LN is its LSN in the parent BIN slot.  Because the</div>
<div>3391&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * LSN changes when logging the LN, only two methods of locking an LN may</div>
<div>3392&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * be used to support concurrent access:</div>
<div>3393&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3394&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * 1. This method may be called to lock the old LSN.  For read operations,</div>
<div>3395&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * that is all that is necessary.  For write operations, the new LSN must</div>
<div>3396&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * be locked after logging it, which is done by all the LN logging methods.</div>
<div>3397&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Be sure to pass a non-null locker to the LN logging method to lock the</div>
<div>3398&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * LN, unless locking is not desired.</div>
<div>3399&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3400&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * 2. A non-blocking lock may be obtained on the old LSN (using</div>
<div>3401&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Locker.nonBlockingLock rather than this method), as long as the lock is</div>
<div>3402&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * released before the BIN latch is released.  In this case a null locker</div>
<div>3403&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * is passed to the LN logging method; locking the new LSN is unnecessary</div>
<div>3404&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * because no other thread can access the new LSN until the BIN latch is</div>
<div>3405&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * released.</div>
<div>3406&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3407&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The first method is used for all user operations.  The second method is</div>
<div>3408&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * used by the cleaner, when flushing dirty deferred-write LNs, and by</div>
<div>3409&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * certain btree operations.</div>
<div>3410&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3411&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Uncontended Lock Optimization</div>
<div>3412&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * -----------------------------</div>
<div>3413&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The allowUncontended param is passed as true for update and delete</div>
<div>3414&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * operations as an optimization for the case where no lock on the old LSN</div>
<div>3415&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * is held by any locker.  In this case we don't need to lock the old LSN</div>
<div>3416&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * at all, as long as we log the new LSN before releasing the BIN latch.</div>
<div>3417&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3418&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * 1. Latch BIN</div>
<div>3419&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * 2. Determine that no lock/waiter exists for oldLsn</div>
<div>3420&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * 3. Log LN and get lsn</div>
<div>3421&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * 4. Lock lsn</div>
<div>3422&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * 5. Update BIN</div>
<div>3423&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * 6. Release BIN latch</div>
<div>3424&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3425&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The oldLsn is never locked, saving operations on the lock table.  The</div>
<div>3426&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * assumption is that another locker will first have to latch the BIN to</div>
<div>3427&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * get oldLsn, before requesting a lock.</div>
<div>3428&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3429&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * A potential problem is that the other locker may release the BIN latch</div>
<div>3430&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * before requesting the lock.</div>
<div>3431&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3432&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * This Operation        Another Operation</div>
<div>3433&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * --------------        -----------------</div>
<div>3434&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                       Latch BIN, get oldLsn, release BIN latch</div>
<div>3435&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Step 1 and 2</div>
<div>3436&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *                       Request lock for oldLsn, granted</div>
<div>3437&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Step 3 and 4</div>
<div>3438&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3439&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Both operations now believe they have an exclusive lock, but they have</div>
<div>3440&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * locks on different LSNs.</div>
<div>3441&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3442&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * However, this problem is handled as long as the other lock is performed</div>
<div>3443&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * using a lockLN method in this class, which will release the lock and</div>
<div>3444&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * retry if the LSN changes while acquiring the lock.  Because it</div>
<div>3445&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * re-latches the BIN to check the LSN, this will serialize access to the</div>
<div>3446&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * LSN for locking, guaranteeing that two conflicting locks cannot be</div>
<div>3447&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * granted on the old and new LSNs.</div>
<div>3448&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3449&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Deferred-Write Locking</div>
<div>3450&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * ----------------------</div>
<div>3451&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * When one of the LN optionalLog methods is called, a deferred-write LN is</div>
<div>3452&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * dirtied but not actually logged.  In order to lock an LN that has been</div>
<div>3453&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * inserted but not yet assigned a true LSN, a transient LSNs is assigned.</div>
<div>3454&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * These LSNs serve to lock the LN but never appear in the log.  See</div>
<div>3455&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * LN.assignTransientLsn.</div>
<div>3456&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3457&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * A deferred-write LN is logged when its parent BIN is logged, or when the</div>
<div>3458&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * LN is evicted.  This will replace transient LSNs with durable LSNs.  If</div>
<div>3459&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * a lock is held by a cursor on a deferred-write LN when it is logged, the</div>
<div>3460&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * same lock is acquired on the new LSN by the cursor.  See</div>
<div>3461&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * lockAfterLsnChange.</div>
<div>3462&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3463&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Cleaner Migration Locking</div>
<div>3464&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * -------------------------</div>
<div>3465&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * The cleaner takes a non-blocking read lock on the old LSN before</div>
<div>3466&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * migrating/logging the LN, while holding the BIN latch.  It does not take</div>
<div>3467&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * a lock on the new LSN, since it does not need to retain a lock after</div>
<div>3468&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * releasing the BIN latch.</div>
<div>3469&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3470&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Because a read, not write, lock is taken, other read locks may be held</div>
<div>3471&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * during migration.  After logging, the cleaner calls lockAfterLsnChange</div>
<div>3472&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * to lock the new LSN on behalf of other lockers.</div>
<div>3473&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3474&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * For more info on migration locking, see HandleLocker.</div>
<div>3475&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3476&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Expired Record Locking</div>
<div>3477&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * ----------------------</div>
<div>3478&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * To support repeatable-read semantics when a record expires after being</div>
<div>3479&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * locked, we must check whether a record was previously locked before</div>
<div>3480&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * attempting to lock it. If it was previously locked, then it is treated</div>
<div>3481&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * as not expired, even if its expiration time has passed.</div>
<div>3482&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3483&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * By was previously "locked" here we mean that any lock type is held, or</div>
<div>3484&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * shared with its owner, by this cursor's locker. Since a read lock will</div>
<div>3485&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * prevent modification of the expiration time, any lock type is adequate.</div>
<div>3486&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * A shared lock is considered adequate to account for the case where</div>
<div>3487&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * multiple lockers are used internally for a single virtual locker, as</div>
<div>3488&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * seen by the user. This is the case when using a read-committed locker or</div>
<div>3489&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * a thread-locker, for example.</div>
<div>3490&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3491&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * To avoid unnecessary added overhead, we do not check whether a record</div>
<div>3492&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * was previously locked except when expiration is imminent, which is</div>
<div>3493&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * defined as expiring within {@link</div>
<div>3494&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * EnvironmentParams#ENV_TTL_MAX_TXN_TIME}. The ENV_TTL_MAX_TXN_TIME buffer</div>
<div>3495&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * is used because the expiration time may pass while waiting for a lock.</div>
<div>3496&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3497&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Another case to account for is when the expiration time of the record</div>
<div>3498&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * changes while waiting for the lock. This can happen if the record is</div>
<div>3499&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * updated or an update is aborted. In this case we can assume that the</div>
<div>3500&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * was not previously locked, since that would have prevented the update.</div>
<div>3501&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3502&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Note that when an uncontended lock applies, the expiration of the record</div>
<div>3503&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * with the current LSN cannot change. It is possible that the update or</div>
<div>3504&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * deletion requesting the uncontended lock will be aborted, and the LSN of</div>
<div>3505&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * an expired record will be reinstated in the BIN, but this does not</div>
<div>3506&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * create a special case.</div>
<div>3507&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3508&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Historical Notes</div>
<div>3509&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * ----------------</div>
<div>3510&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * In JE 4.1 and earlier, each LN had a node ID that was used for locking,</div>
<div>3511&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * rather than using the LSN.  The node ID changed only if a deleted slot</div>
<div>3512&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * was reused.  The node ID was stored in the LN, requiring that the LN be</div>
<div>3513&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * fetched when locking the LN.  With LSN locking a fetch is not needed.</div>
<div>3514&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3515&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * When LN node IDs were used, deferred-write LNs were not assigned an LSN</div>
<div>3516&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * until they were actually logged. Deferred-write LNs were initially</div>
<div>3517&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * assigned a null LSN and transient LSNs were not needed.</div>
<div>3518&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3519&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param lockType the type of lock requested.</div>
<div>3520&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3521&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param allowUncontended is true to return immediately (no lock is taken)</div>
<div>3522&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * when no locker holds or waits for the lock.</div>
<div>3523&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3524&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param noWait is true to perform a no-wait lock request while keeping</div>
<div>3525&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * the BIN latched.  The caller must check the lock result to see whether</div>
<div>3526&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * the lock was granted.</div>
<div>3527&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3528&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @return all information about the lock; see LockStanding.</div>
<div>3529&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3530&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @throws LockConflictException if the lsn is non-null, the lock is</div>
<div>3531&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * contended, and a lock could not be obtained by blocking.</div>
<div>3532&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3533&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public LockStanding lockLN(</div>
<div>3534&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LockType lockType,</div>
<div>3535&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean allowUncontended,</div>
<div>3536&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean noWait)</div>
<div>3537&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        throws LockConflictException {</div>
<div>3538&emsp;&emsp;</div>
<div>3539&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final EnvironmentImpl envImpl = dbImpl.getEnv();</div>
<div>3540&emsp;&emsp;</div>
<div>3541&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LockManager lockManager =</div>
<div>3542&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            envImpl.getTxnManager().getLockManager();</div>
<div>3543&emsp;&emsp;</div>
<div>3544&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LockStanding standing = new LockStanding();</div>
<div>3545&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        standing.lsn = bin.getLsn(index);</div>
<div>3546&emsp;&emsp;</div>
<div>3547&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Check for a known-deleted null LSN. */</div>
<div style="background-color:limegreen;">3548&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (standing.lsn == DbLsn.NULL_LSN) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">3549&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert bin.isEntryKnownDeleted(index);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3550&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            standing.defunct = true;</div>
<div>3551&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return standing;</div>
<div>3552&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3553&emsp;&emsp;</div>
<div>3554&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>3555&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * We can avoid taking a lock if uncontended.  However, we must</div>
<div>3556&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * call preLogWithoutLock to prevent logging on a replica, and as</div>
<div>3557&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * good measure to prepare for undo.</div>
<div>3558&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div style="background-color:limegreen;">3559&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (allowUncontended && lockManager.isLockUncontended(standing.lsn)) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">3560&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert verifyPendingDeleted(lockType);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3561&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            locker.preLogWithoutLock(dbImpl);</div>
<div>3562&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            standing.defunct = bin.isDefunct(index);</div>
<div>3563&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return standing;</div>
<div>3564&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3565&emsp;&emsp;</div>
<div>3566&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>3567&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * If wasLockedAndExpiresSoon is true, we will treat the record as not</div>
<div>3568&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * expired. If false, we will check for expiration after locking.</div>
<div>3569&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>3570&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean wasLockedAndExpiresSoon = false;</div>
<div>3571&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final int prevExpiration = bin.getExpiration(index);</div>
<div>3572&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean prevExpirationInHours = bin.isExpirationInHours();</div>
<div>3573&emsp;&emsp;</div>
<div style="background-color:limegreen;">3574&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (envImpl.expiresWithin(&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3575&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            prevExpiration, prevExpirationInHours,</div>
<div>3576&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            dbImpl.getEnv().getTtlMaxTxnTime())) {</div>
<div>3577&emsp;&emsp;</div>
<div style="background-color:limegreen;">3578&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (lockManager.ownsOrSharesLock(locker, standing.lsn)) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3579&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                wasLockedAndExpiresSoon = true;</div>
<div>3580&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3581&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3582&emsp;&emsp;</div>
<div>3583&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>3584&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Try a non-blocking lock first, to avoid unlatching.  If the default</div>
<div>3585&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * is no-wait, use the standard lock method so</div>
<div>3586&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * LockNotAvailableException is thrown; there is no need to try a</div>
<div>3587&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * non-blocking lock twice.</div>
<div>3588&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         *</div>
<div>3589&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Even for dirty-read (LockType.NONE) we must call Locker.lock() since</div>
<div>3590&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * it checks the locker state and may throw LockPreemptedException.</div>
<div>3591&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div style="background-color:limegreen;">3592&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (locker.getDefaultNoWait()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3593&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            try {</div>
<div>3594&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                standing.lockResult = locker.lock(</div>
<div>3595&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    standing.lsn, lockType, true /*noWait*/, dbImpl);</div>
<div>3596&emsp;&emsp;</div>
<div>3597&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            } catch (LockNotAvailableException e) {</div>
<div>3598&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                releaseBIN();</div>
<div>3599&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                throw e;</div>
<div>3600&emsp;&emsp;</div>
<div>3601&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            } catch (LockConflictException e) {</div>
<div>3602&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                releaseBIN();</div>
<div>3603&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                throw EnvironmentFailureException.unexpectedException(e);</div>
<div>3604&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3605&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</div>
<div>3606&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            standing.lockResult = locker.nonBlockingLock(</div>
<div>3607&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                standing.lsn, lockType, false /*jumpAheadOfWaiters*/,</div>
<div>3608&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                dbImpl);</div>
<div>3609&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3610&emsp;&emsp;</div>
<div style="background-color:limegreen;">3611&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (standing.lockResult.getLockGrant() != LockGrantType.DENIED) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3612&emsp;&emsp;</div>
<div>3613&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* Lock was granted whiled latched, no need to check LSN. */</div>
<div style="background-color:limegreen;">3614&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert verifyPendingDeleted(lockType);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3615&emsp;&emsp;</div>
<div style="background-color:limegreen;">3616&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            standing.defunct = wasLockedAndExpiresSoon ?&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3617&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin.isDeleted(index) : bin.isDefunct(index);</div>
<div>3618&emsp;&emsp;</div>
<div>3619&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return standing;</div>
<div>3620&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3621&emsp;&emsp;</div>
<div style="background-color:limegreen;">3622&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (noWait) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3623&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* We did not acquire the lock. */</div>
<div>3624&emsp;&emsp;</div>
<div style="background-color:limegreen;">3625&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            standing.defunct = wasLockedAndExpiresSoon ?&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3626&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                bin.isDeleted(index) : bin.isDefunct(index);</div>
<div>3627&emsp;&emsp;</div>
<div>3628&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return standing;</div>
<div>3629&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3630&emsp;&emsp;</div>
<div>3631&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>3632&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Unlatch, get a blocking lock, latch, and get the current LSN from</div>
<div>3633&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * the slot.  If the LSN changes while unlatched, revert the lock and</div>
<div>3634&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * repeat.</div>
<div>3635&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>3636&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        while (true) {</div>
<div>3637&emsp;&emsp;</div>
<div>3638&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* Request a blocking lock. */</div>
<div>3639&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            releaseBIN();</div>
<div>3640&emsp;&emsp;</div>
<div>3641&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            standing.lockResult = locker.lock(</div>
<div>3642&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                standing.lsn, lockType, false /*noWait*/, dbImpl);</div>
<div>3643&emsp;&emsp;</div>
<div>3644&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            latchBIN();</div>
<div>3645&emsp;&emsp;</div>
<div>3646&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* Check current LSN after locking. */</div>
<div>3647&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            final long newLsn = bin.getLsn(index);</div>
<div style="background-color:limegreen;">3648&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (standing.lsn == newLsn) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3649&emsp;&emsp;</div>
<div>3650&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                /*</div>
<div>3651&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * If the expiration time changes while unlatched, then it</div>
<div>3652&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 * could not have been previously locked.</div>
<div>3653&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                 */</div>
<div style="background-color:limegreen;">3654&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                if (prevExpiration != bin.getExpiration(index) ||&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">3655&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    prevExpirationInHours != bin.isExpirationInHours()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3656&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    wasLockedAndExpiresSoon = false;</div>
<div>3657&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>3658&emsp;&emsp;</div>
<div style="background-color:limegreen;">3659&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                standing.defunct = wasLockedAndExpiresSoon ?&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3660&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    bin.isDeleted(index) : bin.isDefunct(index);</div>
<div>3661&emsp;&emsp;</div>
<div style="background-color:limegreen;">3662&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                assert verifyPendingDeleted(lockType);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3663&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return standing;</div>
<div>3664&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3665&emsp;&emsp;</div>
<div>3666&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* The LSN changed, revert the lock and try again. */</div>
<div>3667&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            revertLock(standing);</div>
<div>3668&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            standing.lsn = newLsn;</div>
<div>3669&emsp;&emsp;</div>
<div>3670&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            /* Check for a known-deleted null LSN. */</div>
<div style="background-color:limegreen;">3671&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (newLsn == DbLsn.NULL_LSN) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">3672&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                assert bin.isEntryKnownDeleted(index);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3673&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                standing.defunct = true;</div>
<div>3674&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return standing;</div>
<div>3675&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3676&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3677&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3678&emsp;&emsp;</div>
<div>3679&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3680&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * After logging a deferred-write LN during eviction/checkpoint or a</div>
<div>3681&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * migrated LN during cleaning, for every existing lock on the old LSN held</div>
<div>3682&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * by another locker, we must lock the new LSN on behalf of that locker.</div>
<div>3683&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3684&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * This is done while holding the BIN latch so that the new LSN does not</div>
<div>3685&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * change during the locking process.  The BIN must be latched on entry and</div>
<div>3686&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * is left latched by this method.</div>
<div>3687&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3688&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * We release the lock on the oldLsn to prevent locks from accumulating</div>
<div>3689&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * over time on a HandleLocker, as the cleaner migrates LNs, because</div>
<div>3690&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Database handle locks are legitimately very long-lived.  It is important</div>
<div>3691&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * to first acquire all lsn locks and then release the oldLsn locks.</div>
<div>3692&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Releasing an oldLsn lock might allow another locker to acquire it, and</div>
<div>3693&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * then acquiring another lsn lock may encounter a conflict. [#20617]</div>
<div>3694&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3695&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @see com.sleepycat.je.txn.HandleLocker</div>
<div>3696&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @see #lockLN</div>
<div>3697&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3698&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public static void lockAfterLsnChange(</div>
<div>3699&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseImpl dbImpl,</div>
<div>3700&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        long oldLsn,</div>
<div>3701&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        long newLsn,</div>
<div>3702&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        Locker excludeLocker) {</div>
<div>3703&emsp;&emsp;</div>
<div>3704&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LockManager lockManager =</div>
<div>3705&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            dbImpl.getEnv().getTxnManager().getLockManager();</div>
<div>3706&emsp;&emsp;</div>
<div>3707&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final Set&#60;LockInfo> owners = lockManager.getOwners(oldLsn);</div>
<div style="background-color:limegreen;">3708&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (owners == null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3709&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return;</div>
<div>3710&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3711&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Acquire lsn locks. */</div>
<div style="background-color:limegreen;">3712&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        for (LockInfo lockInfo : owners) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3713&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            final Locker locker = lockInfo.getLocker();</div>
<div style="background-color:limegreen;">3714&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (locker != excludeLocker) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3715&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                locker.lockAfterLsnChange(oldLsn, newLsn, dbImpl);</div>
<div>3716&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3717&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3718&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Release oldLsn locks. */</div>
<div style="background-color:limegreen;">3719&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        for (LockInfo lockInfo : owners) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3720&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            final Locker locker = lockInfo.getLocker();</div>
<div style="background-color:limegreen;">3721&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (locker != excludeLocker &&&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">3722&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                locker.allowReleaseLockAfterLsnChange()) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3723&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                locker.releaseLock(oldLsn);</div>
<div>3724&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3725&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3726&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3727&emsp;&emsp;</div>
<div>3728&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3729&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * For debugging. Verify that a BINs cursor set refers to the BIN.</div>
<div>3730&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3731&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void verifyCursor(BIN bin) {</div>
<div>3732&emsp;&emsp;</div>
<div>3733&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (!bin.getCursorSet().contains(this)) {</div>
<div>3734&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            throw new EnvironmentFailureException(</div>
<div>3735&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                dbImpl.getEnv(),</div>
<div>3736&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                EnvironmentFailureReason.UNEXPECTED_STATE,</div>
<div>3737&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                "BIN cursorSet is inconsistent");</div>
<div>3738&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3739&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3740&emsp;&emsp;</div>
<div>3741&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3742&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Calls checkCursorState and asserts false if an exception is thrown.</div>
<div>3743&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Otherwise returns true, so it can be called under an assertion.</div>
<div>3744&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3745&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private boolean assertCursorState(</div>
<div>3746&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean mustBeInitialized,</div>
<div>3747&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean mustNotBeInitialized) {</div>
<div>3748&emsp;&emsp;</div>
<div>3749&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>3750&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            checkCursorState(mustBeInitialized, mustNotBeInitialized);</div>
<div>3751&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return true;</div>
<div>3752&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } catch (RuntimeException e) {</div>
<div style="background-color:limegreen;">3753&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            assert false : e.toString() + " " + dumpToString(true);&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3754&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return false; // for compiler</div>
<div>3755&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3756&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3757&emsp;&emsp;</div>
<div>3758&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3759&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Check that the cursor is open and optionally if it is initialized or</div>
<div>3760&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * uninitialized.</div>
<div>3761&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3762&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @throws IllegalStateException via all Cursor methods that call</div>
<div>3763&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Cursor.checkState (all get and put methods, plus more).</div>
<div>3764&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3765&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void checkCursorState(</div>
<div>3766&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean mustBeInitialized,</div>
<div>3767&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean mustNotBeInitialized) {</div>
<div>3768&emsp;&emsp;</div>
<div style="background-color:limegreen;">3769&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        switch (status) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3770&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        case CURSOR_NOT_INITIALIZED:</div>
<div style="background-color:limegreen;">3771&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (mustBeInitialized) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3772&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                throw new IllegalStateException("Cursor not initialized.");</div>
<div>3773&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3774&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            break;</div>
<div>3775&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        case CURSOR_INITIALIZED:</div>
<div style="background-color:limegreen;">3776&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (mustNotBeInitialized) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3777&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                throw EnvironmentFailureException.unexpectedState(</div>
<div>3778&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    "Cursor is initialized.");</div>
<div>3779&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3780&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (DEBUG) {</div>
<div>3781&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (bin != null) {</div>
<div>3782&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    verifyCursor(bin);</div>
<div>3783&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>3784&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3785&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            break;</div>
<div>3786&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        case CURSOR_CLOSED:</div>
<div>3787&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            throw new IllegalStateException("Cursor has been closed.");</div>
<div>3788&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        default:</div>
<div>3789&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            throw EnvironmentFailureException.unexpectedState(</div>
<div>3790&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                "Unknown cursor status: " + status);</div>
<div>3791&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3792&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3793&emsp;&emsp;</div>
<div>3794&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3795&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Checks that LN deletedness matches KD/PD flag state, at least when the</div>
<div>3796&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * LN is resident.  Should only be called under an assertion.</div>
<div>3797&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3798&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private boolean verifyPendingDeleted(LockType lockType) {</div>
<div>3799&emsp;&emsp;</div>
<div>3800&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Cannot verify deletedness if LN is not locked. */</div>
<div style="background-color:limegreen;">3801&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (lockType == LockType.NONE) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3802&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return true;</div>
<div>3803&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3804&emsp;&emsp;</div>
<div>3805&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Cannot verify deletedness if cursor is not intialized. */</div>
<div style="background-color:limegreen;">3806&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (bin == null || index &#60; 0) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3807&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return true;</div>
<div>3808&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3809&emsp;&emsp;</div>
<div>3810&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /* Cannot verify deletedness if LN is not resident. */</div>
<div>3811&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final LN ln = (LN) bin.getTarget(index);</div>
<div style="background-color:limegreen;">3812&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (ln == null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3813&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return true;</div>
<div>3814&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3815&emsp;&emsp;</div>
<div>3816&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /*</div>
<div>3817&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * If the LN is deleted then KD or PD must be set.  If the LN is not</div>
<div>3818&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * deleted then PD must not be set, but KD may or may not be set since</div>
<div>3819&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * it used for various purposes (see IN.java).</div>
<div>3820&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>3821&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean kd = bin.isEntryKnownDeleted(index);</div>
<div>3822&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean pd = bin.isEntryPendingDeleted(index);</div>
<div>3823&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        final boolean lnDeleted = ln.isDeleted();</div>
<div style="background-color:limegreen;">3824&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        assert ((lnDeleted && (kd || pd)) || (!lnDeleted && !pd)) :&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3825&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;               "Deleted state mismatch LNDeleted = " + lnDeleted +</div>
<div>3826&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;               " PD = " + pd + " KD = " + kd;</div>
<div>3827&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return true;</div>
<div>3828&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3829&emsp;&emsp;</div>
<div>3830&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void revertLock(LockStanding standing) {</div>
<div>3831&emsp;&emsp;</div>
<div style="background-color:limegreen;">3832&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (standing.lockResult != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3833&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            revertLock(standing.lsn, standing.lockResult);</div>
<div>3834&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            standing.lockResult = null;</div>
<div>3835&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3836&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3837&emsp;&emsp;</div>
<div>3838&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3839&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Return this lock to its prior status. If the lock was just obtained,</div>
<div>3840&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * release it. If it was promoted, demote it.</div>
<div>3841&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3842&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void revertLock(long lsn, LockResult lockResult) {</div>
<div>3843&emsp;&emsp;</div>
<div>3844&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        LockGrantType lockStatus = lockResult.getLockGrant();</div>
<div>3845&emsp;&emsp;</div>
<div style="background-color:limegreen;">3846&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if ((lockStatus == LockGrantType.NEW) ||&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3847&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            (lockStatus == LockGrantType.WAIT_NEW)) {</div>
<div>3848&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            locker.releaseLock(lsn);</div>
<div style="background-color:limegreen;">3849&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        } else if ((lockStatus == LockGrantType.PROMOTION) ||&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3850&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                   (lockStatus == LockGrantType.WAIT_PROMOTION)){</div>
<div>3851&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            locker.demoteLock(lsn);</div>
<div>3852&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3853&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3854&emsp;&emsp;</div>
<div>3855&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3856&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Locks the logical EOF node for the dbImpl.</div>
<div>3857&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3858&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void lockEof(LockType lockType) {</div>
<div>3859&emsp;&emsp;</div>
<div>3860&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        locker.lock(dbImpl.getEofLsn(), lockType,</div>
<div>3861&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    false /*noWait*/, dbImpl);</div>
<div>3862&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3863&emsp;&emsp;</div>
<div>3864&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3865&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @throws EnvironmentFailureException if the underlying environment is</div>
<div>3866&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * invalid.</div>
<div>3867&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3868&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void checkEnv() {</div>
<div>3869&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        dbImpl.getEnv().checkIfInvalid();</div>
<div>3870&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3871&emsp;&emsp;</div>
<div>3872&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3873&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Callback object for traverseDbWithCursor.</div>
<div>3874&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3875&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public interface WithCursor {</div>
<div>3876&emsp;&emsp;</div>
<div>3877&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        /**</div>
<div>3878&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * Called for each record in the dbImpl.</div>
<div>3879&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         * @return true to continue or false to stop the enumeration.</div>
<div>3880&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         */</div>
<div>3881&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean withCursor(CursorImpl cursor,</div>
<div>3882&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                           DatabaseEntry key,</div>
<div>3883&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                           DatabaseEntry data);</div>
<div>3884&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3885&emsp;&emsp;</div>
<div>3886&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3887&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Enumerates all records in a dbImpl non-transactionally and calls</div>
<div>3888&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * the withCursor method for each record.  Stops the enumeration if the</div>
<div>3889&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * callback returns false.</div>
<div>3890&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3891&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param db DatabaseImpl to traverse.</div>
<div>3892&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3893&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param lockType non-null LockType for reading records.</div>
<div>3894&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3895&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param allowEviction should normally be true to evict when performing</div>
<div>3896&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * multiple operations, but may be false if eviction is disallowed in a</div>
<div>3897&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * particular context.</div>
<div>3898&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     *</div>
<div>3899&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * @param withCursor callback object.</div>
<div>3900&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3901&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public static void traverseDbWithCursor(</div>
<div>3902&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseImpl db,</div>
<div>3903&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        LockType lockType,</div>
<div>3904&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        boolean allowEviction,</div>
<div>3905&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        WithCursor withCursor) {</div>
<div>3906&emsp;&emsp;</div>
<div>3907&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseEntry key = new DatabaseEntry();</div>
<div>3908&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DatabaseEntry data = new DatabaseEntry();</div>
<div>3909&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        Locker locker = null;</div>
<div>3910&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        CursorImpl cursor = null;</div>
<div>3911&emsp;&emsp;</div>
<div>3912&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        try {</div>
<div>3913&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            EnvironmentImpl envImpl = db.getEnv();</div>
<div>3914&emsp;&emsp;</div>
<div>3915&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            locker = LockerFactory.getInternalReadOperationLocker(envImpl);</div>
<div>3916&emsp;&emsp;</div>
<div>3917&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            cursor = new CursorImpl(db, locker);</div>
<div>3918&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            cursor.setAllowEviction(allowEviction);</div>
<div>3919&emsp;&emsp;</div>
<div style="background-color:limegreen;">3920&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (cursor.positionFirstOrLast(true /*first*/)) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3921&emsp;&emsp;</div>
<div>3922&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                OperationResult result = cursor.lockAndGetCurrent(</div>
<div>3923&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    key, data, lockType, false /*dirtyReadAll*/,</div>
<div>3924&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    true /*isLatched*/, true /*unlatch*/);</div>
<div>3925&emsp;&emsp;</div>
<div>3926&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                boolean done = false;</div>
<div style="background-color:limegreen;">3927&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                while (!done) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3928&emsp;&emsp;</div>
<div>3929&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    /*</div>
<div>3930&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * lockAndGetCurrent may have returned non-SUCCESS if the</div>
<div>3931&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * first record is defunct, but we can call getNext below</div>
<div>3932&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     * to move forward.</div>
<div>3933&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                     */</div>
<div style="background-color:limegreen;">3934&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    if (result != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">3935&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                        if (!withCursor.withCursor(cursor, key, data)) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3936&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            done = true;</div>
<div>3937&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</div>
<div>3938&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</div>
<div>3939&emsp;&emsp;</div>
<div style="background-color:limegreen;">3940&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                    if (!done) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3941&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        result = cursor.getNext(</div>
<div>3942&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            key, data, lockType, false /*dirtyReadAll*/,</div>
<div>3943&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            true /*forward*/, false /*isLatched*/,</div>
<div>3944&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            null /*rangeConstraint*/);</div>
<div>3945&emsp;&emsp;</div>
<div style="background-color:limegreen;">3946&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>                        if (result == null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3947&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            done = true;</div>
<div>3948&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</div>
<div>3949&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</div>
<div>3950&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</div>
<div>3951&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3952&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } finally {</div>
<div style="background-color:limegreen;">3953&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (cursor != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3954&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                cursor.releaseBIN();</div>
<div>3955&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                cursor.close();</div>
<div>3956&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div style="background-color:limegreen;">3957&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (locker != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY] & [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3958&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                locker.operationEnd();</div>
<div>3959&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>3960&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3961&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3962&emsp;&emsp;</div>
<div>3963&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3964&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Dump the cursor for debugging purposes.  Dump the bin that the cursor</div>
<div>3965&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * refers to if verbose is true.</div>
<div>3966&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3967&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void dump(boolean verbose) {</div>
<div>3968&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        System.out.println(dumpToString(verbose));</div>
<div>3969&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3970&emsp;&emsp;</div>
<div>3971&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>3972&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * dump the cursor for debugging purposes.</div>
<div>3973&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3974&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void dump() {</div>
<div>3975&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        System.out.println(dumpToString(true));</div>
<div>3976&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3977&emsp;&emsp;</div>
<div>3978&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /*</div>
<div>3979&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * dumper</div>
<div>3980&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3981&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private String statusToString(byte status) {</div>
<div style="background-color:limegreen;">3982&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        switch(status) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>3983&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        case CURSOR_NOT_INITIALIZED:</div>
<div>3984&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return "CURSOR_NOT_INITIALIZED";</div>
<div>3985&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        case CURSOR_INITIALIZED:</div>
<div>3986&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return "CURSOR_INITIALIZED";</div>
<div>3987&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        case CURSOR_CLOSED:</div>
<div>3988&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return "CURSOR_CLOSED";</div>
<div>3989&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        default:</div>
<div>3990&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return "UNKNOWN (" + Byte.toString(status) + ")";</div>
<div>3991&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>3992&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>3993&emsp;&emsp;</div>
<div>3994&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /*</div>
<div>3995&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * dumper</div>
<div>3996&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>3997&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public String dumpToString(boolean verbose) {</div>
<div>3998&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        StringBuilder sb = new StringBuilder();</div>
<div>3999&emsp;&emsp;</div>
<div>4000&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        sb.append("&#60;Cursor idx=\"").append(index).append("\"");</div>
<div>4001&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        sb.append(" status=\"").append(statusToString(status)).append("\"");</div>
<div>4002&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        sb.append(">\n");</div>
<div style="background-color:limegreen;">4003&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (verbose) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">4004&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            sb.append((bin == null) ? "" : bin.dumpString(2, true));&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>4005&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>4006&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        sb.append("\n&#60;/Cursor>");</div>
<div>4007&emsp;&emsp;</div>
<div>4008&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return sb.toString();</div>
<div>4009&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>4010&emsp;&emsp;</div>
<div>4011&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /*</div>
<div>4012&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * For unit tests</div>
<div>4013&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>4014&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public StatGroup getLockStats() {</div>
<div>4015&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return locker.collectStats();</div>
<div>4016&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>4017&emsp;&emsp;</div>
<div>4018&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>4019&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Send trace messages to the java.util.logger. Don't rely on the logger</div>
<div>4020&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * alone to conditionalize whether we send this message, we don't even want</div>
<div>4021&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * to construct the message if the level is not enabled.</div>
<div>4022&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>4023&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void trace(</div>
<div>4024&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        Level level,</div>
<div>4025&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        String changeType,</div>
<div>4026&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        BIN theBin,</div>
<div>4027&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        int lnIndex,</div>
<div>4028&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        long oldLsn,</div>
<div>4029&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        long newLsn) {</div>
<div>4030&emsp;&emsp;</div>
<div>4031&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        EnvironmentImpl envImpl = dbImpl.getEnv();</div>
<div style="background-color:limegreen;">4032&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (envImpl.getLogger().isLoggable(level)) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>4033&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            StringBuilder sb = new StringBuilder();</div>
<div>4034&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(changeType);</div>
<div>4035&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(" bin=");</div>
<div>4036&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(theBin.getNodeId());</div>
<div>4037&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(" lnIdx=");</div>
<div>4038&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(lnIndex);</div>
<div>4039&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(" oldLnLsn=");</div>
<div>4040&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(DbLsn.getNoFormatString(oldLsn));</div>
<div>4041&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(" newLnLsn=");</div>
<div>4042&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(DbLsn.getNoFormatString(newLsn));</div>
<div>4043&emsp;&emsp;</div>
<div>4044&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            LoggerUtils.logMsg</div>
<div>4045&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                (envImpl.getLogger(), envImpl, level, sb.toString());</div>
<div>4046&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>4047&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>4048&emsp;&emsp;</div>
<div>4049&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /**</div>
<div>4050&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * Send trace messages to the java.util.logger. Don't rely on the logger</div>
<div>4051&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * alone to conditionalize whether we send this message, we don't even want</div>
<div>4052&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     * to construct the message if the level is not enabled.</div>
<div>4053&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     */</div>
<div>4054&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private void traceInsert(</div>
<div>4055&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        Level level,</div>
<div>4056&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        BIN insertingBin,</div>
<div>4057&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        long lnLsn,</div>
<div>4058&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        int index) {</div>
<div>4059&emsp;&emsp;</div>
<div>4060&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        EnvironmentImpl envImpl = dbImpl.getEnv();</div>
<div style="background-color:limegreen;">4061&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (envImpl.getLogger().isLoggable(level)) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>4062&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            StringBuilder sb = new StringBuilder();</div>
<div>4063&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(TRACE_INSERT);</div>
<div>4064&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(" bin=");</div>
<div>4065&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(insertingBin.getNodeId());</div>
<div>4066&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(" lnLsn=");</div>
<div>4067&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(DbLsn.getNoFormatString(lnLsn));</div>
<div>4068&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(" index=");</div>
<div>4069&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            sb.append(index);</div>
<div>4070&emsp;&emsp;</div>
<div>4071&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            LoggerUtils.logMsg(envImpl.getLogger(), envImpl, level,</div>
<div>4072&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                               sb.toString());</div>
<div>4073&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>4074&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>4075&emsp;&emsp;</div>
<div>4076&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /* For unit testing only. */</div>
<div>4077&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    public void setTestHook(TestHook hook) {</div>
<div>4078&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        testHook = hook;</div>
<div>4079&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>4080&emsp;&emsp;</div>
<div>4081&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    /* Check that the target bin is latched. For use in assertions. */</div>
<div>4082&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    private boolean checkAlreadyLatched(boolean isLatched) {</div>
<div style="background-color:limegreen;">4083&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>        if (isLatched) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div style="background-color:limegreen;">4084&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>            if (bin != null) {&nbsp;&#8594; [ALLOWCREATE, TRANSACTIONAL, READONLY]</b></div>
<div>4085&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return bin.isLatchExclusiveOwner();</div>
<div>4086&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</div>
<div>4087&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</div>
<div>4088&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return true;</div>
<div>4089&emsp;&emsp;&nbsp;&nbsp;&nbsp;&nbsp;    }</div>
<div>4090&emsp;&emsp;}</div>
</div>
</div>
</body>
</html>